{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
    <div class="card shadow-lg border-0">
        <div class="card-body p-md-5 text-center">

            <!-- إزالة الواجهة الأولية وإظهار الماسح مباشرة -->
            <div id="scanner-view">
                <div id="reader-container" class="mx-auto mb-3">
                    <div id="reader"></div>
                    <div class="scanner-overlay">
                        <div class="scanner-line"></div>
                    </div>
                </div>
                <div id="scan-status" class="alert alert-info mt-3">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    <span>جاري تشغيل الكاميرا...</span>
                </div>
                <button id="stopButton" class="btn btn-outline-danger mt-3">
                    <i class="fas fa-times me-2"></i>إلغاء المسح
                </button>
            </div>

        </div>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
    .card {
        border-radius: 15px;
        transition: all 0.3s ease-in-out;
    }
    #reader-container {
        position: relative;
        max-width: 500px;
        overflow: hidden;
        border-radius: 10px;
        border: 2px solid #eee;
    }
    #reader {
        width: 100%;
    }
    .scanner-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(to bottom, rgba(0, 0, 0, 0.2), transparent, rgba(0, 0, 0, 0.2));
        pointer-events: none;
    }
    .scanner-overlay::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        height: 60%;
        border: 3px solid rgba(255, 255, 255, 0.7);
        border-radius: 10px;
        box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.3);
    }
    .scanner-line {
        position: absolute;
        top: 20%;
        left: 10%;
        width: 80%;
        height: 3px;
        background: #0d6efd;
        box-shadow: 0 0 10px #0d6efd;
        animation: scan 3s linear infinite;
        border-radius: 3px;
    }
    @keyframes scan {
        0% { top: 20%; }
        50% { top: 80%; }
        100% { top: 20%; }
    }
</style>

<script>
class ModernBarcodeScanner {
    constructor() {
        this.elements = {
            scannerView: document.getElementById('scanner-view'),
            stopButton: document.getElementById('stopButton'),
            readerDiv: document.getElementById('reader'),
            statusDiv: document.getElementById('scan-status'),
            statusText: document.querySelector('#scan-status span')
        };
        
        this.scanner = new Html5Qrcode(this.elements.readerDiv.id);
        this.isScanning = false;
        
        this.bindEvents();
        // بدء المسح تلقائياً عند إنشاء الكائن
        this.start();
    }

    bindEvents() {
        this.elements.stopButton.addEventListener('click', () => this.stop());
    }

    updateStatus(message, type = 'info', showSpinner = true) {
        this.elements.statusDiv.className = `alert alert-${type} mt-3`;
        const iconClass = showSpinner ? 'fas fa-spinner fa-spin' : this.getIconForType(type);
        this.elements.statusDiv.innerHTML = `<i class="${iconClass} me-2"></i><span>${message}</span>`;
    }

    getIconForType(type) {
        switch(type) {
            case 'success': return 'fas fa-check-circle';
            case 'danger': return 'fas fa-times-circle';
            case 'warning': return 'fas fa-exclamation-triangle';
            default: return 'fas fa-info-circle';
        }
    }

    async start() {
        this.updateStatus('جاري طلب صلاحيات الكاميرا...', 'info', true);

        try {
            await this.scanner.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: (viewfinderWidth, viewfinderHeight) => {
                        const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                        const qrboxSize = Math.floor(minEdge * 0.7);
                        return { width: qrboxSize, height: qrboxSize };
                    }
                },
                (decodedText, decodedResult) => this.onScanSuccess(decodedText),
                (errorMessage) => { /* تجاهل أخطاء عدم العثور على كود */ }
            );
            this.isScanning = true;
            this.updateStatus('وجه الكاميرا نحو باركود الطلب', 'info', false);
        } catch (error) {
            this.handleScanError(error);
        }
    }

    async stop() {
        if (this.isScanning) {
            try {
                await this.scanner.stop();
                this.isScanning = false;
            } catch (err) {
                console.error("Error stopping the scanner:", err);
            }
        }
        // العودة للصفحة السابقة
        window.history.back();
    }

    onScanSuccess(code) {
        if (!this.isScanning) return;
        
        this.isScanning = false; 
        
        this.updateStatus(`تم العثور على الكود: <strong>${code}</strong>. جاري التوجيه...`, 'success', true);
        
        setTimeout(() => this.scanner.stop(), 500);
        this.processScannedCode(code);
    }

    handleScanError(error) {
        let message = 'حدث خطأ غير متوقع أثناء تشغيل الكاميرا.';
        if (typeof error === 'string') {
            if (error.includes('Permission denied') || error.includes('NotAllowedError')) {
                message = 'تم رفض الوصول للكاميرا. يرجى تفعيلها من إعدادات المتصفح.';
            } else if (error.includes('NotFoundError') || error.includes('OverconstrainedError')) {
                message = 'لم يتم العثور على كاميرا خلفية مناسبة.';
            }
        }
        this.updateStatus(message, 'danger', false);
        // إعادة المحاولة بعد 3 ثواني
        setTimeout(() => {
            this.updateStatus('جاري إعادة المحاولة...', 'info', true);
            this.start();
        }, 3000);
    }

    processScannedCode(code) {
        setTimeout(() => {
            const cleanCode = code.split('.')[0];
            let orderId = '';

            if (cleanCode.startsWith('order_')) {
                orderId = cleanCode.replace('order_', '');
            } else if (/^\d+$/.test(cleanCode)) {
                orderId = cleanCode;
            }

            if (orderId) {
                window.location.href = `/${orderId}`;
            } else {
                this.updateStatus('باركود الطلب غير معروف أو بصيغة غير صحيحة.', 'warning', false);
                // إعادة تشغيل الماسح بعد 3 ثواني
                setTimeout(() => {
                    this.isScanning = true;
                    this.start();
                }, 3000);
            }
        }, 2000);
    }
}

// بدء المسح تلقائياً عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', () => {
    new ModernBarcodeScanner();
});
</script>
{% endblock %}