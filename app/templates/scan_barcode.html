{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
            <h3><i class="fas fa-camera me-2"></i>مسح باركود/QR كود الطلب/المنتج</h3>
        </div>
        <div class="card-body text-center">
            <button id="startScanner" class="btn btn-lg btn-success mb-4">
                <i class="fas fa-camera me-2"></i>بدء المسح
            </button>

            <div id="scanner-container" style="position: relative; max-width: 500px; margin: 0 auto; display: none;">
                <video id="scanner-video" width="100%" playsinline style="border: 2px solid #007bff; border-radius: 8px;"></video>
                <canvas id="scanner-canvas" style="position: absolute; top: 0; left: 0;"></canvas>
                <div id="scan-result" class="mt-3 alert" style="display: none;"></div>
            </div>

            <div id="guidance-message" class="mt-3 text-muted">
                <small>توجيه الكاميرا نحو باركود أو QR كود الطلب أو المنتج</small>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<script>
class BarcodeScanner {
    constructor() {
        this.codeReader = new ZXing.BrowserMultiFormatReader();
        this.scannerContainer = document.getElementById('scanner-container');
        this.videoElement = document.getElementById('scanner-video');
        this.canvasElement = document.getElementById('scanner-canvas');
        this.resultDiv = document.getElementById('scan-result');
        this.startButton = document.getElementById('startScanner');
        this.guidanceMessage = document.getElementById('guidance-message');

        this.startButton.addEventListener('click', () => this.startScanning());
    }

    async startScanning() {
        this.startButton.style.display = 'none';
        this.scannerContainer.style.display = 'block';
        this.updateResult('جارِ بدء الكاميرا...', 'info');

        try {
            await this.codeReader.decodeFromVideoDevice(
                null,
                this.videoElement,
                (result, error) => {
                    if (this.canvasElement) {
                        this.drawBoundingBox(result);
                    }

                    if (result) {
                        this.handleScanSuccess(result.text);
                    }
                    if (error && !(error instanceof ZXing.NotFoundException)) {
                        this.handleScanError(error);
                    }
                }
            );
        } catch (error) {
            this.handleCameraError(error);
        }
    }

    drawBoundingBox(result) {
        const canvasContext = this.canvasElement.getContext('2d');
        this.canvasElement.width = this.videoElement.videoWidth;
        this.canvasElement.height = this.videoElement.videoHeight;

        canvasContext.clearRect(0, 0, this.canvasElement.width, this.canvasElement.height);

        if (result) {
            const points = result.getResultPoints();
            if (points.length > 0) {
                canvasContext.strokeStyle = '#28a745'; // لون أخضر
                canvasContext.lineWidth = 4;
                canvasContext.beginPath();

                // رسم خط بين كل نقطتين
                canvasContext.moveTo(points[0].getX(), points[0].getY());
                for (let i = 1; i < points.length; i++) {
                    canvasContext.lineTo(points[i].getX(), points[i].getY());
                }
                // إغلاق الشكل للعودة للنقطة الأولى
                canvasContext.lineTo(points[0].getX(), points[0].getY());
                canvasContext.stroke();
            }
        }
    }

    handleScanSuccess(code) {
        this.updateResult(`تم المسح بنجاح: <strong>${code}</strong>`, 'success');
        this.stopScanning();
        this.processScannedCode(code);
    }

    handleScanError(error) {
        console.error('خطأ في المسح:', error);
        this.updateResult(`
            <i class="fas fa-times-circle text-danger me-2"></i>
            خطأ في المسح: ${error.message}
        `, 'danger');
    }

    handleCameraError(error) {
        console.error("Camera Error:", error);
        let errorMessage = 'فشل في تشغيل الكاميرا.';
        if (error.name === 'NotAllowedError') {
            errorMessage = 'فشل في تشغيل الكاميرا. الرجاء منح الإذن لاستخدامها.';
        } else if (error.name === 'NotFoundError') {
            errorMessage = 'لم يتم العثور على كاميرا.';
        }
        this.updateResult(`
            <i class="fas fa-times-circle text-danger me-2"></i>
            ${errorMessage}
            <br><small>تأكد من استخدام HTTPS أو localhost.</small>
        `, 'danger');
        this.startButton.style.display = 'block';
    }

    stopScanning() {
        if (this.codeReader) {
            this.codeReader.reset();
        }
        this.startButton.style.display = 'block';
        this.scannerContainer.style.display = 'none';
        
        // مسح محتويات الكانفاس عند الإيقاف
        const canvasContext = this.canvasElement.getContext('2d');
        canvasContext.clearRect(0, 0, this.canvasElement.width, this.canvasElement.height);
    }

    updateResult(message, type) {
        this.resultDiv.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${message}`;
        this.resultDiv.className = `mt-3 alert alert-${type}`;
        this.resultDiv.style.display = 'block';
    }

    processScannedCode(code) {
        setTimeout(() => {
            const cleanCode = code.split('.')[0];
            let url = '';

            if (cleanCode.startsWith('order_')) {
                const orderId = cleanCode.replace('order_', '');
                url = `${orderId}`;
            } else if (cleanCode.startsWith('item_')) {
                const parts = cleanCode.replace('item_', '').split('-');
                if (parts.length >= 2) {
                    const orderId = parts[0];
                    const itemId = parts[1];
                    url = `${orderId}#item-${itemId}`;
                }
            } else if (/^\d+$/.test(cleanCode)) {
                url = `${cleanCode}`;
            }

            if (url) {
                window.location.href = `/${url}`;
            } else {
                this.updateResult('الكود الممسوح غير معروف أو بصيغة غير صحيحة.', 'warning');
                this.startButton.style.display = 'block';
            }
        }, 1000);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new BarcodeScanner();
});
</script>
{% endblock %}
