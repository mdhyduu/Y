{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
            <h3><i class="fas fa-camera me-2"></i>
            <h3>ماسح الباركود </h3>
        </div>
        <div class="card-body text-center">
            <button id="startScanner" class="btn btn-lg btn-success mb-4">
                <i class="fas fa-camera me-2"></i>بدء المسح
            </button>

            <div id="scanner-container" style="position: relative; max-width: 500px; margin: 0 auto; display: none;">
                <video id="scanner-video" width="100%" playsinline style="border: 2px solid #007bff; border-radius: 8px;"></video>
                <canvas id="scanner-canvas" style="position: absolute; top: 0; left: 0;"></canvas>
                <div id="scan-result" class="mt-3 alert" style="display: none;"></div>
            </div>

            <div id="guidance-message" class="mt-3 text-muted">
                <small>توجيه الكاميرا نحو باركود QR كود الطلب أو المنتج</small>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<script>
class BarcodeScanner {
    constructor() {
        this.scannerContainer = document.getElementById('scanner-container');
        this.videoElement = document.getElementById('scanner-video');
        this.canvasElement = document.getElementById('scanner-canvas');
        this.resultDiv = document.getElementById('scan-result');
        this.startButton = document.getElementById('startScanner');
        this.guidanceMessage = document.getElementById('guidance-message');

        this.startButton.addEventListener('click', () => this.startScanning());
        this.isScanning = false;
    }

    async startScanning() {
        this.startButton.style.display = 'none';
        this.scannerContainer.style.display = 'block';
        this.updateResult('جارِ بدء الكاميرا...', 'info');

        try {
            await this.initQuagga();
            this.isScanning = true;
        } catch (error) {
            this.handleCameraError(error);
        }
    }

    initQuagga() {
        return new Promise((resolve, reject) => {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: this.videoElement,
                    constraints: {
                        facingMode: "environment",
                        width: { min: 640 },
                        height: { min: 480 }
                    },
                },
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader",
                        "code_39_vin_reader",
                        "codabar_reader",
                        "upc_reader",
                        "upc_e_reader",
                        "i2of5_reader",
                        "qrcode_reader" // إضافة قارئ QR code
                    ],
                    debug: {
                        drawBoundingBox: true,
                        showFrequency: false,
                        drawScanline: true,
                        showPattern: false
                    }
                },
                locate: true,
                frequency: 10
            }, function(err) {
                if (err) {
                    reject(err);
                    return;
                }
                Quagga.start();
                resolve();
            });

            Quagga.onDetected((result) => {
                if (!this.isScanning) return;
                
                const code = result.codeResult.code;
                this.drawBoundingBox(result);
                this.handleScanSuccess(code);
            });

            Quagga.onProcessed((result) => {
                if (!result) return;
                
                const canvasContext = this.canvasElement.getContext('2d');
                this.canvasElement.width = result.frame.width;
                this.canvasElement.height = result.frame.height;
                
                if (result.boxes) {
                    canvasContext.clearRect(0, 0, this.canvasElement.width, this.canvasElement.height);
                    canvasContext.strokeStyle = '#28a745';
                    canvasContext.lineWidth = 4;
                    
                    result.boxes.filter(box => box !== result.box).forEach(box => {
                        canvasContext.beginPath();
                        canvasContext.moveTo(box[0][0], box[0][1]);
                        for (let i = 1; i < box.length; i++) {
                            canvasContext.lineTo(box[i][0], box[i][1]);
                        }
                        canvasContext.lineTo(box[0][0], box[0][1]);
                        canvasContext.stroke();
                    });
                }
            });
        }.bind(this));
    }

    drawBoundingBox(result) {
        if (!result || !result.boxes) return;
        
        const canvasContext = this.canvasElement.getContext('2d');
        canvasContext.clearRect(0, 0, this.canvasElement.width, this.canvasElement.height);
        canvasContext.strokeStyle = '#28a745';
        canvasContext.lineWidth = 4;
        
        result.boxes.forEach(box => {
            canvasContext.beginPath();
            canvasContext.moveTo(box[0][0], box[0][1]);
            for (let i = 1; i < box.length; i++) {
                canvasContext.lineTo(box[i][0], box[i][1]);
            }
            canvasContext.lineTo(box[0][0], box[0][1]);
            canvasContext.stroke();
        });
    }

    handleScanSuccess(code) {
        this.updateResult(`تم المسح بنجاح: <strong>${code}</strong>`, 'success');
        this.stopScanning();
        this.processScannedCode(code);
    }

    handleScanError(error) {
        console.error('خطأ في المسح:', error);
        this.updateResult(`
            <i class="fas fa-times-circle text-danger me-2"></i>
            خطأ في المسح: ${error.message}
        `, 'danger');
    }

    handleCameraError(error) {
        console.error("Camera Error:", error);
        let errorMessage = 'فشل في تشغيل الكاميرا.';
        if (error.name === 'NotAllowedError') {
            errorMessage = 'فشل في تشغيل الكاميرا. الرجاء منح الإذن لاستخدامها.';
        } else if (error.name === 'NotFoundError') {
            errorMessage = 'لم يتم العثور على كاميرا.';
        }
        this.updateResult(`
            <i class="fas fa-times-circle text-danger me-2"></i>
            ${errorMessage}
            <br><small>تأكد من استخدام HTTPS أو localhost.</small>
        `, 'danger');
        this.startButton.style.display = 'block';
    }

    stopScanning() {
        if (this.isScanning) {
            Quagga.stop();
            this.isScanning = false;
        }
        this.startButton.style.display = 'block';
        this.scannerContainer.style.display = 'none';
        
        const canvasContext = this.canvasElement.getContext('2d');
        canvasContext.clearRect(0, 0, this.canvasElement.width, this.canvasElement.height);
    }

    updateResult(message, type) {
        this.resultDiv.innerHTML = message;
        this.resultDiv.className = `mt-3 alert alert-${type}`;
        this.resultDiv.style.display = 'block';
    }

    processScannedCode(code) {
        setTimeout(() => {
            const cleanCode = code.split('.')[0];
            let url = '';

            if (cleanCode.startsWith('order_')) {
                const orderId = cleanCode.replace('order_', '');
                url = `${orderId}`;
            } else if (cleanCode.startsWith('item_')) {
                const parts = cleanCode.replace('item_', '').split('-');
                if (parts.length >= 2) {
                    const orderId = parts[0];
                    const itemId = parts[1];
                    url = `${orderId}#item-${itemId}`;
                }
            } else if (/^\d+$/.test(cleanCode)) {
                url = `${cleanCode}`;
            }

            if (url) {
                window.location.href = `/${url}`;
            } else {
                this.updateResult('الكود الممسوح غير معروف أو بصيغة غير صحيحة.', 'warning');
                this.startButton.style.display = 'block';
            }
        }, 1000);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new BarcodeScanner();
});
</script>
{% endblock %}