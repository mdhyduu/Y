{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
            <h3><i class="fas fa-camera me-2"></i>مسح باركود/QR كود الطلب/المنتج</h3>
        </div>
        <div class="card-body text-center">
            <button id="startScanner" class="btn btn-lg btn-success mb-4">
                <i class="fas fa-camera me-2"></i>بدء المسح
            </button>

            <div id="scanner-container" style="position: relative; max-width: 500px; margin: 0 auto; display: none;">
                <div id="interactive" class="viewport"></div>
                <canvas id="scanner-canvas" style="position: absolute; top: 0; left: 0;"></canvas>
                <div id="scan-result" class="mt-3 alert" style="display: none;"></div>
            </div>

            <div id="guidance-message" class="mt-3 text-muted">
                <small>توجيه الكاميرا نحو باركود أو QR كود الطلب أو المنتج</small>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<style>
    #interactive {
        width: 100%;
        height: auto;
        border: 2px solid #007bff;
        border-radius: 8px;
    }
</style>

<script>
class BarcodeScanner {
    constructor() {
        this.scannerContainer = document.getElementById('scanner-container');
        this.interactiveElement = document.getElementById('interactive');
        this.canvasElement = document.getElementById('scanner-canvas');
        this.resultDiv = document.getElementById('scan-result');
        this.startButton = document.getElementById('startScanner');
        this.guidanceMessage = document.getElementById('guidance-message');
        this.isScanning = false;

        this.startButton.addEventListener('click', () => this.startScanning());
    }

    async startScanning() {
        if (this.isScanning) return;
        
        this.startButton.disabled = true;
        this.startButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري التهيئة...';
        this.scannerContainer.style.display = 'block';
        this.updateResult('جارِ بدء الكاميرا...', 'info');

        try {
            await this.initQuagga();
            this.isScanning = true;
            this.startButton.style.display = 'none';
            this.updateResult('جاهز للمسح. توجيه الكاميرا نحو الباركود...', 'info');
        } catch (error) {
            console.error("Error initializing scanner:", error);
            this.handleCameraError(error);
            this.resetScannerButton();
        }
    }

    initQuagga() {
        return new Promise((resolve, reject) => {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: this.interactiveElement,
                    constraints: {
                        facingMode: "environment",
                        width: { min: 640 },
                        height: { min: 480 }
                    },
                },
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader",
                        "code_39_vin_reader",
                        "codabar_reader",
                        "upc_reader",
                        "upc_e_reader",
                        "i2of5_reader",
                        "qrcode_reader"
                    ]
                },
                locate: true,
                frequency: 10
            }, (err) => {
                if (err) {
                    reject(err);
                    return;
                }
                Quagga.start();
                resolve();
            });

            Quagga.onDetected((result) => {
                if (!this.isScanning) return;
                
                const code = result.codeResult.code;
                this.handleScanSuccess(code);
            });
        });
    }

    handleScanSuccess(code) {
        this.updateResult(`تم المسح بنجاح: <strong>${code}</strong>`, 'success');
        this.stopScanning();
        this.processScannedCode(code);
    }

    handleCameraError(error) {
        let errorMessage = 'فشل في تشغيل الكاميرا.';
        if (error.name === 'NotAllowedError') {
            errorMessage = 'فشل في تشغيل الكاميرا. الرجاء منح الإذن لاستخدامها.';
        } else if (error.name === 'NotFoundError') {
            errorMessage = 'لم يتم العثور على كاميرا.';
        } else if (error.message.includes('Permission denied')) {
            errorMessage = 'تم رفض الإذن باستخدام الكاميرا.';
        }
        this.updateResult(`
            <i class="fas fa-times-circle text-danger me-2"></i>
            ${errorMessage}
            <br><small>تأكد من استخدام HTTPS أو localhost.</small>
        `, 'danger');
    }

    stopScanning() {
        if (this.isScanning) {
            Quagga.stop();
            this.isScanning = false;
        }
        this.resetScannerButton();
        this.scannerContainer.style.display = 'none';
    }

    resetScannerButton() {
        this.startButton.style.display = 'block';
        this.startButton.disabled = false;
        this.startButton.innerHTML = '<i class="fas fa-camera me-2"></i>بدء المسح';
    }

    updateResult(message, type) {
        this.resultDiv.innerHTML = message;
        this.resultDiv.className = `mt-3 alert alert-${type}`;
        this.resultDiv.style.display = 'block';
    }

    processScannedCode(code) {
        setTimeout(() => {
            const cleanCode = code.split('.')[0];
            let url = '';

            if (cleanCode.startsWith('order_')) {
                const orderId = cleanCode.replace('order_', '');
                url = `${orderId}`;
            } else if (cleanCode.startsWith('item_')) {
                const parts = cleanCode.replace('item_', '').split('-');
                if (parts.length >= 2) {
                    const orderId = parts[0];
                    const itemId = parts[1];
                    url = `${orderId}#item-${itemId}`;
                }
            } else if (/^\d+$/.test(cleanCode)) {
                url = `${cleanCode}`;
            }

            if (url) {
                window.location.href = `/${url}`;
            } else {
                this.updateResult('الكود الممسوح غير معروف أو بصيغة غير صحيحة.', 'warning');
                this.resetScannerButton();
            }
        }, 1000);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new BarcodeScanner();
});
</script>
{% endblock %}