{% extends 'base.html' %}

{% block title %}نظام إدارة التوصيل - لوحة المدير{% endblock %}

{% block content %}
<div class="content-container p-4">
    <!-- البطاقات والإحصائيات -->
    <div class="d-grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
        <div class="card stat-card d-flex flex-row align-items-center p-3">
            <div class="stat-icon bg-primary text-white d-flex align-items-center justify-content-center rounded me-3" style="width: 50px; height: 50px;">
                <i class="fas fa-shopping-bag"></i>
            </div>
            <div class="stat-info">
                <h4 class="mb-1">{{ total_orders }}</h4>
                <p class="mb-1 text-secondary">إجمالي الطلبات</p>
                <div class="stat-trend text-success small">
                    <i class="fas fa-arrow-up"></i> {{ order_trend }}% زيادة عن الشهر الماضي
                </div>
            </div>
        </div>
        
        <div class="card stat-card d-flex flex-row align-items-center p-3">
            <div class="stat-icon bg-success text-white d-flex align-items-center justify-content-center rounded me-3" style="width: 50px; height: 50px;">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
                <h4 class="mb-1">{{ completed_count }}</h4>
                <p class="mb-1 text-secondary">طلبات تم التنفيذ</p>
                <div class="stat-trend text-success small">
                    <i class="fas fa-arrow-up"></i> {{ completed_trend }}% زيادة عن الأسبوع الماضي
                </div>
            </div>
        </div>
        
        <div class="card stat-card d-flex flex-row align-items-center p-3">
            <div class="stat-icon bg-warning text-white d-flex align-items-center justify-content-center rounded me-3" style="width: 50px; height: 50px;">
                <i class="fas fa-motorcycle"></i>
            </div>
            <div class="stat-info">
                <h4 class="mb-1">{{ active_employees_count }}</h4>
                <p class="mb-1 text-secondary">مناديب نشطين</p>
                <div class="stat-trend text-danger small">
                    <i class="fas fa-arrow-down"></i> 
                    {% set inactive_count = delivery_employees|length - active_employees_count %}
                    {{ inactive_count }} خارج الخدمة
                </div>
            </div>
        </div>
        
        <div class="card stat-card d-flex flex-row align-items-center p-3">
            <div class="stat-icon bg-danger text-white d-flex align-items-center justify-content-center rounded me-3" style="width: 50px; height: 50px;">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
                <h4 class="mb-1">{{ in_progress_count }}</h4>
                <p class="mb-1 text-secondary">طلبات قيد التنفيذ</p>
                <div class="stat-trend text-success small">
                    <i class="fas fa-arrow-up"></i> {{ new_orders_today }} طلبات جديدة
                </div>
            </div>
        </div>
    </div>

    <!-- محتوى اللوحة -->
    <div class="content">
        <!-- قسم مناديب التوصيل -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-motorcycle me-2"></i> مناديب التوصيل</h5>
                {% if is_delivery_manager %}
                <a href="{{ url_for('delivery.manage_delivery_employees') }}">
                    <button class="btn btn-primary btn-sm"><i class="fas fa-plus me-1"></i> إضافة مندوب جديد</button>
                </a>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>اسم المندوب</th>
                                <th>الهاتف</th>
                                <th>المنطقة</th>
                                <th>الحالة</th>
                                <th>الطلبات النشطة</th>
                                {% if is_delivery_manager %}
                                <th>الإجراءات</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for emp in delivery_employees %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="https://ui-avatars.com/api/?name={{ emp.name }}&background=10AC84&color=fff" width="35" height="35" class="rounded-circle me-2">
                                        {{ emp.email }}
                                    </div>
                                </td>
                                <td>{{ emp.phone or 'غير متوفر' }}</td>
                                <td>{{ emp.region or 'غير محدد' }}</td>
                                <td>
                                    {% if emp.is_active %}
                                    <span class="badge bg-success">نشط</span>
                                    {% else %}
                                    <span class="badge bg-danger">غير نشط</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% set active_orders_count = emp.assignments|length %}
                                    <span class="badge bg-primary">{{ active_orders_count }} طلبات</span>
                                </td>
                                {% if is_delivery_manager %}
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1"><i class="fas fa-eye"></i></button>
                                    <button class="btn btn-sm btn-outline-secondary me-1"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- قسم طلبات التوصيل -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <h5 class="mb-0 me-3"><i class="fas fa-shopping-bag me-2"></i> طلبات التوصيل النشطة</h5>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="selectAllCheckbox">
                        <label class="form-check-label small" for="selectAllCheckbox">تحديد الكل</label>
                    </div>
                </div>
                <div>
                    <button id="assignMultipleBtn" class="btn btn-warning btn-sm me-2" style="display: none;" data-bs-toggle="modal" data-bs-target="#assignMultipleModal">
                        <i class="fas fa-user-plus me-1"></i> إسناد المحدد
                    </button>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#filterOrdersModal">
                        <i class="fas fa-filter me-1"></i> تصفية
                    </button>
                </div>
            </div>
            <div class="card-body">
               <ul class="nav nav-tabs mb-3" role="tablist" id="orders-tabs">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link {% if not selected_status_id %}active{% endif %}" 
                           href="#" data-status-id="">
                            جميع الطلبات <span class="badge bg-secondary ms-1">{{ total_orders }}</span>
                        </a>
                    </li>
                    {% for status in default_status_stats %}
                    <li class="nav-item" role="presentation">
                        <a class="nav-link {% if selected_status_id == status.id %}active{% endif %}" 
                           href="#" data-status-id="{{ status.id }}">
                            {{ status.name }} <span class="badge bg-secondary ms-1">{{ status.count }}</span>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
                <!-- حاوية الطلبات التي سيتم تحديثها عبر AJAX -->
                <div id="orders-container">
                    {% include 'orders_partial.html' %}
                </div>
            </div>
        </div>

        <!-- قسم الخريطة -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-map me-2"></i> خريطة التوصيل</h5>
            </div>
            <div class="card-body">
                <div id="delivery-map" style="height: 400px; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                    <div class="text-center text-muted">
                        <i class="fas fa-map-marked-alt fa-3x mb-3"></i>
                        <p>خريطة التوصيل ستظهر هنا</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- مودال إسناد طلب واحد -->
<div class="modal fade" id="assignOrderModal" tabindex="-1" aria-labelledby="assignOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignOrderModalLabel">إسناد الطلب</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="assignModalContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">جاري التحميل...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- مودال إسناد متعدد الطلبات -->
<div class="modal fade" id="assignMultipleModal" tabindex="-1" aria-labelledby="assignMultipleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignMultipleModalLabel">إسناد الطلبات المحددة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="assignMultipleModalContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">جاري التحميل...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// دالة للحصول على CSRF token
// دالة للحصول على CSRF token
function getCSRFToken() {
    const csrfToken = document.querySelector('meta[name="csrf-token"]');
    return csrfToken ? csrfToken.getAttribute('content') : '';
}

// إدارة اختيار الطلبات
function initOrderSelection() {
    const assignMultipleBtn = document.getElementById('assignMultipleBtn');
    const checkboxes = document.querySelectorAll('.order-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    
    // إظهار/إخفاء زر الإسناد المتعدد بناءً على عدد الطلبات المحددة
    function updateAssignButton() {
        const selectedCount = document.querySelectorAll('.order-checkbox:checked').length;
        if (selectedCount > 0) {
            assignMultipleBtn.style.display = 'block';
            assignMultipleBtn.innerHTML = `<i class="fas fa-user-plus me-1"></i> إسناد المحدد (${selectedCount})`;
        } else {
            assignMultipleBtn.style.display = 'none';
        }
        
        // تحديث حالة زر تحديد الكل
        if (selectAllCheckbox) {
            const totalCheckboxes = document.querySelectorAll('.order-checkbox').length;
            selectAllCheckbox.checked = selectedCount > 0 && selectedCount === totalCheckboxes;
            selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < totalCheckboxes;
        }
    }
    
    // إضافة مستمعي الأحداث لخانات الاختيار
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateAssignButton);
    });
    
    // حدث تحديد/إلغاء تحديد الكل
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.order-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateAssignButton();
        });
    }
    
    // تحديث حالة الزر عند التحميل الأولي
    updateAssignButton();
}

// التعامل مع أزرار الإسناد باستخدام event delegation
function initAssignButtons() {
    // استخدام event delegation للتعامل مع الأزرار التي يتم تحميلها ديناميكياً
    document.addEventListener('click', function(e) {
        // التعامل مع أزرار الإسناد
        if (e.target.closest('.assign-btn')) {
            const button = e.target.closest('.assign-btn');
            const orderId = button.getAttribute('data-order-id');
            
            fetch('/delivery/assign_order_modal/' + orderId)
                .then(response => response.text())
                .then(html => {
                    document.getElementById('assignModalContent').innerHTML = html;
                    // فتح المودال بعد تحميل المحتوى
                    const modal = new bootstrap.Modal(document.getElementById('assignOrderModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('assignModalContent').innerHTML = 
                        '<div class="alert alert-danger">حدث خطأ أثناء تحميل المحتوى</div>';
                });
        }
        
        // التعامل مع أزرار التسليم
        if (e.target.closest('.delivery-action-btn')) {
            const button = e.target.closest('.delivery-action-btn');
            const orderId = button.getAttribute('data-order-id');
            const action = button.getAttribute('data-action');
            
            if (action === 'deliver') {
                if (confirm('هل تريد تأكيد تسليم هذا الطلب؟')) {
                    fetch('/delivery/mark_delivered/' + orderId, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCSRFToken()
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('فشل في تأكيد التسليم: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('حدث خطأ أثناء تأكيد التسليم');
                    });
                }
            }
        }
    });
}

// التعامل مع تبويبات التصفية
function initOrderTabs() {
    const ordersTabs = document.getElementById('orders-tabs');
    if (ordersTabs) {
        // استخدام event delegation للتبويبات
        ordersTabs.addEventListener('click', function(e) {
            e.preventDefault();
            const target = e.target.closest('a');
            if (!target) return;
            
            // إزالة النشاط من جميع التبويبات
            document.querySelectorAll('#orders-tabs a').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // إضافة النشاط للتبويب المختار
            target.classList.add('active');
            
            // الحصول على معرف الحالة المحددة
            const statusId = target.getAttribute('data-status-id');
            
            // إظهار مؤشر التحميل
            const ordersContainer = document.getElementById('orders-container');
            ordersContainer.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">جاري التحميل...</span>
                    </div>
                    <p class="text-muted mt-2">جاري تحميل الطلبات...</p>
                </div>
            `;
            
            // إرسال طلب AJAX لجلب الطلبات المصفاة
            fetch(`/dashboard/filter_orders?status_id=${statusId}`)
                .then(response => response.text())
                .then(html => {
                    ordersContainer.innerHTML = html;
                    // لا حاجة لاستدعاء initOrderSelection() و initAssignButtons() هنا
                    // لأننا نستخدم event delegation
                })
                .catch(error => {
                    console.error('Error:', error);
                    ordersContainer.innerHTML = `
                        <div class="alert alert-danger text-center">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            حدث خطأ أثناء تحميل الطلبات
                        </div>
                    `;
                });
        });
    }
}

// معالجة الإسناد المتعدد
function initBulkAssignment() {
    const assignMultipleBtn = document.getElementById('assignMultipleBtn');
    if (assignMultipleBtn) {
        assignMultipleBtn.addEventListener('click', function() {
            const selectedOrders = Array.from(document.querySelectorAll('.order-checkbox:checked'))
                .map(checkbox => checkbox.getAttribute('data-order-id'));
            
            if (selectedOrders.length === 0) {
                alert('يرجى تحديد طلبات للإسناد');
                return;
            }
            
            // تحميل محتوى المودال الخاص بالإسناد المتعدد
            fetch('/delivery/assign_multiple_orders_modal', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ order_ids: selectedOrders })
            })
            .then(response => response.text())
            .then(html => {
                document.getElementById('assignMultipleModalContent').innerHTML = html;
                // فتح المودال بعد تحميل المحتوى
                const modal = new bootstrap.Modal(document.getElementById('assignMultipleModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('assignMultipleModalContent').innerHTML = 
                    '<div class="alert alert-danger">حدث خطأ أثناء تحميل المحتوى</div>';
            });
        });
    }
}

// تأثيرات الرسوم المتحركة
function initAnimations() {
    window.addEventListener('scroll', () => {
        const cards = document.querySelectorAll('.card');
        cards.forEach(card => {
            const cardPosition = card.getBoundingClientRect().top;
            const screenPosition = window.innerHeight / 1.3;
            if(cardPosition < screenPosition) {
                card.style.opacity = 1;
                card.style.transform = 'translateY(0)';
            }
        });
    });

    // تهيئة أولية للبطاقات
    document.querySelectorAll('.card').forEach(card => {
        card.style.opacity = 0;
        card.style.transform = 'translateY(20px)';
        card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
    });

    // تشغيل تأثير الظهور بعد تحميل الصفحة
    setTimeout(() => {
        document.querySelectorAll('.card').forEach((card, index) => {
            setTimeout(() => {
                card.style.opacity = 1;
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
    }, 500);
}

// إعادة تعيين المودال عند الإغلاق
function initModalReset() {
    const assignOrderModal = document.getElementById('assignOrderModal');
    if (assignOrderModal) {
        assignOrderModal.addEventListener('hidden.bs.modal', function () {
            document.getElementById('assignModalContent').innerHTML = 
                '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">جاري التحميل...</span></div></div>';
        });
    }
    
    const assignMultipleModal = document.getElementById('assignMultipleModal');
    if (assignMultipleModal) {
        assignMultipleModal.addEventListener('hidden.bs.modal', function () {
            document.getElementById('assignMultipleModalContent').innerHTML = 
                '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">جاري التحميل...</span></div></div>';
        });
    }
}

// التهيئة الرئيسية عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    initAnimations();
    initOrderSelection();
    initAssignButtons(); // هذا هو الأهم - event delegation
    initOrderTabs();
    initBulkAssignment();
    initModalReset();
    
    // جعل الدوال متاحة عالمياً لاستدعائها من الملفات الجزئية
    window.initOrderSelection = initOrderSelection;
});
</script>
{% endblock %}