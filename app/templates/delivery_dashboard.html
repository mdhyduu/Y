{% extends 'base.html' %}

{% block title %}نظام إدارة التوصيل - لوحة المدير{% endblock %}

{% block content %}
<div class="content-container p-4">
    <!-- البطاقات والإحصائيات -->
    <div class="d-grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
        <div class="card stat-card d-flex flex-row align-items-center p-3">
            <div class="stat-icon bg-primary text-white d-flex align-items-center justify-content-center rounded me-3" style="width: 50px; height: 50px;">
                <i class="fas fa-shopping-bag"></i>
            </div>
            <div class="stat-info">
                <h4 class="mb-1">{{ total_orders }}</h4>
                <p class="mb-1 text-secondary">إجمالي الطلبات</p>
                <div class="stat-trend text-success small">
                    <i class="fas fa-arrow-up"></i> {{ order_trend }}% زيادة عن الشهر الماضي
                </div>
            </div>
        </div>
        
        <div class="card stat-card d-flex flex-row align-items-center p-3">
            <div class="stat-icon bg-success text-white d-flex align-items-center justify-content-center rounded me-3" style="width: 50px; height: 50px;">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
                <h4 class="mb-1">{{ completed_count }}</h4>
                <p class="mb-1 text-secondary">طلبات تم التنفيذ</p>
                <div class="stat-trend text-success small">
                    <i class="fas fa-arrow-up"></i> {{ completed_trend }}% زيادة عن الأسبوع الماضي
                </div>
            </div>
        </div>
        
        <div class="card stat-card d-flex flex-row align-items-center p-3">
            <div class="stat-icon bg-warning text-white d-flex align-items-center justify-content-center rounded me-3" style="width: 50px; height: 50px;">
                <i class="fas fa-motorcycle"></i>
            </div>
            <div class="stat-info">
                <h4 class="mb-1">{{ active_employees_count }}</h4>
                <p class="mb-1 text-secondary">مناديب نشطين</p>
                <div class="stat-trend text-danger small">
                    <i class="fas fa-arrow-down"></i> 
                    {% set inactive_count = delivery_employees|length - active_employees_count %}
                    {{ inactive_count }} خارج الخدمة
                </div>
            </div>
        </div>
        
        <div class="card stat-card d-flex flex-row align-items-center p-3">
            <div class="stat-icon bg-danger text-white d-flex align-items-center justify-content-center rounded me-3" style="width: 50px; height: 50px;">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
                <h4 class="mb-1">{{ in_progress_count }}</h4>
                <p class="mb-1 text-secondary">طلبات قيد التنفيذ</p>
                <div class="stat-trend text-success small">
                    <i class="fas fa-arrow-up"></i> {{ new_orders_today }} طلبات جديدة
                </div>
            </div>
        </div>
    </div>

    <!-- محتوى اللوحة -->
    <div class="content">
        <!-- قسم مناديب التوصيل -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-motorcycle me-2"></i> مناديب التوصيل</h5>
                {% if is_delivery_manager %}
                <a href="{{ url_for('delivery.manage_delivery_employees') }}">
                    <button class="btn btn-primary btn-sm"><i class="fas fa-plus me-1"></i> إضافة مندوب جديد</button>
                </a>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>اسم المندوب</th>
                                <th>الهاتف</th>
                                <th>المنطقة</th>
                                <th>الحالة</th>
                                <th>الطلبات النشطة</th>
                                {% if is_delivery_manager %}
                                <th>الإجراءات</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for emp in delivery_employees %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="https://ui-avatars.com/api/?name={{ emp.name }}&background=10AC84&color=fff" width="35" height="35" class="rounded-circle me-2">
                                        {{ emp.email }}
                                    </div>
                                </td>
                                <td>{{ emp.phone or 'غير متوفر' }}</td>
                                <td>{{ emp.region or 'غير محدد' }}</td>
                                <td>
                                    {% if emp.is_active %}
                                    <span class="badge bg-success">نشط</span>
                                    {% else %}
                                    <span class="badge bg-danger">غير نشط</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% set active_orders_count = emp.assignments|length %}
                                    <span class="badge bg-primary">{{ active_orders_count }} طلبات</span>
                                </td>
                                {% if is_delivery_manager %}
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1"><i class="fas fa-eye"></i></button>
                                    <button class="btn btn-sm btn-outline-secondary me-1"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- قسم طلبات التوصيل -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-shopping-bag me-2"></i> طلبات التوصيل النشطة</h5>
                <div>
                    <button id="assignMultipleBtn" class="btn btn-warning btn-sm me-2" style="display: none;" data-bs-toggle="modal" data-bs-target="#assignMultipleModal">
                        <i class="fas fa-user-plus me-1"></i> إسناد المحدد
                    </button>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#filterOrdersModal">
                        <i class="fas fa-filter me-1"></i> تصفية
                    </button>
                </div>
            </div>
            <div class="card-body">
               <ul class="nav nav-tabs mb-3" role="tablist" id="orders-tabs">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link {% if not selected_status_id %}active{% endif %}" 
                           href="#" data-status-id="">
                            جميع الطلبات <span class="badge bg-secondary ms-1">{{ total_orders }}</span>
                        </a>
                    </li>
                    {% for status in default_status_stats %}
                    <li class="nav-item" role="presentation">
                        <a class="nav-link {% if selected_status_id == status.id %}active{% endif %}" 
                           href="#" data-status-id="{{ status.id }}">
                            {{ status.name }} <span class="badge bg-secondary ms-1">{{ status.count }}</span>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
                <!-- حاوية الطلبات التي سيتم تحديثها عبر AJAX -->
                <div id="orders-container">
                    <div class="row">
                        {% for order in filtered_orders %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div class="form-check">
                                        <input class="form-check-input order-checkbox" type="checkbox" data-order-id="{{ order.id }}">
                                        <strong>#{{ order.id}}</strong>
                                    </div>
                                    <div>
                                        {% if order.status %}
                                        <span class="badge me-2 bg-secondary">
                                            {{ order.status.name }}
                                        </span>
                                        {% endif %}
                                        <small class="text-muted"><i class="fas fa-clock me-1"></i> {{ order.created_at|time_ago }}</small>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <p class="card-text"><i class="fas fa-user me-2 text-muted"></i> {{ order.customer_name or 'غير معروف' }}</p>
                                    <p class="card-text"><i class="fas fa-phone me-2 text-muted"></i> {{ order.customer_phone or 'غير متوفر' }}</p>
                                    <p class="card-text"><i class="fas fa-map-marker-alt me-2 text-muted"></i> {{ order.customer_address or 'غير متوفر' }}</p>
                                    
                                    <!-- إظهار جميع الموظفين المسندين للطلب -->
                                    {% if order.assignments %}
                                        <div class="mt-3">
                                            <h6 class="text-muted mb-2">
                                                <i class="fas fa-user-tie me-1"></i>
                                                مسند إلى:
                                            </h6>
                                            <div class="d-flex flex-wrap gap-2">
                                                {% for assignment in order.assignments %}
                                                    {% if assignment.employee %}
                                                        <div class="badge bg-light text-dark p-2 d-flex align-items-center">
                                                            <img src="https://ui-avatars.com/api/?name={{ assignment.employee.name }}&background=10AC84&color=fff" 
                                                                 width="20" height="20" class="rounded-circle me-2">
                                                            {{ assignment.employee.email }}
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% else %}
                                        <p class="card-text text-muted mt-3">
                                            <i class="fas fa-exclamation-circle me-2"></i> لم يتم إسناد الطلب لأي مندوب بعد
                                        </p>
                                    {% endif %}
                                </div>
                                <div class="card-footer d-flex justify-content-between align-items-center">
                                    <span class="fw-bold text-primary">{{ order.total_amount }} ر.س</span>
                                    <div>
                                        <button class="btn btn-primary btn-sm">تغيير الحالة</button>
                                        <a href="{{ url_for('orders.order_details', order_id=order.id) }}" 
                                           class="btn btn-sm btn-info mb-1" title="عرض التفاصيل">
                                            <i class="fas fa-eye"></i> عرض
                                        </a>
                                        <button class="btn btn-sm btn-warning mb-1 assign-btn" 
                                                data-order-id="{{ order.id }}" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#assignOrderModal">
                                            <i class="fas fa-user-plus"></i> 
                                            {% if order.assigned_to %}تعديل{% else %}إسناد{% endif %}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="col-12 text-center py-5">
                            <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                            <p class="text-muted">لا توجد طلبات في هذه الحالة</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- قسم الخريطة (نفس المحتوى الأصلي) -->
        <div class="card">
            <!-- ... المحتوى الأصلي للخريطة ... -->
        </div>
    </div>
</div>

<!-- المودال مرة واحدة فقط -->
<div class="modal fade" id="assignOrderModal" tabindex="-1" aria-labelledby="assignOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignOrderModalLabel">إسناد الطلب</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="assignModalContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">جاري التحميل...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- مودال إسناد متعدد الطلبات -->
<div class="modal fade" id="assignMultipleModal" tabindex="-1" aria-labelledby="assignMultipleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignMultipleModalLabel">إسناد الطلبات المحددة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="assignMultipleModalContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">جاري التحميل...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // كود الرسوم المتحركة فقط
        window.addEventListener('scroll', () => {
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                const cardPosition = card.getBoundingClientRect().top;
                const screenPosition = window.innerHeight / 1.3;
                if(cardPosition < screenPosition) {
                    card.style.opacity = 1;
                    card.style.transform = 'translateY(0)';
                }
            });
        });

        // تهيئة أولية للبطاقات
        document.querySelectorAll('.card').forEach(card => {
            card.style.opacity = 0;
            card.style.transform = 'translateY(20px)';
            card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        });

        // تشغيل تأثير الظهور بعد تحميل الصفحة
        setTimeout(() => {
            document.querySelectorAll('.card').forEach((card, index) => {
                setTimeout(() => {
                    card.style.opacity = 1;
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });
        }, 500);

        const ordersTabs = document.getElementById('orders-tabs');
        if (ordersTabs) {
            ordersTabs.addEventListener('click', function(e) {
                e.preventDefault();
                const target = e.target.closest('a');
                if (!target) return;
                
                // إزالة النشاط من جميع التبويبات
                document.querySelectorAll('#orders-tabs a').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // إضافة النشاط للتبويب المختار
                target.classList.add('active');
                
                // الحصول على معرف الحالة المحددة
                const statusId = target.getAttribute('data-status-id');
                
                // إرسال طلب AJAX لجلب الطلبات المصفاة
  // إرسال طلب AJAX لجلب الطلبات المصفاة
fetch(`/dashboard/filter_orders?status_id=${statusId}`)
    .then(response => response.text())
    .then(html => {
        document.getElementById('orders-container').innerHTML = html;
        // إعادة تهيئة أحداث الاختيار بعد تحميل المحتوى الجديد
        initOrderSelection();
    })
    .catch(error => {
        console.error('Error:', error);
    });            });
        }

        // كود المودال
        $('#assignOrderModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            var orderId = button.data('order-id');
            var modal = $(this);
            
            modal.find('.modal-body').load('/delivery/assign_order_modal/' + orderId);
        });
        
        $('#assignOrderModal').on('hidden.bs.modal', function () {
            $(this).find('.modal-body').html(
                '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">جاري التحميل...</span></div></div>'
            );
        });

        // إدارة إسناد متعدد الطلبات
        function initOrderSelection() {
            const assignMultipleBtn = document.getElementById('assignMultipleBtn');
            const checkboxes = document.querySelectorAll('.order-checkbox');
            
            // إظهار/إخفاء زر الإسناد المتعدد بناءً على عدد الطلبات المحددة
            function updateAssignButton() {
                const selectedCount = document.querySelectorAll('.order-checkbox:checked').length;
                if (selectedCount > 0) {
                    assignMultipleBtn.style.display = 'block';
                    assignMultipleBtn.innerHTML = `<i class="fas fa-user-plus me-1"></i> إسناد المحدد (${selectedCount})`;
                } else {
                    assignMultipleBtn.style.display = 'none';
                }
            }
            
            // إضافة مستمعي الأحداث لخانات الاختيار
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateAssignButton);
            });
            
            // تحديث حالة الزر عند التحميل الأولي
            updateAssignButton();
        }
        // زر تحديد/إلغاء تحديد الكل
function initSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    if (!selectAllCheckbox) {
        // إنشاء زر تحديد الكل إذا لم يكن موجوداً
        const cardHeader = document.querySelector('.card-header h5.mb-0').closest('.card-header');
        const existingButton = cardHeader.querySelector('#selectAllCheckbox');
        
        if (!existingButton) {
            const selectAllDiv = document.createElement('div');
            selectAllDiv.className = 'form-check form-check-inline';
            selectAllDiv.innerHTML = `
                <input class="form-check-input" type="checkbox" id="selectAllCheckbox">
                <label class="form-check-label small" for="selectAllCheckbox">تحديد الكل</label>
            `;
            
            // إدراج زر تحديد الكل بجانب العنوان
            cardHeader.querySelector('h5').after(selectAllDiv);
            
            // إضافة مستمع الحدث لتحديد الكل
            document.getElementById('selectAllCheckbox').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.order-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateAssignButton();
            });
        }
    }
}

// تحديث دالة initOrderSelection لتشمل تحديد الكل
function initOrderSelection() {
    const assignMultipleBtn = document.getElementById('assignMultipleBtn');
    const checkboxes = document.querySelectorAll('.order-checkbox');
    
    // إظهار/إخفاء زر الإسناد المتعدد بناءً على عدد الطلبات المحددة
    function updateAssignButton() {
        const selectedCount = document.querySelectorAll('.order-checkbox:checked').length;
        if (selectedCount > 0) {
            assignMultipleBtn.style.display = 'block';
            assignMultipleBtn.innerHTML = `<i class="fas fa-user-plus me-1"></i> إسناد المحدد (${selectedCount})`;
        } else {
            assignMultipleBtn.style.display = 'none';
        }
        
        // تحديث حالة زر تحديد الكل
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        if (selectAllCheckbox) {
            const totalCheckboxes = document.querySelectorAll('.order-checkbox').length;
            selectAllCheckbox.checked = selectedCount > 0 && selectedCount === totalCheckboxes;
            selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < totalCheckboxes;
        }
    }
    
    // إضافة مستمعي الأحداث لخانات الاختيار
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateAssignButton);
    });
    
    // تهيئة زر تحديد الكل
    initSelectAll();
    
    // تحديث حالة الزر عند التحميل الأولي
    updateAssignButton();
}
        
        // تهيئة إدارة الاختيار عند تحميل الصفحة
        initOrderSelection();
        
        // معالجة النقر على زر إسناد المحدد
        // Add this function to get CSRF token
function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
}

// Update your fetch request for bulk assignment
document.getElementById('assignMultipleBtn').addEventListener('click', function() {
    const selectedOrders = Array.from(document.querySelectorAll('.order-checkbox:checked'))
        .map(checkbox => checkbox.getAttribute('data-order-id'));
    
    // تحميل محتوى المودال الخاص بالإسناد المتعدد
    fetch('/delivery/assign_multiple_orders_modal', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()  // Add CSRF token header
        },
        body: JSON.stringify({ order_ids: selectedOrders })
    })
    .then(response => response.text())
    .then(html => {
        document.getElementById('assignMultipleModalContent').innerHTML = html;
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('assignMultipleModalContent').innerHTML = 
            '<div class="alert alert-danger">حدث خطأ أثناء تحميل المحتوى</div>';
    });
});
    });
</script>
{% endblock %}