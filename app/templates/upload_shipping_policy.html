{% extends "base.html" %}

{% block title %}Ø±ÙØ¹ Ø¨ÙˆÙ„ÙŠØµØ© Ø§Ù„Ø´Ø­Ù†{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-file-invoice me-2"></i>
                        Ø±ÙØ¹ Ø¨ÙˆÙ„ÙŠØµØ© Ø§Ù„Ø´Ø­Ù†
                    </h4>
                    <a href="{{ url_for('orders.manage_shipping_policies') }}" class="btn btn-light btn-sm">
                        <i class="fas fa-cogs me-1"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙˆØ§Ù„ÙŠØµ
                    </a>
                </div>
                <div class="card-body">
                    <!-- Ù‚Ø³Ù… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† PDF -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-file-pdf me-2"></i>
                                        Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ù…Ù„Ù PDF Ø£Ùˆ ØµÙˆØ±Ø©
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="upload-section mb-3" id="dropArea">
                                        <div class="upload-icon">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                        </div>
                                        <label for="pdfFile" class="file-label">
                                            <i class="fas fa-file-pdf"></i> Ø§Ø®ØªØ± Ù…Ù„Ù PDF Ø£Ùˆ ØµÙˆØ±Ø©
                                        </label>
                                        <input type="file" id="pdfFile" accept=".pdf,.png,.jpg,.jpeg,.gif,.webp" />
                                        <p>Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ù…Ù„Ù PDF Ø£Ùˆ ØµÙˆØ±Ø© ÙˆØ£Ø³Ù‚Ø·Ù‡ Ù‡Ù†Ø§</p>
                                    </div>

                                    <div class="progress mb-3" id="progress" style="display: none;">
                                        <div class="progress-bar" id="progress-bar">0%</div>
                                    </div>

                                    <div class="status mb-3" id="status"></div>

                                    <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙØ­Ø§Øª - Ù…Ø®ÙÙŠØ© Ø¨Ø´ÙƒÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ -->
                                    <div class="mb-3">
                                        <button class="btn btn-sm btn-outline-secondary" id="togglePreviewBtn" style="display: none;">
                                            <i class="fas fa-eye me-1"></i>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©
                                        </button>
                                    </div>
                                    
                                    <div id="pagesPreview" class="mb-3" style="display: none;">
                                        <h6 class="mb-2">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©:</h6>
                                        <div id="pagesContainer" class="row">
                                            <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙØ­Ø§Øª Ù‡Ù†Ø§ -->
                                        </div>
                                    </div>

                                    <div class="card" id="extractedOrders" style="display: none;">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">
                                                <i class="fas fa-list-ol me-2"></i> 
                                                Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© Ù…Ù† Ø§Ù„Ù…Ù„Ù
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <button class="btn btn-sm btn-outline-primary" id="selectAllBtn">
                                                    <i class="fas fa-check-square me-1"></i>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary" id="deselectAllBtn">
                                                    <i class="fas fa-square me-1"></i>Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
                                                </button>
                                                <button class="btn btn-sm btn-success" id="uploadSelectedBtn" style="display: none;">
                                                    <i class="fas fa-upload me-1"></i>Ø±ÙØ¹ Ø§Ù„Ø¨ÙˆØ§Ù„ÙŠØµ Ù„Ù„Ù…Ø­Ø¯Ø¯
                                                </button>
                                            </div>
                                            <div id="extractedOrdersList" class="list-group" style="max-height: 400px; overflow-y: auto;">
                                                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© Ù‡Ù†Ø§ -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ù‚Ø³Ù… Ø±ÙØ¹ Ø§Ù„Ø¨ÙˆÙ„ÙŠØµØ© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-upload me-2"></i>
                                        Ø±ÙØ¹ Ø¨ÙˆÙ„ÙŠØµØ© Ø´Ø­Ù† ÙŠØ¯ÙˆÙŠØ§Ù‹
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <form id="uploadPolicyForm" enctype="multipart/form-data" class="row g-3">
                                        <div class="col-md-6">
                                            <label for="orderSearch" class="form-label">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨</label>
                                            <div class="input-group mb-3">
                                                <input type="text" 
                                                       class="form-control" 
                                                       id="orderSearch" 
                                                       placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ Ø§Ù„Ù…Ø±Ø¬Ø¹...">
                                                <button class="btn btn-outline-primary" type="button" id="searchBtn">
                                                    <i class="fas fa-search"></i> Ø¨Ø­Ø«
                                                </button>
                                            </div>
                                            
                                            <div class="form-text mb-3">
                                                Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ (ID) Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ (Reference ID)
                                            </div>
                                            
                                            <!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« -->
                                            <div id="searchResults" class="mt-3" style="display: none;">
                                                <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«:</label>
                                                <div id="ordersList" class="list-group" style="max-height: 300px; overflow-y: auto;">
                                                    <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ù‡Ù†Ø§ -->
                                                </div>
                                            </div>
                                            
                                            <!-- Ø­Ù‚Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø®ØªØ§Ø± Ù…Ø®ÙÙŠ -->
                                            <input type="hidden" id="selectedOrderId" name="order_id">
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <label for="policyFile" class="form-label">ØµÙˆØ±Ø© Ø§Ù„Ø¨ÙˆÙ„ÙŠØµØ©</label>
                                            <input class="form-control" type="file" id="policyFile" 
                                                   name="shipping_policy_image" 
                                                   accept=".png,.jpg,.jpeg,.gif,.pdf,.webp" required>
                                            <div class="form-text">
                                                Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©: PNG, JPG, JPEG, GIF, PDF, WEBP (Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ 16MB)
                                            </div>
                                        </div>
                                        
                                        <!-- Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø®ØªØ§Ø± -->
                                        <div class="col-12" id="orderDetails" style="display: none;">
                                            <div class="card border-info">
                                                <div class="card-body py-2">
                                                    <h6 class="card-title mb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø®ØªØ§Ø±:</h6>
                                                    <div class="row">
                                                        <div class="col-md-3">
                                                            <strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> <span id="selectedOrderNumber"></span>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <strong>Ø§Ù„Ù…Ø±Ø¬Ø¹:</strong> <span id="selectedReference"></span>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> <span id="selectedCustomer"></span>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> <span id="selectedAmount"></span>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="selectedDate"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-12">
                                            <button type="submit" class="btn btn-success" id="uploadBtn" disabled>
                                                <i class="fas fa-upload me-2"></i>Ø±ÙØ¹ Ø§Ù„Ø¨ÙˆÙ„ÙŠØµØ©
                                            </button>
                                        </div>
                                    </form>
                                    
                                    <div class="progress mt-3" style="display: none;" id="uploadProgress">
                                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    
                                    <div class="alert alert-danger mt-3" style="display: none;" id="uploadError"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    border: 1px solid rgba(0,0,0,0.125);
    border-radius: 0.5rem;
}

.card-header {
    border-bottom: 1px solid rgba(0,0,0,0.125);
}

.order-item {
    cursor: pointer;
    transition: all 0.2s ease;
}

.order-item:hover {
    background-color: #f8f9fa;
}

.order-item.selected {
    background-color: #e3f2fd;
    border-color: #2196f3;
}

.order-badge {
    font-size: 0.75rem;
}

.search-loading {
    position: absolute;
    right: 40px;
    top: 50%;
    transform: translateY(-50%);
    display: none;
}

.upload-section {
    border: 3px dashed #d6d8e0;
    padding: 40px 20px;
    text-align: center;
    border-radius: 0.5rem;
    margin-bottom: 20px;
    background-color: #fafbff;
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-section:hover, .upload-section.dragover {
    border-color: #4361ee;
    background-color: #eef2ff;
}

.upload-section p {
    margin-top: 15px;
    color: #666;
    font-size: 1.1rem;
}

.upload-icon {
    font-size: 3.5rem;
    color: #d6d8e0;
    margin-bottom: 15px;
}

.upload-section:hover .upload-icon {
    color: #4361ee;
}

.file-label {
    display: inline-block;
    background: linear-gradient(to right, #4361ee, #3a0ca3);
    color: white;
    padding: 14px 30px;
    border-radius: 50px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1.1rem;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
    margin-bottom: 10px;
}

.file-label:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(67, 97, 238, 0.4);
}

.extracted-order-item {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    border-bottom: 1px solid #eee;
}

.extracted-order-item:last-child {
    border-bottom: none;
}

.order-checkbox {
    margin-left: 10px;
}

.order-number-badge {
    background-color: #4361ee;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.85rem;
    margin-right: 10px;
}

.page-preview {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 5px;
    margin-bottom: 10px;
    background: white;
}

.page-preview img {
    max-width: 100%;
    height: auto;
    border-radius: 3px;
}

.page-info {
    font-size: 0.8rem;
    color: #666;
    margin-top: 5px;
    text-align: center;
}

.order-with-image {
    display: flex;
    align-items: flex-start;
    padding: 10px;
    border: 1px solid #e9ecef;
    border-radius: 5px;
    margin-bottom: 10px;
    background: #f8f9fa;
}

.order-image-preview {
    width: 80px;
    height: 80px;
    border: 1px solid #ddd;
    border-radius: 4px;
    overflow: hidden;
    margin-left: 10px;
    flex-shrink: 0;
}

.order-image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.order-details {
    flex-grow: 1;
}

.order-actions {
    display: flex;
    align-items: center;
    margin-top: 5px;
}

.retry-section {
    border: 1px solid #ffc107;
    border-radius: 5px;
    padding: 10px;
    margin-top: 10px;
    background-color: #fffbf0;
}

.image-processing-options {
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 15px;
    margin-top: 15px;
    background-color: #f8f9fa;
}

.image-processing-options h6 {
    margin-bottom: 10px;
    color: #495057;
}
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script>
// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
let selectedOrder = null;
let extractedOrders = [];
let selectedOrdersFromPDF = [];
let isImageProcessingEnabled = true;

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    initializeForm();
    setupSearch();
    setupPDFUpload();
});

// ØªÙ‡ÙŠØ¦Ø© Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø±ÙØ¹
function initializeForm() {
    const uploadForm = document.getElementById('uploadPolicyForm');
    if (uploadForm) {
        uploadForm.addEventListener('submit', handleFormSubmit);
    }
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
async function handleFormSubmit(e) {
    e.preventDefault();
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø­Ø¯Ø¯Ø©
    if (!selectedOrder && selectedOrdersFromPDF.length === 0) {
        showError('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ù…Ù† Ù…Ù„Ù PDF');
        return;
    }
    
    const fileInput = document.getElementById('policyFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showError('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù');
        return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù
    if (file.size > 16 * 1024 * 1024) {
        showError('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 16MB');
        return;
    }
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯ Ù…Ø­Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø¨Ø­Ø«
    if (selectedOrder) {
        await uploadPolicy(selectedOrder.id, file, 'uploadProgress', 'uploadError');
    }
}

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø­Ø«
function setupSearch() {
    const searchInput = document.getElementById('orderSearch');
    const searchBtn = document.getElementById('searchBtn');
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¨Ø­Ø«
    searchBtn.addEventListener('click', performSearch);
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            performSearch();
        }
    });
}

// ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø­Ø«
async function performSearch() {
    const searchTerm = document.getElementById('orderSearch').value.trim();
    const searchBtn = document.getElementById('searchBtn');
    const searchResults = document.getElementById('searchResults');
    const ordersList = document.getElementById('ordersList');
    
    if (!searchTerm) {
        showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ Ø§Ù„Ù…Ø±Ø¬Ø¹ Ù„Ù„Ø¨Ø­Ø«');
        return;
    }
    
    // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...';
    searchBtn.disabled = true;
    
    try {
        const response = await fetch(`/api/search-orders?q=${encodeURIComponent(searchTerm)}`);
        const data = await response.json();
        
        if (response.ok) {
            // Ù…Ø³Ø­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            ordersList.innerHTML = '';
            
            // Ø¥Ø¶Ø§ÙØ© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
            if (data.orders && data.orders.length > 0) {
                data.orders.forEach(order => {
                    const orderItem = document.createElement('div');
                    orderItem.className = 'list-group-item order-item';
                    orderItem.innerHTML = `
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${order.customer_name}</h6>
                                <p class="mb-1">
                                    <span class="badge bg-primary order-badge">Ø±Ù‚Ù…: ${order.id}</span>
                                    ${order.reference_id ? `<span class="badge bg-secondary order-badge">Ù…Ø±Ø¬Ø¹: ${order.reference_id}</span>` : ''}
                                </p>
                                <small class="text-muted">
                                    ${order.total_amount} ${order.currency} - ${order.created_at}
                                </small>
                            </div>
                            <button class="btn btn-sm btn-outline-success select-order-btn" data-order='${JSON.stringify(order)}'>
                                Ø§Ø®ØªØ±
                            </button>
                        </div>
                    `;
                    ordersList.appendChild(orderItem);
                });
                
                // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
                document.querySelectorAll('.select-order-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        selectOrder(JSON.parse(this.getAttribute('data-order')));
                    });
                });
                
                searchResults.style.display = 'block';
                showSuccess(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${data.orders.length} Ø·Ù„Ø¨`);
            } else {
                searchResults.style.display = 'none';
                showError('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø¨Ø­Ø«Ùƒ');
            }
        } else {
            throw new Error(data.error || 'ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«');
        }
    } catch (error) {
        console.error('Search error:', error);
        showError(error.message);
        searchResults.style.display = 'none';
    } finally {
        // Ø¥Ø¹Ø§Ø¯Ø© Ø²Ø± Ø§Ù„Ø¨Ø­Ø« Ù„Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø£ØµÙ„ÙŠØ©
        searchBtn.innerHTML = '<i class="fas fa-search"></i> Ø¨Ø­Ø«';
        searchBtn.disabled = false;
    }
}

// Ø§Ø®ØªÙŠØ§Ø± Ø·Ù„Ø¨
function selectOrder(order) {
    selectedOrder = order;
    selectedOrdersFromPDF = []; // Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† PDF
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ÙÙŠ
    document.getElementById('selectedOrderId').value = order.id;
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
    document.getElementById('selectedOrderNumber').textContent = order.id;
    document.getElementById('selectedReference').textContent = order.reference_id || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
    document.getElementById('selectedCustomer').textContent = order.customer_name;
    document.getElementById('selectedAmount').textContent = order.total_amount + ' ' + order.currency;
    document.getElementById('selectedDate').textContent = order.created_at;
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„ØªÙØ§ØµÙŠÙ„
    document.getElementById('orderDetails').style.display = 'block';
    
    // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø±ÙØ¹
    document.getElementById('uploadBtn').disabled = false;
    
    // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø®ØªØ§Ø±
    document.querySelectorAll('.order-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø®ØªØ§Ø± ÙˆØªÙ…ÙŠÙŠØ²Ù‡
    const selectedItem = Array.from(document.querySelectorAll('.select-order-btn')).find(btn => {
        return JSON.parse(btn.getAttribute('data-order')).id === order.id;
    });
    
    if (selectedItem) {
        selectedItem.closest('.order-item').classList.add('selected');
        selectedItem.innerHTML = '<i class="fas fa-check"></i> Ù…Ø®ØªØ§Ø±';
        selectedItem.classList.remove('btn-outline-success');
        selectedItem.classList.add('btn-success');
    }
    
    showSuccess('ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
}

// Ø¥Ø¹Ø¯Ø§Ø¯ ØªØ­Ù…ÙŠÙ„ PDF ÙˆØ§Ù„ØµÙˆØ±
function setupPDFUpload() {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    
    const pdfFile = document.getElementById('pdfFile');
    const progress = document.getElementById('progress');
    const progressBar = document.getElementById('progress-bar');
    const status = document.getElementById('status');
    const extractedOrdersDiv = document.getElementById('extractedOrders');
    const extractedOrdersList = document.getElementById('extractedOrdersList');
    const dropArea = document.getElementById('dropArea');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const deselectAllBtn = document.getElementById('deselectAllBtn');
    const uploadSelectedBtn = document.getElementById('uploadSelectedBtn');
    const pagesPreview = document.getElementById('pagesPreview');
    const pagesContainer = document.getElementById('pagesContainer');
    const togglePreviewBtn = document.getElementById('togglePreviewBtn');
    
    // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±
    const imageProcessingHTML = `
        <div class="image-processing-options">
            <h6><i class="fas fa-cogs me-2"></i>Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±</h6>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="imageProcessingToggle" checked>
                <label class="form-check-label" for="imageProcessingToggle">
                    ØªÙØ¹ÙŠÙ„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± Ù„ØªØ­Ø³ÙŠÙ† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ
                </label>
            </div>
            <div class="form-text">
                ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø§ØµÙŠØ© ÙŠØ­Ø³Ù† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„ØµÙˆØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ§Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
            </div>
        </div>
    `;
    
    dropArea.insertAdjacentHTML('afterend', imageProcessingHTML);
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
    const imageProcessingToggle = document.getElementById('imageProcessingToggle');
    imageProcessingToggle.addEventListener('change', function() {
        isImageProcessingEnabled = this.checked;
    });
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, function() {
            dropArea.classList.add('dragover');
        }, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, function() {
            dropArea.classList.remove('dragover');
        }, false);
    });
    
    dropArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length && (files[0].type === 'application/pdf' || files[0].type.startsWith('image/'))) {
            pdfFile.files = files;
            loadFile(files[0]);
        } else {
            status.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø³Ù‚Ø§Ø· Ù…Ù„Ù PDF Ø£Ùˆ ØµÙˆØ±Ø© ØµØ§Ù„Ø­Ø©';
        }
    }
    
    pdfFile.addEventListener('change', function(event) {
        if (event.target.files.length && 
            (event.target.files[0].type === 'application/pdf' || 
             event.target.files[0].type.startsWith('image/'))) {
            loadFile(event.target.files[0]);
        } else {
            status.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù PDF Ø£Ùˆ ØµÙˆØ±Ø© ØµØ§Ù„Ø­Ø©';
        }
    });
    
    // Ø£Ø­Ø¯Ø§Ø« Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ¯
    selectAllBtn.addEventListener('click', function() {
        document.querySelectorAll('.order-checkbox').forEach(checkbox => {
            checkbox.checked = true;
        });
        updateSelectedOrdersFromPDF();
    });
    
    deselectAllBtn.addEventListener('click', function() {
        document.querySelectorAll('.order-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        updateSelectedOrdersFromPDF();
    });
    
    // Ø­Ø¯Ø« Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    uploadSelectedBtn.addEventListener('click', function() {
        uploadSelectedOrders();
    });
    
    // Ø­Ø¯Ø« Ø²Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙØ­Ø§Øª
    togglePreviewBtn.addEventListener('click', function() {
        if (pagesPreview.style.display === 'none') {
            pagesPreview.style.display = 'block';
            togglePreviewBtn.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©';
        } else {
            pagesPreview.style.display = 'none';
            togglePreviewBtn.innerHTML = '<i class="fas fa-eye me-1"></i>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©';
        }
    });
    
    function loadFile(file) {
        status.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù...';
        progress.style.display = 'block';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        extractedOrdersDiv.style.display = 'none';
        extractedOrdersList.innerHTML = '';
        pagesPreview.style.display = 'none';
        pagesContainer.innerHTML = '';
        togglePreviewBtn.style.display = 'none';
        extractedOrders = [];
        selectedOrdersFromPDF = [];
        uploadSelectedBtn.style.display = 'none';
        
        // Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø¨Ø­Ø«
        selectedOrder = null;
        document.getElementById('orderDetails').style.display = 'none';
        document.getElementById('uploadBtn').disabled = true;
        
        if (file.type === 'application/pdf') {
            loadPDF(file);
        } else if (file.type.startsWith('image/')) {
            loadImage(file);
        }
    }
    
    function loadPDF(file) {
        const fileReader = new FileReader();
        
        fileReader.onload = function() {
            const typedarray = new Uint8Array(this.result);
            
            pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
                status.textContent = `ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØŒ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª: ${pdf.numPages}`;
                extractOrdersAndImagesFromPDF(pdf);
            }).catch(function(error) {
                status.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ' + error.message;
            });
        };
        
        fileReader.readAsArrayBuffer(file);
    }
    
    function loadImage(file) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const imageUrl = e.target.result;
            const img = new Image();
            
            img.onload = function() {
                // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† ÙŠØ´Ø¨Ù‡ Ø¨ÙŠØ§Ù†Ø§Øª PDF Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
                const mockPDF = {
                    numPages: 1
                };
                
                status.textContent = 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ...';
                
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
                extractOrderAndImageFromImage(img, 1).then(orderData => {
                    progress.style.display = 'none';
                    
                    if (orderData && orderData.orderNumber) {
                        extractedOrders = [orderData];
                        displayExtractedOrders();
                        displayPagesPreview([orderData]);
                        togglePreviewBtn.style.display = 'inline-block';
                        status.textContent = `ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©`;
                    } else {
                        status.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©';
                    }
                });
            };
            
            img.src = imageUrl;
        };
        
        reader.readAsDataURL(file);
    }
    
    function extractOrdersAndImagesFromPDF(pdf) {
        extractedOrders = [];
        
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„ØµÙˆØ± Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª
        const pagePromises = [];
        for (let i = 1; i <= pdf.numPages; i++) {
            pagePromises.push(extractOrderAndImageFromPage(pdf, i));
        }
        
        Promise.all(pagePromises).then((results) => {
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';
            
            setTimeout(() => {
                progress.style.display = 'none';
                
                if (extractedOrders.length > 0) {
                    displayExtractedOrders();
                    displayPagesPreview(results);
                    togglePreviewBtn.style.display = 'inline-block';
                    status.textContent = `ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ ${extractedOrders.length} Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ù„Ù`;
                } else {
                    status.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ø§Ù„Ù…Ù„Ù';
                }
            }, 500);
        });
    }
    
    // Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„ØµÙˆØ±
    async function extractOrderAndImageFromImage(img, pageNumber) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ
        if (isImageProcessingEnabled) {
            await enhanceImageForOCR(canvas, ctx);
        }
        
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Tesseract.js
        let extractedText = '';
        try {
            const worker = await Tesseract.createWorker('ara+eng');
            const { data: { text } } = await worker.recognize(canvas);
            await worker.terminate();
            extractedText = text || '';
        } catch (error) {
            console.error('Tesseract error:', error);
        }
        
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù†Øµ
        const orderNumber = extractOrderNumberFromText(extractedText);
        
        // Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        const imageUrl = URL.createObjectURL(blob);
        
        const orderData = {
            pageNumber,
            orderNumber: orderNumber || `image_${pageNumber}`,
            imageUrl,
            imageBlob: blob,
            extractedText: extractedText.substring(0, 200) + '...'
        };
        
        return orderData;
    }
    
    // Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† ØµÙØ­Ø© PDF
    async function extractOrderAndImageFromPage(pdf, pageNumber) {
        const page = await pdf.getPage(pageNumber);

        const viewport = page.getViewport({ scale: 2.5 }); // ØªØ­Ø³ÙŠÙ† Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø©
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = Math.round(viewport.width);
        canvas.height = Math.round(viewport.height);

        const renderContext = { canvasContext: ctx, viewport };
        await page.render(renderContext).promise;

        // ===== 1) Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† PDF =====
        const textContent = await page.getTextContent();
        const items = textContent.items || [];

        const rows = [];
        items.forEach(item => {
            const str = item.str || '';
            const tx = item.transform || [];
            const x = tx[4] ?? 0;
            const y = tx[5] ?? 0;

            const tol = 4; // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØªØ­Ù…Ù„ Ù„Ù„ØªÙØ§ÙˆØª
            let row = rows.find(r => Math.abs(r.y - y) <= tol);
            if (!row) {
                row = { y, parts: [] };
                rows.push(row);
            }
            row.parts.push({ x, str });
        });

        rows.sort((a, b) => b.y - a.y);
        const reconstructedLines = rows.map(r =>
            r.parts.sort((p, q) => p.x - q.x).map(p => p.str).join(' ')
        );
        let text = reconstructedLines.join('\n').replace(/\s+/g, ' ').trim();

        // ===== 2) Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù†Øµ =====
        let orderNumber = extractOrderNumberFromText(text);

        // ===== 3) Ø§Ø³ØªØ®Ø¯Ø§Ù… OCR Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ =====
        if (!orderNumber && isImageProcessingEnabled) {
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ
            await enhanceImageForOCR(canvas, ctx);
            
            try {
                const worker = await Tesseract.createWorker('ara+eng');
                const { data: { text: ocrText } } = await worker.recognize(canvas);
                await worker.terminate();
                
                // Ø¯Ù…Ø¬ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ Ù…Ù† PDF Ù…Ø¹ Ù†Øµ OCR
                const combinedText = text + ' ' + ocrText;
                orderNumber = extractOrderNumberFromText(combinedText);
            } catch (error) {
                console.error('Tesseract error:', error);
            }
        }

        // ===== 4) Ø­Ù„ Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù†Ù‡Ø§Ø¦ÙŠ =====
        if (!orderNumber) {
            const fallbackMatch = text.match(/(\d{6,15})/);
            if (fallbackMatch) {
                orderNumber = normalizeDigits(fallbackMatch[1]);
                console.log(`âš ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ù„ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ: ${orderNumber}`);
            }
        }

        if (!orderNumber) orderNumber = `page_${pageNumber}`;

        // ===== 5) Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© =====
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        const imageUrl = URL.createObjectURL(blob);

        const orderData = {
            pageNumber,
            orderNumber,
            imageUrl,
            imageBlob: blob,
            extractedText: text.substring(0, 200) + '...'
        };

        if (typeof extractedOrders !== 'undefined' && orderNumber && !extractedOrders.some(o => o.orderNumber === orderNumber)) {
            extractedOrders.push(orderData);
        }

        if (typeof progressBar !== 'undefined' && pdf.numPages) {
            const progressPercent = Math.round((pageNumber / pdf.numPages) * 100);
            progressBar.style.width = `${progressPercent}%`;
            progressBar.textContent = `${progressPercent}%`;
        }

        return orderData;
    }
        // ØªØ­Ø³ÙŠÙ† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Tesseract Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
async function extractTextWithTesseract(canvas) {
    const worker = await Tesseract.createWorker('ara+eng'); // Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© + Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
    
    // ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
    await worker.setParameters({
        tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK,
        tessedit_char_whitelist: '0123456789', // Ù„Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
        preserve_interword_spaces: '1',
        textord_min_linesize: '0.5'
    });
    
    const { data: { text } } = await worker.recognize(canvas);
    await worker.terminate();
    return text;
}
    // Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù†Øµ
    function extractOrderNumberFromText(text) {
    const normalizedText = text.replace(/\s+/g, ' ').trim();
    
    console.log("ğŸ” Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ Ù„Ù„Ù…Ù„Ù Ø§Ù„Ø£ÙˆÙ„:", normalizedText.substring(0, 300));
    
    // Ø£Ù†Ù…Ø§Ø· Ù…Ø®ØµØµØ© Ù„Ù„Ù…Ù„Ù Ø§Ù„Ø£ÙˆÙ„
    const patternsForFirstFile = [
        // Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ù…Ù„Ù Ø§Ù„Ø£ÙˆÙ„: Ø£Ø±Ù‚Ø§Ù… ØªØ¨Ø¯Ø£ Ø¨Ù€ 21
        /\b(21\d{7})\b/,
        /PCs?:\s*1[\r\n\s]*([\s\S]{0,50}?2\d{8})/i,
        /PCs?:\s*[\r\n\s]*[\s\S]{0,100}?(\d{9})/i,
        // Ù†Ù…Ø· Ù…Ø®ØµØµ Ù„Ù„Ù…Ù„Ù Ø§Ù„Ø£ÙˆÙ„ Ø¨Ø¹Ø¯ PCs: 1
        /PCs?:\s*1\s*n[\r\n\s]*\s*(\d{9})/i,
        
        // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† "Ship Date"
        /Ship\s*Date[\s\S]{0,50}?(\d{9})/i,
        
        // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† "WGT"
        /WGT[\s\S]{0,50}?(\d{9})/i,
        
        // Ù†Ù…Ø· Ø¹Ø§Ù… Ù„Ù„Ù…Ù„Ù Ø§Ù„Ø£ÙˆÙ„
        /\b(21\d{7})\b/,
        
        // Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ: Ø£ÙŠ 9 Ø£Ø±Ù‚Ø§Ù…
        /\b(\d{9})\b/
    ];

    // ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ø®ØµØµØ© Ø£ÙˆÙ„Ø§Ù‹
    for (let i = 0; i < patternsForFirstFile.length; i++) {
        const matches = normalizedText.match(patternsForFirstFile[i]);
        if (matches) {
            let extracted = matches[1] || matches[0];
            const normalized = normalizeDigits(extracted);
            
            if (normalized && normalized.length === 9) {
                console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù… '${normalized}' Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ù…Ø· ${i}`);
                return normalized;
            }
        }
    }
    
    // Ø¥Ø°Ø§ ÙØ´Ù„Øª Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ø®ØµØµØ©ØŒ Ø¬Ø±Ø¨ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¹Ø§Ù…Ø©
    const generalPatterns = [
        /PCs?:\s*1\s*[\r\n]*\s*(\d{6,15})/i,
        /\b(2\d{5,8})\b/,
        /\b\d{6,15}\b/
    ];
    
    for (let pattern of generalPatterns) {
        const matches = normalizedText.match(pattern);
        if (matches) {
            let extracted = matches[1] || matches[0];
            const normalized = normalizeDigits(extracted);
            if (normalized && normalized.length >= 6 && normalized.length <= 15) {
                console.log(`âš ï¸ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¨Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø¹Ø§Ù…: ${normalized}`);
                return normalized;
            }
        }
    }
    
    console.log('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… Ø·Ù„Ø¨Ø§Øª');
    return null;
}
    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ
    async function enhanceImageForOCR(canvas, ctx) {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        
        // ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ¨Ø§ÙŠÙ†
        for (let i = 0; i < data.length; i += 4) {
            // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØªØ¨Ø§ÙŠÙ†
            const factor = 1.5;
            data[i] = Math.min(255, Math.max(0, (data[i] - 128) * factor + 128)); // Ø§Ù„Ø£Ø­Ù…Ø±
            data[i + 1] = Math.min(255, Math.max(0, (data[i + 1] - 128) * factor + 128)); // Ø§Ù„Ø£Ø®Ø¶Ø±
            data[i + 2] = Math.min(255, Math.max(0, (data[i + 2] - 128) * factor + 128)); // Ø§Ù„Ø£Ø²Ø±Ù‚
        }
        
        ctx.putImageData(imageData, 0, 0);
        return canvas;
    }
    
    function displayPagesPreview(pagesData) {
        pagesContainer.innerHTML = '';
        
        pagesData.forEach(pageData => {
            const col = document.createElement('div');
            col.className = 'col-md-3 col-sm-6 mb-3';
            col.innerHTML = `
                <div class="page-preview">
                    <img src="${pageData.imageUrl}" alt="ØµÙØ­Ø© ${pageData.pageNumber}">
                    <div class="page-info">
                        Ø§Ù„ØµÙØ­Ø© ${pageData.pageNumber} - ${pageData.orderNumber}
                    </div>
                </div>
            `;
            pagesContainer.appendChild(col);
        });
    }
    
    function displayExtractedOrders() {
        extractedOrdersList.innerHTML = '';
        
        extractedOrders.forEach(orderData => {
            const orderItem = document.createElement('div');
            orderItem.className = 'order-with-image';
            orderItem.innerHTML = `
                <div class="order-image-preview">
                    <img src="${orderData.imageUrl}" alt="Ø·Ù„Ø¨ ${orderData.orderNumber}">
                </div>
                <div class="order-details">
                    <div class="d-flex align-items-center mb-2">
                        <input type="checkbox" class="form-check-input order-checkbox" value="${orderData.orderNumber}">
                        <span class="order-number-badge ms-2">${orderData.orderNumber}</span>
                        <strong>Ø·Ù„Ø¨ Ø±Ù‚Ù… ${orderData.orderNumber}</strong>
                    </div>
                    <div class="order-actions">
                        <small class="text-muted">Ø§Ù„ØµÙØ­Ø©: ${orderData.pageNumber}</small>
                        <button class="btn btn-sm btn-outline-info ms-2" onclick="verifyOrder('${orderData.orderNumber}')">
                            <i class="fas fa-search"></i> Ø§Ù„ØªØ­Ù‚Ù‚
                        </button>
                    </div>
                    <small class="text-muted d-block mt-1">${orderData.extractedText}</small>
                </div>
            `;
            extractedOrdersList.appendChild(orderItem);
        });
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
        document.querySelectorAll('.order-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedOrdersFromPDF);
        });
        
        extractedOrdersDiv.style.display = 'block';
    }
    
    function updateSelectedOrdersFromPDF() {
        selectedOrdersFromPDF = [];
        document.querySelectorAll('.order-checkbox:checked').forEach(checkbox => {
            selectedOrdersFromPDF.push(checkbox.value);
        });
        
        // Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø±ÙØ¹
        if (selectedOrdersFromPDF.length > 0) {
            uploadSelectedBtn.style.display = 'inline-block';
            uploadSelectedBtn.textContent = `Ø±ÙØ¹ Ø§Ù„Ø¨ÙˆØ§Ù„ÙŠØµ Ù„Ù„Ù…Ø­Ø¯Ø¯ (${selectedOrdersFromPDF.length})`;
            
            // Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø¨Ø­Ø«
            selectedOrder = null;
            document.getElementById('selectedOrderId').value = '';
            document.getElementById('orderDetails').style.display = 'none';
            document.getElementById('uploadBtn').disabled = true;
        } else {
            uploadSelectedBtn.style.display = 'none';
        }
    }
}

// Ø±ÙØ¹ Ø§Ù„Ø¨ÙˆØ§Ù„ÙŠØµ Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
async function uploadSelectedOrders() {
    if (selectedOrdersFromPDF.length === 0) {
        showError('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ù„Ø¨Ø§Øª Ù„Ø±ÙØ¹ Ø¨ÙˆØ§Ù„ÙŠØµÙ‡Ø§');
        return;
    }
    
    const progress = document.getElementById('uploadProgress');
    const error = document.getElementById('uploadError');
    
    showLoading(true, 'uploadProgress', 'uploadError');
    
    let successCount = 0;
    let errorCount = 0;
    let results = {
        successful: [],
        failed: []
    };
    
    for (let i = 0; i < selectedOrdersFromPDF.length; i++) {
        const orderNumber = selectedOrdersFromPDF[i];
        
        try {
            // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
            const progressPercent = Math.round(((i + 1) / selectedOrdersFromPDF.length) * 100);
            progress.querySelector('.progress-bar').style.width = `${progressPercent}%`;
            progress.querySelector('.progress-bar').textContent = `${progressPercent}%`;
            
            // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨
            const orderData = extractedOrders.find(order => order.orderNumber === orderNumber);
            if (orderData) {
                // Ø±ÙØ¹ Ø§Ù„Ø¨ÙˆÙ„ÙŠØµØ© Ù„Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
                const result = await uploadPolicyForOrderNumber(orderNumber, orderData.imageBlob);
                
                if (result.success) {
                    successCount++;
                    results.successful.push({
                        order_number: orderNumber,
                        order_id: result.order_id
                    });
                } else {
                    errorCount++;
                    results.failed.push({
                        order_number: orderNumber,
                        error: result.error,
                        imageUrl: orderData.imageUrl
                    });
                }
            } else {
                errorCount++;
                results.failed.push({
                    order_number: orderNumber,
                    error: 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØ±Ø©'
                });
            }
        } catch (error) {
            console.error(`Error uploading policy for order ${orderNumber}:`, error);
            errorCount++;
            results.failed.push({
                order_number: orderNumber,
                error: error.message
            });
        }
    }
    
    showLoading(false, 'uploadProgress', 'uploadError');
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    displayUploadResults(results, successCount, errorCount);
}

// Ø±ÙØ¹ Ø¨ÙˆÙ„ÙŠØµØ© Ù„Ø±Ù‚Ù… Ø·Ù„Ø¨ Ù…Ø¹ÙŠÙ†
async function uploadPolicyForOrderNumber(orderNumber, imageBlob) {
    const formData = new FormData();
    formData.append('shipping_policy_image', imageBlob, `${orderNumber}.png`);
    formData.append('order_number', orderNumber);
    
    const response = await fetch('/orders/shipping-policy-by-number', {
        method: 'POST',
        body: formData
    });
    
    const data = await response.json();
    
    return {
        success: response.ok,
        ...data
    };
}

// Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø±ÙØ¹
function displayUploadResults(results, successCount, errorCount) {
    let resultHTML = '';
    
    if (successCount > 0) {
        resultHTML += `
            <div class="alert alert-success">
                <h6><i class="fas fa-check-circle"></i> ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¨ÙˆØ§Ù„ÙŠØµ Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:</h6>
                <ul class="mb-0">
                    ${results.successful.map(order => 
                        `<li>Ø§Ù„Ø·Ù„Ø¨ ${order.order_number} (Ø±Ù‚Ù…: ${order.order_id})</li>`
                    ).join('')}
                </ul>
            </div>
        `;
    }
    
    if (errorCount > 0) {
        let failedOrdersHTML = '';
        
        results.failed.forEach(failedOrder => {
            failedOrdersHTML += `
                <div class="mb-3 p-3 border rounded">
                    <div class="d-flex align-items-start">
                        ${failedOrder.imageUrl ? `
                        <div class="me-3">
                            <img src="${failedOrder.imageUrl}" alt="Ø·Ù„Ø¨ ${failedOrder.order_number}" style="max-width: 100px; max-height: 100px; object-fit: contain;">
                        </div>
                        ` : ''}
                        <div class="flex-grow-1">
                            <h6 class="mb-1">Ø§Ù„Ø·Ù„Ø¨ ${failedOrder.order_number}</h6>
                            <p class="text-danger mb-2">${failedOrder.error}</p>
                            <div class="retry-section">
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control retry-order-input" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„ØµØ­ÙŠØ­" value="${failedOrder.order_number}">
                                    <button class="btn btn-warning retry-btn" data-image-url="${failedOrder.imageUrl || ''}">
                                        <i class="fas fa-redo me-1"></i>Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        resultHTML += `
            <div class="alert alert-danger">
                <h6><i class="fas fa-exclamation-triangle"></i> ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ø¨ÙˆØ§Ù„ÙŠØµ Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:</h6>
                ${failedOrdersHTML}
            </div>
        `;
    }
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø©
    Swal.fire({
        title: 'Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø±ÙØ¹',
        html: resultHTML || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬',
        icon: errorCount === 0 ? 'success' : 'warning',
        confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
        width: '700px',
        didOpen: () => {
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ø£Ø²Ø±Ø§Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
            document.querySelectorAll('.retry-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const orderInput = this.closest('.input-group').querySelector('.retry-order-input');
                    const orderNumber = orderInput.value.trim();
                    const imageUrl = this.getAttribute('data-image-url');
                    
                    if (!orderNumber) {
                        showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨');
                        return;
                    }
                    
                    retryFailedOrder(orderNumber, imageUrl, this);
                });
            });
        }
    });
    
    if (errorCount === 0) {
        // Ø¥Ø°Ø§ Ù†Ø¬Ø­Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§ØªØŒ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        setTimeout(() => {
            resetForm();
        }, 2000);
    }
}

// Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙØ§Ø´Ù„Ø©
async function retryFailedOrder(orderNumber, imageUrl, retryButton) {
    const originalText = retryButton.innerHTML;
    retryButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...';
    retryButton.disabled = true;
    
    try {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const searchResponse = await fetch(`/api/search-orders?q=${encodeURIComponent(orderNumber)}`);
        const searchData = await searchResponse.json();
        
        if (searchResponse.ok && searchData.orders && searchData.orders.length > 0) {
            const order = searchData.orders[0];
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ ØµÙˆØ±Ø©ØŒ Ù†Ø­ØªØ§Ø¬ Ù„ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ Blob
            if (imageUrl) {
                const imageResponse = await fetch(imageUrl);
                const imageBlob = await imageResponse.blob();
                
                // Ø±ÙØ¹ Ø§Ù„Ø¨ÙˆÙ„ÙŠØµØ©
                const result = await uploadPolicyForOrderNumber(orderNumber, imageBlob);
                
                if (result.success) {
                    showSuccess(`ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¨ÙˆÙ„ÙŠØµØ© Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù„Ø·Ù„Ø¨ ${orderNumber}`);
                    
                    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø¨Ø¹Ø¯ ÙØªØ±Ø©
                    setTimeout(() => {
                        Swal.close();
                    }, 1500);
                } else {
                    throw new Error(result.error || 'ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ø¨ÙˆÙ„ÙŠØµØ©');
                }
            } else {
                throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù…ØªØ§Ø­Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©');
            }
        } else {
            throw new Error('Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }
    } catch (error) {
        console.error('Retry error:', error);
        showError(`ÙØ´Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©: ${error.message}`);
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
        retryButton.innerHTML = originalText;
        retryButton.disabled = false;
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function verifyOrder(orderNumber) {
    try {
        const response = await fetch(`/api/search-orders?q=${encodeURIComponent(orderNumber)}`);
        const data = await response.json();
        
        if (response.ok && data.orders && data.orders.length > 0) {
            const order = data.orders[0];
            Swal.fire({
                title: 'Ø§Ù„Ø·Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯',
                html: `
                    <div class="text-start">
                        <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> ${order.id}</p>
                        <p><strong>Ø§Ù„Ù…Ø±Ø¬Ø¹:</strong> ${order.reference_id || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
                        <p><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${order.customer_name}</p>
                        <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${order.total_amount} ${order.currency}</p>
                    </div>
                `,
                icon: 'success',
                confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
            });
        } else {
            Swal.fire({
                title: 'ØªØ­Ø°ÙŠØ±',
                text: `Ø§Ù„Ø·Ù„Ø¨ ${orderNumber} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`,
                icon: 'warning',
                confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
            });
        }
    } catch (error) {
        console.error('Verification error:', error);
        Swal.fire({
            title: 'Ø®Ø·Ø£',
            text: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨',
            icon: 'error',
            confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
        });
    }
}

// Ø±ÙØ¹ Ø§Ù„Ø¨ÙˆÙ„ÙŠØµØ©
async function uploadPolicy(orderId, file, progressId, errorId) {
    const formData = new FormData();
    formData.append('shipping_policy_image', file);
    
    showLoading(true, progressId, errorId);
    
    try {
        const response = await fetch(`/orders/${orderId}/shipping-policy`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showSuccess('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¨ÙˆÙ„ÙŠØµØ© Ø¨Ù†Ø¬Ø§Ø­');
            resetForm();
            // Ø¹Ø±Ø¶ Ø±Ø§Ø¨Ø· Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
            setTimeout(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­',
                    text: 'ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¨ÙˆÙ„ÙŠØµØ© Ø¨Ù†Ø¬Ø§Ø­',
                    showCancelButton: true,
                    confirmButtonText: 'Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©',
                    cancelButtonText: 'Ø§Ù„Ø¨Ù‚Ø§Ø¡ Ù‡Ù†Ø§',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = "{{ url_for('orders.manage_shipping_policies') }}";
                    }
                });
            }, 1000);
        } else {
            throw new Error(data.error || 'ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù');
        }
    } catch (error) {
        console.error('Upload error:', error);
        showError(error.message, errorId);
    } finally {
        showLoading(false, progressId, errorId);
    }
}

// Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
function showLoading(show, progressId, errorId) {
    const progress = document.getElementById(progressId);
    const error = document.getElementById(errorId);
    
    if (progress) {
        progress.style.display = show ? 'block' : 'none';
        if (show) {
            progress.querySelector('.progress-bar').style.width = '0%';
        }
    }
    
    if (error) {
        error.style.display = 'none';
    }
    
    const uploadBtn = document.getElementById('uploadBtn');
    if (uploadBtn) {
        uploadBtn.disabled = show;
    }
    
    const uploadSelectedBtn = document.getElementById('uploadSelectedBtn');
    if (uploadSelectedBtn) {
        uploadSelectedBtn.disabled = show;
    }
}

function showError(message, errorId = 'uploadError') {
    const errorElement = document.getElementById(errorId);
    if (errorElement) {
        errorElement.innerHTML = message;
        errorElement.style.display = 'block';
    }
}

function showSuccess(message) {
    Swal.fire({
        icon: 'success',
        title: 'Ù†Ø¬Ø­',
        text: message,
        timer: 2000,
        showConfirmButton: false
    });
}

function resetForm() {
    document.getElementById('uploadPolicyForm').reset();
    document.getElementById('orderDetails').style.display = 'none';
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('uploadBtn').disabled = true;
    document.getElementById('extractedOrders').style.display = 'none';
    document.getElementById('pagesPreview').style.display = 'none';
    document.getElementById('togglePreviewBtn').style.display = 'none';
    document.getElementById('uploadSelectedBtn').style.display = 'none';
    selectedOrder = null;
    selectedOrdersFromPDF = [];
    extractedOrders = [];
    
    // ØªØ­Ø±ÙŠØ± Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù…Ù† URLs
    extractedOrders.forEach(order => {
        if (order.imageUrl) {
            URL.revokeObjectURL(order.imageUrl);
        }
    });
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
function normalizeDigits(s) {
    return s ? s.replace(/\D/g, '') : s;
}
</script>
{% endblock %}