{% extends 'base.html' %}
{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/orders.css') }}">

{% endblock %}

{% block content %} 

<div class="card shadow-lg mb-4 border-0">
    <div class="card-header py-3 bg-gradient-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold">
                <i class="fas fa-tasks me-2"></i>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø·Ù„Ø¨Ø§Øª
            </h6>
          <div class="d-flex align-items-center">
    <div id="sync-progress" class="me-3 d-none">
        <div class="progress" style="height: 6px; width: 150px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-white" 
                 role="progressbar" style="width: 0%"></div>
        </div>
        <small class="sync-details text-white-50 mt-1 d-block"></small>
    </div>
  <button class="btn btn-primary btn-sm rounded-pill me-2" id="sync-statuses-btn">
    <i class="fas fa-list-alt me-1"></i>

</button>
<button class="btn btn-primary btn-sm rounded-pill" id="sync-orders-btn">
    <i class="fas fa-sync-alt me-1"></i>
</button>
</div>
        </div>
    </div>
    
    <div class="card-body p-0">
        <div class="p-4 border-bottom">
            <form id="advanced-filters" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="search-order-id" class="form-label small text-muted mb-1">Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹</label>
                    <div class="input-group">
                        <span class="input-group-text bg-transparent"><i class="fas fa-search"></i></span>
                        <input type="text" id="search-order-id" class="form-control border-start-0" 
                               placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨..." value="{{ filters.search }}"
                               data-debounce="500">
                    </div>
                </div>
                {% if is_reviewer %}
                <div class="col-md-2">
                    <label for="filter-order-status" class="form-label small text-muted mb-1">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</label>
                    <select id="filter-order-status" class="form-select">
                        <option value="">Ø§Ù„ÙƒÙ„</option>
                        {% for status in order_statuses %}
                            <option value="{{ status.slug }}" {% if filters.status == status.slug %}selected{% endif %}>
                                {{ status.name }} ({{ status.type }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                {% if is_reviewer %}
                <div class="col-md-2">
                    <label for="filter-employee" class="form-label small text-muted mb-1">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label>
                    <select id="filter-employee" class="form-select">
                        <option value="">Ø§Ù„ÙƒÙ„</option>
                        {% for emp in employees %}
                            <option value="{{ emp.id }}" {% if filters.employee == emp.id|string %}selected{% endif %}>{{ emp.email|truncate(15) }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                
                <div class="col-md-2">
                    <label for="filter-custom-status" class="form-label small text-muted mb-1">Ø­Ø§Ù„Ø© Ù…Ø®ØµØµØ©</label>
                    <select id="filter-custom-status" class="form-select">
                        <option value="">Ø§Ù„ÙƒÙ„</option>
                        {% for status in custom_statuses %}
                            <option value="{{ status.id }}" {% if filters.custom_status == status.id|string %}selected{% endif %}>{{ status.name|truncate(15) }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label for="filter-special-status" class="form-label small text-muted mb-1">Ø­Ø§Ù„Ø§Øª Ø®Ø§ØµØ©</label>
                    <select id="filter-special-status" class="form-select">
                        <option value="">Ø§Ù„ÙƒÙ„</option>
                        <option value="late" {% if filters.status == 'late' %}selected{% endif %}>Ù…ØªØ£Ø®Ø±Ø©</option>
                        <option value="missing" {% if filters.status == 'missing' %}selected{% endif %}>ÙˆØ§ØµÙ„ Ù†Ø§Ù‚Øµ</option>
                        <option value="not_shipped" {% if filters.status == 'not_shipped' %}selected{% endif %}>Ù„Ù… ÙŠØ´Ø­Ù†</option>
                        <option value="refunded" {% if filters.status == 'refunded' %}selected{% endif %}>Ù…Ø±ØªØ¬Ø¹Ø§Øª</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label class="form-label small text-muted mb-1">Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</label>
                    <div class="input-daterange input-group">
                        <input type="date" class="form-control form-control-sm rounded-start" 
                               id="date-from" name="date_from" value="{{ filters.date_from }}">
                        <span class="input-group-text">Ø¥Ù„Ù‰</span>
                        <input type="date" class="form-control form-control-sm rounded-end" 
                               id="date-to" name="date_to" value="{{ filters.date_to }}">
                    </div>
                </div>
                
                <div class="col-md-2 d-flex">
                    <button type="submit" class="btn btn-primary me-2 flex-grow-1">
                        <i class="fas fa-filter me-1"></i> ØªØ·Ø¨ÙŠÙ‚
                    </button>
                    <button type="button" id="reset-filters" class="btn btn-outline-secondary">
                        <i class="fas fa-undo"></i>
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© -->
    <!-- Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© -->
<!-- ÙÙŠ Ù‚Ø³Ù… Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© - Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø²Ø± -->
<!-- ÙÙŠ Ù‚Ø³Ù… Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© -->
<div class="d-flex p-3" class="card-body" id="quick-actions">
    {% if is_reviewer and employees %}
    <button type="button" class="btn btn-success rounded-pill px-3 me-2" id="assign-orders-btn" disabled>
        <i class="fas fa-user-check me-1"></i> 
        <span id="selected-orders-count">0</span> Ø¥Ø³Ù†Ø§Ø¯
    </button>
    {% endif %}
    
    <button type="button" class="btn btn-warning rounded-pill px-3 me-2" id="update-salla-status-btn" disabled>
        <i class="fas fa-sync-alt me-1"></i> 
        <span id="selected-orders-count-salla">0</span> ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø³Ù„Ø©
    </button>
    
    <!-- â­â­ Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯ â­â­ -->
    <button type="button" class="btn btn-dark rounded-pill px-3 me-2" id="print-addresses-btn" disabled>
        <i class="fas fa-map-marker-alt me-1"></i> 
        <span id="selected-orders-count-address">0</span> Ø·Ø¨Ø§Ø¹Ø© Ø¹Ù†Ø§ÙˆÙŠÙ†
    </button>
    
    <button type="button" class="btn btn-primary rounded-pill px-3 me-2" id="download-html-btn" disabled>
        <i class="fas fa-download me-1"></i> 
        <span id="selected-orders-count-html">0</span> ØªØ­Ù…ÙŠÙ„ 
    </button> 

    <button type="button" class="btn btn-info rounded-pill px-3 me-2" id="change-status-btn" disabled>
        <i class="fas fa-tag me-1"></i> 
        <span id="selected-orders-count-2">0</span> ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©
    </button>

    <button type="button" class="btn btn-secondary mb-3" id="quickListViewBtn" disabled>
        <i class="fas fa-eye"></i> Ù‚Ø§Ø¦Ù…Ø© Ø³Ø±ÙŠØ¹Ø©
    </button>
</div>
        {% if orders %}
        <div class="table-responsive position-relative">
            <div id="table-loading" class="position-absolute top-0 start-0 w-100 h-100 bg-white bg-opacity-75 d-flex justify-content-center align-items-center d-none" style="z-index: 10;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                </div>
            </div>
            
            <table class="table table-hover mb-0" id="orders-table">
   <!-- ÙÙŠ Ù‚Ø³Ù… thead -->
<thead class="table">
    <tr>
        <th width="5%" class="ps-4">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="select-all-header">
            </div>
        </th>
        <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
        <th class="d-none d-md-table-cell">Ø§Ù„Ø­Ø§Ù„Ø©</th>
        <th>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®ØµØµØ©</th>
        <!-- â­â­ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ù‡Ù†Ø§ â­â­ -->
        <th class="d-none d-lg-table-cell">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
        <th>Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª</th>
        <th class="d-none d-md-table-cell">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        {% if is_reviewer %}
        <th class="d-none d-md-table-cell">Ø§Ù„Ù…Ø³Ù†Ø¯ Ø¥Ù„ÙŠÙ‡</th>
        {% endif %}
        <th width="15%" class="text-end pe-4">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
    </tr>
</thead>
             <tbody>
    {% for order in orders %}
    <tr data-order-id="{{ order.id }}" data-order-type="{{ order.type }}" data-order-status="{{ order.status.slug if order.status else 'unknown' }}" class="align-middle clickable-row">
        <td class="ps-4">
            <div class="form-check">
                <input type="checkbox" class="form-check-input order-checkbox" value="{{ order.id }}" data-type="{{ order.type }}">
            </div>
        </td>
        <td>
            <span class="fw-bold">#{{ order.reference_id }}</span>
        </td>
        <td class="d-none d-md-table-cell">
            {% if order.status %}
                <span class="status-badge status-{{ order.status.slug }}" 
                      data-bs-toggle="tooltip" 
                      title="{{ order.status.name }} ({{ order.status.type }})">
                    <i class="fas fa-circle me-1 small"></i>
                    {{ order.status.name }}
                </span>
            {% else %}
                <span class="status-badge status-unknown" data-bs-toggle="tooltip" title="Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©">
                    <i class="fas fa-circle me-1 small"></i>
                    ØºÙŠØ± Ù…Ø­Ø¯Ø¯
                </span>
            {% endif %}
        </td>
        <td>
            {% if order.employee_statuses %}
                {% set last_custom_status = order.employee_statuses | sort(attribute='created_at', reverse=true) | first %}
                <span class="badge rounded-pill" style="background-color: {{ last_custom_status.status.color }}; color: white">
                    {{ last_custom_status.status.name }}
                </span>
            {% else %}
                <span class="text-muted small">-</span>
            {% endif %}
        </td>
        <!-- â­â­ Ø¥Ø¶Ø§ÙØ© Ø®Ù„ÙŠØ© Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ù‡Ù†Ø§ â­â­ -->
        <td class="d-none d-lg-table-cell">
            {% if order.payment_method %}
                {% set payment_class = "payment-" + (order.payment_method.replace('_', '-') if order.payment_method else 'unknown') %}
                <span class="payment-method-badge {{ payment_class }}" data-bs-toggle="tooltip" title="{{ order.payment_method_name }}">
                    {% if order.payment_method == 'tabby_installment' %}
                        <i class="fas fa-credit-card payment-icon"></i>ØªØ§Ø¨ÙŠ
                    {% elif order.payment_method == 'mada' %}
                        <i class="fas fa-credit-card payment-icon"></i>Ù…Ø¯Ù‰
                    {% elif order.payment_method == 'visa' or order.payment_method == 'mastercard' %}
                        <i class="fab fa-cc-visa payment-icon"></i>Ø¨Ø·Ø§Ù‚Ø©
                    {% elif order.payment_method == 'cash' %}
                        <i class="fas fa-money-bill-wave payment-icon"></i>Ù†Ù‚Ø¯ÙŠ
                    {% elif order.payment_method == 'bank' %}
                        <i class="fas fa-university payment-icon"></i>Ø¨Ù†ÙƒÙŠ
                    {% else %}
                        <i class="fas fa-wallet payment-icon"></i>{{ order.payment_method_name|default('ØºÙŠØ± Ù…Ø­Ø¯Ø¯', true)|truncate(10) }}
                    {% endif %}
                </span>
            {% else %}
                <span class="payment-method-badge payment-unknown" data-bs-toggle="tooltip" title="Ø·Ø±ÙŠÙ‚Ø© Ø¯ÙØ¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©">
                    <i class="fas fa-wallet payment-icon"></i>ØºÙŠØ± Ù…Ø­Ø¯Ø¯
                </span>
            {% endif %}
        </td>
        <td>
            {% set last_note = order.status_notes | sort(attribute='created_at', reverse=true) | first %}

    {% if last_note %}
        <div class="d-flex align-items-center">
            {% if last_note.custom_status %}
                <!-- Ø­Ø§Ù„Ø© Ù…Ø®ØµØµØ© Ù…Ø¹ Ù„ÙˆÙ† Ù…Ø®ØµØµ -->
                <span class="badge rounded-pill me-1" 
                      style="background-color: {{ last_note.custom_status.color }}; color: white">
                    {{ last_note.custom_status.name }}
                </span>
            {% elif last_note.status_flag %}
                <!-- Ø­Ø§Ù„Ø© Ø®Ø§ØµØ© (status_flag) -->
                {% set flag_class = "badge-" + last_note.status_flag %}
                {% set flag_text = {
                    'late': 'Ù…ØªØ£Ø®Ø±',
                    'missing': 'ÙˆØ§ØµÙ„ Ù†Ø§Ù‚Øµ',
                    'refunded': 'Ù…Ø±ØªØ¬Ø¹',
                    'not_shipped': 'Ù„Ù… ÙŠØ´Ø­Ù†'
                }.get(last_note.status_flag, last_note.status_flag) %}
                <span class="badge {{ flag_class }} fw-normal me-1">{{ flag_text }}</span>
            {% endif %} 
        </div>
    {% else %}
        <span class="text-muted small">-</span>
    {% endif %}
</td>
                        <td class="d-none d-md-table-cell">
                            <span class="time-ago small" data-bs-toggle="tooltip" title="{{ order.raw_created_at|format_date }}">
                                {{ order.created_at }}
                            </span>
                        </td>
                        {% if is_reviewer %}
                        <td class="d-none d-md-table-cell">
                            {% if order.assignments %} 
                                <div class="avatar-group">
                                    {% for assignment in order.assignments[:3] %}
                                        {% if assignment.employee.role == 'delivery' %}
                                            <div class="avatar avatar-xs" data-bs-toggle="tooltip" 
                                                 title="{{ assignment.employee.email }} (Ù…Ù†Ø¯ÙˆØ¨ ØªÙˆØµÙŠÙ„)">
                                                <span class="avatar-text bg-success text-white">
                                                    {{ assignment.employee.email|first|upper }}
                                                </span>
                                            </div>
                                        {% else %}
                                            <div class="avatar avatar-xs" data-bs-toggle="tooltip" 
                                                 title="{{ assignment.employee.email }} (Ù…ÙˆØ¸Ù Ø¹Ø§Ù…)">
                                                <span class="avatar-text bg-primary text-white">
                                                    {{ assignment.employee.email|first|upper }}
                                                </span>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                    {% if order.assignments|length > 3 %}
                                        <div class="avatar avatar-xs" data-bs-toggle="tooltip" 
                                             title="Ùˆ {{ order.assignments|length - 3 }} Ø£ÙƒØ«Ø±">
                                            <span class="avatar-text t text-dark">
                                                +{{ order.assignments|length - 3 }}
                                            </span>
                                        </div>
                                    {% endif %}
                                </div>
                            {% else %}
                                <span class="badge  text-muted">ØºÙŠØ± Ù…Ø³Ù†Ø¯</span>
                            {% endif %}
                        </td>
                        {% endif %}
                        <td class="text-end pe-4 actions-cell">
                            <div class="d-flex justify-content-end gap-2">
                                {% if order.type == 'custom' %}
                                    <a href="{{ url_for('orders.custom_order_details', order_id=order.id) }}"
                                       class="btn btn-sm btn-icon btn-outline-primary rounded-circle"
                                       title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                {% else %}
                                    <a href="{{ url_for('orders.order_details', order_id=order.id) }}"
                                       class="btn btn-sm btn-icon btn-outline-primary rounded-circle"
                                       title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                {% endif %}
                                
                                {% if is_reviewer %}
                                <button class="btn btn-sm btn-icon btn-outline-success rounded-circle assign-single-btn" 
                                        data-order-id="{{ order.id }}" 
                                        data-order-type="{{ order.type }}" 
                                        title="Ø¥Ø³Ù†Ø§Ø¯ Ø³Ø±ÙŠØ¹">
                                    <i class="fas fa-user-plus"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-between align-items-center p-4 border-top">
            <div class="d-flex align-items-center">
                <span class="text-muted small me-3">Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„ÙƒÙ„ ØµÙØ­Ø©:</span>
   <select class="form-select form-select-sm w-auto" id="per-page-select">
                    <option value="10" {% if pagination.per_page == 10 %}selected{% endif %}>10</option>
                    <option value="25" {% if pagination.per_page == 25 %}selected{% endif %}>25</option>
                    <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100</option>
                                        <option value="125" {% if pagination.per_page == 125 %}selected{% endif %}>125</option>
                                                            <option value="150" {% if pagination.per_page == 150 %}selected{% endif %}>150</option>
                </select
            </div>
            
           <div class="d-flex flex-column align-items-end">
    <nav aria-label="Page navigation">
        <ul class="pagination pagination-sm justify-content-center mb-1">
            {% if pagination.has_prev %}
            <li class="page-item">
                <a class="page-link" href="?page={{ pagination.prev_page }}&per_page={{ pagination.per_page }}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.employee %}&employee={{ filters.employee }}{% endif %}{% if filters.custom_status %}&custom_status={{ filters.custom_status }}{% endif %}{% if filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_to %}&date_to={{ filters.date_to }}{% endif %}{% if filters.search %}&search={{ filters.search }}{% endif %}{% if filters.order_type %}&order_type={{ filters.order_type }}{% endif %}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled"><a class="page-link" href="#"><i class="fas fa-chevron-right"></i></a></li>
            {% endif %}
            
            {% set start_page = [1, pagination.page - 2]|max %}
            {% set end_page = [pagination.total_pages, pagination.page + 2]|min %}
            {% for p in range(start_page, end_page + 1) %}
                <li class="page-item {% if p == pagination.page %}active{% endif %}">
                    <a class="page-link" href="?page={{ p }}&per_page={{ pagination.per_page }}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.employee %}&employee={{ filters.employee }}{% endif %}{% if filters.custom_status %}&custom_status={{ filters.custom_status }}{% endif %}{% if filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_to %}&date_to={{ filters.date_to }}{% endif %}{% if filters.search %}&search={{ filters.search }}{% endif %}{% if filters.order_type %}&order_type={{ filters.order_type }}{% endif %}">
                        {{ p }}
                    </a>
                </li>
            {% endfor %}

            {% if pagination.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ pagination.next_page }}&per_page={{ pagination.per_page }}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.employee %}&employee={{ filters.employee }}{% endif %}{% if filters.custom_status %}&custom_status={{ filters.custom_status }}{% endif %}{% if filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_to %}&date_to={{ filters.date_to }}{% endif %}{% if filters.search %}&search={{ filters.search }}{% endif %}{% if filters.order_type %}&order_type={{ filters.order_type }}{% endif %}">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled"><a class="page-link" href="#"><i class="fas fa-chevron-left"></i></a></li>
            {% endif %}
        </ul>
    </nav>
    <div class="text-muted small">
        Ø¹Ø±Ø¶ {{ pagination.start_item }}-{{ pagination.end_item }} Ù…Ù† {{ pagination.total_items }}
    </div>
</div>
            </div>
        </div>

        {% else %}
        <div class="text-center py-5">
            <div class="mb-4">
                <i class="fas fa-shopping-bag fa-4x text-gray-300"></i>
            </div>
            <h4 class="mb-3 text-gray-600">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</h4>
            <p class="text-muted mb-4">
                Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ.
            </p>
            <button type="button" class="btn btn-primary rounded-pill px-4" id="reset-filters-btn">
                <i class="fas fa-undo me-2"></i>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø§Ù„Ø© -->
<div class="modal fade" id="changeStatusModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¹Ù„Ù‰ <span id="selected-count-modal" class="fw-bold">0</span> Ø·Ù„Ø¨.</p>
                
                <div class="mb-3">
                    <label for="status-select" class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                    <select class="form-select" id="status-select">
                        <option value="">Ø§Ø®ØªØ± Ø­Ø§Ù„Ø©...</option>
                        {% for status in custom_statuses %}
                        <option value="{{ status.id }}" style="color: {{ status.color }}">{{ status.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="status-note" class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                    <textarea class="form-control" id="status-note" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-primary" id="confirm-status-change">ØªØ£ÙƒÙŠØ¯</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="quickListModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="selectAllQuickList" checked>
                    <label class="form-check-label fw-bold" for="selectAllQuickList">
                        ØªØ­Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                    </label>
                    <span class="text-muted ms-2" id="selectedOrdersCountQuick">0 Ø·Ù„Ø¨ Ù…Ø­Ø¯Ø¯</span>
                </div>
                
                <div id="quickListContent">
                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‡Ù†Ø§ Ø¹Ø¨Ø± JavaScript -->
                </div>
                
                <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© - Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù‡Ù†Ø§ -->
                <div class="mt-4 pt-3 border-top">
                    <h6 class="mb-3"><i class="fas fa-cogs me-2"></i>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</h6>
                    <div class="row">
                        {% if is_reviewer and employees %}
                        <div class="col-md-6 mb-2">
                            <label for="quickListAssignSelect" class="form-label small">Ø§Ø®ØªØ± Ù…ÙˆØ¸ÙÙ‹Ø§ Ù„Ù„Ø¥Ø³Ù†Ø§Ø¯:</label>
                            <select class="form-select mb-2" id="quickListAssignSelect">
                                <option value="">Ø§Ø®ØªØ± Ù…ÙˆØ¸ÙÙ‹Ø§...</option>
                                {% for employee in employees %}
                                    {% if employee.role == 'general' %}
                                    <option value="{{ employee.id }}">{{ employee.email }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-primary w-100" id="quickListAssignBtn">
                                <i class="fas fa-user-plus me-1"></i> Ø¥Ø³Ù†Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
                            </button>
                        </div>
                        {% endif %}
                        
                        <div class="col-md-6 mb-2">
                            <label class="form-label small">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©:</label>
                            <button type="button" class="btn btn-warning w-100" id="quickListPrintBtn">
                                <i class="fas fa-print me-1"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
                            </button>
                        </div>
                        
                        <div class="col-md-6 mb-2">
                            <button type="button" class="btn btn-info w-100" id="quickListChangeStatusBtn">
                                <i class="fas fa-tag me-1"></i> ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                            </button>
                        </div>
                        
                        <div class="col-md-6 mb-2">
                            <button type="button" class="btn btn-success w-100" id="quickListDownloadBtn">
                                <i class="fas fa-download me-1"></i> ØªØ­Ù…ÙŠÙ„ ÙƒÙ€ PDF
                            </button>
                                <button type="button" class="btn btn-outline-secondary w-100" id="toggleAllOrdersBtn">
        <i class="fas fa-eye me-1"></i> Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>
</div>
    </div>
</div>
<!-- Ù†Ø§ÙØ°Ø© ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø³Ù„Ø© -->
<!-- Ù†Ø§ÙØ°Ø© ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø³Ù„Ø© -->
<div class="modal fade" id="updateSallaStatusModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ø³Ù„Ø©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ù…Ù†ØµØ© Ø³Ù„Ø© Ù„Ù€ <span id="selected-count-salla-modal" class="fw-bold">0</span> Ø·Ù„Ø¨.</p>
                
   <div class="mb-3">
    <label for="salla-status-select" class="form-label">Ø§Ø®ØªØ± Ø­Ø§Ù„Ø© Ø³Ù„Ø©:</label>
    <select class="form-select" id="salla-status-select">
        <option value="">Ø§Ø®ØªØ± Ø­Ø§Ù„Ø©...</option>
        
        <!-- Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù…Ù† Ø³Ù„Ø© -->
        <optgroup label="ğŸ›’ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù…Ù† Ø³Ù„Ø©">
            {% for status in order_statuses %}
                {% if status.type == 'original' and status.is_active %}
                    <option value="{{ status.slug }}" 
                            data-bs-toggle="tooltip" 
                            title="{{ status.name }} - {{ status.type }}">
                        {{ status.name }}
                    </option>
                {% endif %}
            {% endfor %}
        </optgroup> 
        
        <!-- Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ© (Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª ØªØ¶Ù…ÙŠÙ†Ù‡Ø§) -->
        <optgroup label="âš™ï¸ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ©">
            {% for status in order_statuses %}
                {% if status.type == 'custom' and status.is_active %}
                    <option value="{{ status.slug }}" 
                            data-bs-toggle="tooltip" 
                            title="{{ status.name }} - {{ status.type }}">
                        {{ status.name }} (Ù…Ø®ØµØµ)
                    </option>
                {% endif %}
            {% endfor %}
        </optgroup>
        
    </select>
    <div class="form-text">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø­Ø§Ù„Ø§Øª Ø³Ù„Ø©</div>
</div>
                <div class="mb-3">
                    <label for="salla-status-note" class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                    <textarea class="form-control" id="salla-status-note" rows="2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© ØªØ¸Ù‡Ø± ÙÙŠ Ø³Ù„Ø©..."></textarea>
                </div>
                
                <div class="alert alert-info">
                    <small>
                        <i class="fas fa-info-circle me-1"></i>
                        Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ù…Ù†ØµØ© Ø³Ù„Ø© ÙˆÙ‚Ø¯ ØªØ³ØªØºØ±Ù‚ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†Ù.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-warning" id="confirm-salla-status-update">
                    <i class="fas fa-sync-alt me-1"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
                </button>
            </div>
        </div>
    </div>
</div>
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js" integrity="sha384-DpVxUeeBWjUvUV1czyIHJAjh+jYUZFu2lLakbdua5vbwOrBGi1UgaKCHjTC+x3Ky" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js" integrity="sha384-ssUzPQXjLHLO39a9AiuwxnnyDxIvOMUxEQpqfreUaW7jLEdDAXiF6UooZRO53F6Z" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/ar.js" integrity="sha384-WOFOhfe03USRUKDbteptsFbkQE1Sisvl6Amq1jey7Pwrbr//TWZ676qtUweo1usp" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" integrity="sha384-ms4yaO2qHEUIRbq8CXAqtz3qhnO7nYo/xAWv23Zx/iX9tT+nvVZP66kSXwT/7a0J" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js" integrity="sha384-H6KKS1H1WwuERMSm+54dYLzjg0fKqRK5ZRyASdbrI/lwrCc6bXEmtGYr5SwvP1pZ" crossorigin="anonymous"></script>

<script>
$(document).ready(function () {
    // --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ---
    const csrfToken = "{{ csrf_token() }}";
    let currentSelectedOrders = [];
    
    // --- ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª ---
    dayjs.extend(dayjs_plugin_relativeTime);
    dayjs.locale('ar');
    
    // --- ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Øª ---
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // --- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ---
    function updateTimestamps() {
        document.querySelectorAll('.time-ago').forEach(el => {
            const dateStr = el.getAttribute('title');
            if (dateStr) {
                el.textContent = dayjs(dateStr).fromNow();
            }
        });
    }

    function showSweetAlert(icon, title, text = '', timer = 3000) {
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: timer,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });
        
        Toast.fire({
            icon: icon,
            title: title,
            text: text
        });
    }
    
    function showConfirmDialog(title, text, confirmText, cancelText) {
        return Swal.fire({
            title: title,
            text: text,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: confirmText,
            cancelButtonText: cancelText,
            customClass: {
                confirmButton: 'btn btn-primary',
                cancelButton: 'btn btn-outline-secondary ms-2'
            },
            buttonsStyling: false
        });
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© updateAssignButtonState
function updateAssignButtonState() {
    const checkedCount = $('.order-checkbox:checked').length;
    $('#selected-orders-count').text(checkedCount);
    $('#selected-orders-count-2').text(checkedCount);
    $('#selected-orders-count-html').text(checkedCount);
    $('#selected-orders-count-salla').text(checkedCount);
    $('#selected-orders-count-address').text(checkedCount); // â­ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    
    const buttons = $('#assign-orders-btn, #change-status-btn, #download-html-btn, #quickListViewBtn, #update-salla-status-btn, #print-addresses-btn');
    buttons.prop('disabled', checkedCount === 0);
    
    if (checkedCount > 0) {
        buttons.addClass('pulse-effect');
        setTimeout(() => buttons.removeClass('pulse-effect'), 1000);
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
$(document).on('click', '#print-addresses-btn', function() {
    const selectedOrders = $('.order-checkbox:checked').map((_, el) => $(el).val()).get();
    
    if (selectedOrders.length === 0) {
        showSweetAlert('warning', 'ØªØ­Ø°ÙŠØ±', 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†');
        return;
    }
    
    Swal.fire({
        title: 'Ø·Ø¨Ø§Ø¹Ø© Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø·Ù„Ø¨Ø§Øª',
        html: `Ø³ÙŠØªÙ… Ø·Ø¨Ø§Ø¹Ø© Ø¹Ù†Ø§ÙˆÙŠÙ† <span class="fw-bold text-primary">${selectedOrders.length}</span> Ø·Ù„Ø¨ Ù…Ø¹ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯`,
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'Ù…ÙˆØ§ÙÙ‚ØŒ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        customClass: {
            confirmButton: 'btn btn-dark',
            cancelButton: 'btn btn-outline-secondary ms-2'
        },
        buttonsStyling: false
    }).then((result) => {
        if (result.isConfirmed) {
            const printBtn = $('#print-addresses-btn');
            const originalText = printBtn.html();
            printBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²');
            
            // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
            const previewUrl = `{{ url_for('orders.preview_addresses_html') }}?order_ids=${selectedOrders.join(',')}`;
            const previewWindow = window.open(previewUrl, '_blank');
            
            setTimeout(() => {
                printBtn.prop('disabled', false).html(originalText);
            }, 2000);
        }
    });
});

// Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± ØªØ­Ù…ÙŠÙ„ PDF Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
$(document).on('click', '#quickListDownloadAddressesBtn', function() {
    const selectedOrders = [];
    
    $('#quickListContent input.quick-list-order:checked').each(function() {
        const orderId = $(this).data('order-id');
        if (!selectedOrders.includes(orderId)) {
            selectedOrders.push(orderId);
        }
    });

    if (selectedOrders.length === 0) {
        showSweetAlert('warning', 'ØªØ­Ø°ÙŠØ±', 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†');
        return;
    }

    const downloadBtn = $('#quickListDownloadAddressesBtn');
    const originalText = downloadBtn.html();
    downloadBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²');

    const downloadLink = document.createElement('a');
    downloadLink.href = `{{ url_for('orders.download_addresses_pdf') }}?order_ids=${selectedOrders.join(',')}`;
    downloadLink.style.display = 'none';
    downloadLink.target = '_blank';
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);

    setTimeout(() => {
        downloadBtn.prop('disabled', false).html(originalText);
        showSweetAlert('success', 'ØªÙ… Ø§Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„', 'Ø³ÙŠØ¨Ø¯Ø£ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø¹Ù†Ø§ÙˆÙŠÙ† PDF Ù‚Ø±ÙŠØ¨Ø§Ù‹');
    }, 1000);
});

    function buildQueryParams() {
        const params = new URLSearchParams();
        
        const status = $('#filter-order-status').val();
        const search = $('#search-order-id').val();
        const dateFrom = $('#date-from').val();
        const dateTo = $('#date-to').val();
        const perPage = $('#per-page-select').val();
        
        if (status) params.set('status', status);
        if (search) params.set('search', search);
        if (dateFrom) params.set('date_from', dateFrom);
        if (dateTo) params.set('date_to', dateTo);
        if (perPage) params.set('per_page', perPage);
        
        {% if is_reviewer %}
        const employee = $('#filter-employee').val();
        if (employee) params.set('employee', employee);
        {% endif %}
        
        const customStatus = $('#filter-custom-status').val();
        if (customStatus) params.set('custom_status', customStatus);
        
        {% if not is_reviewer %}
        const specialStatus = $('#filter-special-status').val();
        if (specialStatus) params.set('status', specialStatus);
        {% endif %}
        
        return params.toString();
    }
    
    function reloadOrders(showLoading = true) {
        if (showLoading) {
            $('#table-loading').removeClass('d-none');
        }
        
        const queryParams = buildQueryParams();
        window.location.href = `?${queryParams}`;
    }
    
    function toggleQuickListButton() {
        const selectedOrders = document.querySelectorAll('input.order-checkbox:checked');
        document.getElementById('quickListViewBtn').disabled = selectedOrders.length === 0;
    }
    
    function updateQuickListSelectionCount() {
        const selectedCount = document.querySelectorAll('#quickListContent input.quick-list-order:checked').length;
        const totalOrders = document.querySelectorAll('#quickListContent input.quick-list-order').length;
        
        document.getElementById('selectedOrdersCountQuick').textContent = `${selectedCount} Ø·Ù„Ø¨ Ù…Ø­Ø¯Ø¯ Ù…Ù† ${totalOrders}`;

        const buttons = ['quickListAssignBtn', 'quickListPrintBtn', 'quickListChangeStatusBtn', 'quickListDownloadBtn'];
        
        buttons.forEach(btnId => {
            const button = document.getElementById(btnId);
            if (button) {
                button.disabled = selectedCount === 0;
            }
        });

        const selectAll = document.getElementById('selectAllQuickList');
        if (selectAll && totalOrders > 0) {
            selectAll.checked = selectedCount === totalOrders;
            selectAll.indeterminate = selectedCount > 0 && selectedCount < totalOrders;
        }
    }
    
    function syncData(url, successMessage, errorMessage) {
        const btn = $(this);
        const icon = btn.find('i');
        const progressContainer = $('#sync-progress');
        const progressBar = progressContainer.find('.progress-bar');
        const detailsText = progressContainer.find('.sync-details');

        btn.prop('disabled', true);
        icon.addClass('fa-spin');
        progressContainer.removeClass('d-none');
        progressBar.css('width', '10%');
        detailsText.text('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…...');

        progressBar.animate({ width: "70%" }, 1500);

        $.ajax({
            url: url,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({}),
            headers: { 'X-CSRFToken': csrfToken }
        })
        .done(function(response) {
            progressBar.css('width', '100%');
            if (response.success) {
                detailsText.text(response.message);
                showSweetAlert('success', successMessage, response.message);
                setTimeout(() => location.reload(), 2000);
            } else {
                showSweetAlert('error', errorMessage, response.error, 5000);
                btn.prop('disabled', false);
                icon.removeClass('fa-spin');
                progressContainer.addClass('d-none');
            }
        })
        .fail(function(xhr) {
            progressBar.css('width', '100%');
            const errorMsg = xhr.responseJSON?.error || 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ø¨ÙƒØ©.';
            showSweetAlert('error', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙØ§Ø¯Ø­', errorMsg, 5000);
            btn.prop('disabled', false);
            icon.removeClass('fa-spin');
            progressContainer.addClass('d-none');
        });
    }
    
    function assignOrders(employeeId, orders) {
        return $.ajax({
            url: "{{ url_for('orders.assign_orders') }}",
            type: "POST",
            contentType: "application/json",
            headers: { 'X-CSRFToken': csrfToken },
            data: JSON.stringify({
                employee_id: employeeId,
                orders: orders,
                current_user_id: "{{ session.get('user_id') }}"
            })
        });
    } 
    
    function getSelectedOrders() {
        return $('.order-checkbox:checked').map((_, el) => {
            const checkbox = $(el);
            const orderId = checkbox.val();
            const row = checkbox.closest('tr');
            const orderType = row.data('order-type') || 'salla';
            
            if (!orderId || orderId === 'None') {
                console.error('âŒ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù€ checkbox ØºÙŠØ± ØµØ§Ù„Ø­Ø©:', orderId);
                return null;
            }
            
            return {
                id: orderId,
                type: orderType
            };
        }).get().filter(order => order !== null);
    }
    
    function collectQuickListPrintData() {
        const productsMap = new Map();
        let totalOrders = 0;
        let totalQuantity = 0;
        let totalItems = 0;

        console.log('ğŸ”„ ØªØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©...');

        $('.product-card').each(function() {
            const $card = $(this);
            const sku = $card.data('product-sku');
            
            if (!sku) {
                console.warn('âš ï¸ Ù…Ù†ØªØ¬ Ø¨Ø¯ÙˆÙ† SKU:', $card);
                return;
            }

            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            if (!productsMap.has(sku)) {
                const productName = $card.find('h6').text().trim();
                const mainImage = $card.find('img').attr('src') || '/static/images/no-image.png';
                
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø³Ø¹Ø±
                let price = 0;
                const priceText = $card.find('.badge.bg-warning').text();
                if (priceText && priceText.includes('Ø§Ù„Ø³Ø¹Ø±:')) {
                    const priceMatch = priceText.match(/Ø§Ù„Ø³Ø¹Ø±:\s*([\d.,]+)/);
                    if (priceMatch) {
                        price = parseFloat(priceMatch[1].replace(',', '')) || 0;
                    }
                }
                
                productsMap.set(sku, {
                    sku: sku,
                    name: productName,
                    thumbnail: mainImage,
                    price: price,
                    total_quantity: 0,
                    orders: []
                });
            }

            const product = productsMap.get(sku);

            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            $card.find('.order-appearance').each(function() {
                const $appearance = $(this);
                const $checkbox = $appearance.find('input.quick-list-order');
                
                if (!$checkbox.is(':checked')) {
                    console.log('â­ï¸ ØªØ®Ø·ÙŠ Ø·Ù„Ø¨ ØºÙŠØ± Ù…Ø­Ø¯Ø¯:', $appearance.find('.form-check-label').text());
                    return;
                }

                const orderId = $checkbox.data('order-id');
                const referenceId = $appearance.find('.form-check-label').text()
                    .replace('Ø§Ù„Ø·Ù„Ø¨ #', '').trim();

                if (!orderId || !referenceId) {
                    console.warn('âš ï¸ Ø·Ù„Ø¨ Ø¨Ø¯ÙˆÙ† Ù…Ø¹Ø±Ù:', $appearance);
                    return;
                }

                // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                const orderData = {
                    id: orderId,
                    reference_id: referenceId,
                    customer_name: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                    customer_mobile: '',
                    created_at: '',
                    quantity: 1,
                    options: [],
                    barcode: `Ø¨Ø§Ø±ÙƒÙˆØ¯_${referenceId}`,
                    notes: ''
                };

                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Øµ
                $appearance.find('small').each(function() {
                    const text = $(this).text().trim();
                    if (text.includes('Ø§Ù„Ø¹Ù…ÙŠÙ„:')) {
                        orderData.customer_name = text.replace('Ø§Ù„Ø¹Ù…ÙŠÙ„:', '').trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    }
                    if (text.includes('Ø§Ù„Ø¬ÙˆØ§Ù„:')) {
                        orderData.customer_mobile = text.replace('Ø§Ù„Ø¬ÙˆØ§Ù„:', '').trim();
                    }
                    if (text.includes('Ø§Ù„ØªØ§Ø±ÙŠØ®:')) {
                        orderData.created_at = text.replace('Ø§Ù„ØªØ§Ø±ÙŠØ®:', '').trim();
                    }
                    if (text.includes('Ø§Ù„ÙƒÙ…ÙŠØ©:')) {
                        const qtyText = text.replace('Ø§Ù„ÙƒÙ…ÙŠØ©:', '').trim();
                        orderData.quantity = parseInt(qtyText) || 1;
                    }
                });

                // Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
                // Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª - Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ­Ø­
$appearance.find('.options-section .badge').each(function() {
    const $badge = $(this);
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… html() Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† text() Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø·
    const optionHtml = $badge.html().trim();
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®ÙŠØ§Ø± ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø·ØŒ Ù†ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡ Ø¨Ø´ÙƒÙ„ Ù…Ø®ØªÙ„Ù
    if ($badge.find('a').length > 0) {
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ø°Ø§ ÙˆØ¬Ø¯
        const linkText = $badge.find('a').text().trim();
        const linkHref = $badge.find('a').attr('href') || '';
        
        orderData.options.push({
            name: 'Ø±Ø§Ø¨Ø·',
            value: linkText,
            href: linkHref,
            is_link: true
        });
    } else if (optionHtml.includes(':')) {
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
        const parts = optionHtml.split(':');
        if (parts.length >= 2) {
            const name = parts[0].trim();
            const value = parts.slice(1).join(':').trim();
            orderData.options.push({
                name: name,
                value: value,
                is_link: false
            });
        }
    } else {
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù†Ù‚Ø·ØªÙŠÙ†ØŒ Ù†Ø¹ØªØ¨Ø±Ù‡ Ù‚ÙŠÙ…Ø© ÙˆØ§Ø­Ø¯Ø©
        orderData.options.push({
            name: 'Ø®ÙŠØ§Ø±',
            value: optionHtml,
            is_link: false
        });
    }
});
                // Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                const $notes = $appearance.find('.notes-section .notes-text');
                if ($notes.length) {
                    orderData.notes = $notes.text().trim();
                }

                // Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
                const barcodeData = $appearance.data('barcode');
                if (barcodeData) {
                    orderData.barcode = barcodeData;
                }

                product.orders.push(orderData);
                product.total_quantity += orderData.quantity;
                totalQuantity += orderData.quantity;
                totalOrders++;
                totalItems++;
                
                console.log(`âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ #${referenceId} Ù„Ù„Ù…Ù†ØªØ¬ ${sku}`);
            });
        });

        const products = Array.from(productsMap.values()).filter(product => product.orders.length > 0);

        console.log('ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:', {
            products: products.length,
            orders: totalOrders,
            quantity: totalQuantity,
            items: totalItems
        });

        return {
            products: products,
            summary: {
                totalProducts: products.length,
                totalOrders: totalOrders,
                totalQuantity: totalQuantity,
                totalItems: totalItems
            }
        };
    }

    /**
     * Ø¥Ù†Ø´Ø§Ø¡ HTML Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
     */
function generatePrintHTML(printData) {
    const timestamp = new Date().toLocaleDateString('ar-SA', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
    });
    
    return `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© - ${timestamp}</title>
    <style>
        @page {
            size: A4;
            margin: 0.8cm;
            marks: crop cross;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        body {
            font-family: "Segoe UI", "DejaVu Sans", Arial, sans-serif;
            line-height: 1.4;
            margin: 0;
            padding: 15px;
            color: #2c3e50;
            background: #f4f7f9;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }

        .print-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .print-header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .summary-card h3 {
            margin: 0;
            font-size: 24px;
            color: #667eea;
            font-weight: 700;
        }

        .summary-card p {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .orders-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .order-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            page-break-inside: avoid;
            break-inside: avoid;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            position: relative;
        }

        .order-header {
            display: flex;
            align-items: stretch;
            gap: 12px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            margin-bottom: 8px;
            min-height: 85px;
        }

        .product-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            width: 80px;
        }

        .product-image {
            width: 70px;
            height: 70px;
            border-radius: 6px;
            object-fit: cover;
            border: 1px solid #ddd;
            -webkit-user-select: none;
            user-select: none;
        }

        .order-details {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            width: 100%;
        }

        .barcode-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            padding: 5px;
            min-height: 85px;
        }

        .barcode-image {
            width: 100%;
            height: 100%;
            max-height: 80px;
            object-fit: contain;
            -webkit-user-select: none;
            user-select: none;
        }

        /* Ø±Ø§Ø¨Ø· Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ - Ù…Ø­Ø³Ù† Ù„Ù„Ù†Ø³Ø® */
        .order-ref-link {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            display: block;
            letter-spacing: 0.5px;
            text-decoration: none;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s ease;
            -webkit-user-select: text;
            user-select: text;
            text-align: center;
            width: 100%;
        }

        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù„Ù„Ø±Ø§Ø¨Ø· */
        .order-ref-link::selection {
            background: #b3d7ff;
            color: #000;
        }

        .order-ref-link::-moz-selection {
            background: #b3d7ff;
            color: #000;
        }

        .order-quantity {
            background: #2c3e50;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 13px;
            display: inline-block;
            font-weight: 600;
            text-align: center;
            width: fit-content;
        }

        .options-section, .notes-section {
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 13px;
        }

        .options-section {
            background: #e9f5ff;
            border: 1px solid #b3d7ff;
        }

        .notes-section {
            background: #fffbe6;
            border: 1px solid #ffeccd;
        }

        .options-title, .notes-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .option-item {
            display: block;
            background: white;
            padding: 3px 8px;
            margin-bottom: 3px;
            border-radius: 4px;
            font-size: 13px;
            border: 1px solid #e0e0e0;
        }

        .no-data {
            text-align: center;
            padding: 50px;
            color: #6c757d;
            background: #fff;
            border-radius: 8px;
            grid-column: 1 / -1;
        }

        /* ØªØ£Ø«ÙŠØ±Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ© Ù„Ù„Ø±Ø§Ø¨Ø· */
        @media (hover: hover) {
            .order-ref-link:hover {
                background: #f0f8ff;
                color: #0066cc;
                text-decoration: underline;
            }
        }

        /* Ù†Ø³Ø®Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø© */
        @media print {
            body {
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                color: #000000 !important;
                font-family: "Arial", "Helvetica", sans-serif !important;
                font-size: 12pt !important;
                line-height: 1.3 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }



    .link-option .option-link {
        color: #000000 !important;
        text-decoration: underline !important;
        pointer-events: none !important; /* ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù†Ù‚Ø± ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
    }
    
    /* Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ÙƒØ§Ù…Ù„ ÙƒÙ†Øµ ØµØºÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª */
    .link-option .option-link:after {
        content: " (" attr(href) ")";
        font-size: 8pt !important;
        color: #666 !important;
        text-decoration: none !important;
        word-break: break-all !important;
    }
    
    /* Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ø­ØªÙØ§Ø¸ ÙÙ‚Ø· Ø¨Ø§Ù„Ù…Ø®ØªØµØ±ØŒ Ø§Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ Ø£Ø¹Ù„Ø§Ù‡ */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                text-rendering: optimizeLegibility !important;
                color-adjust: exact !important;
            }

            /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
            .order-ref-link {
                color: #000000 !important;
                text-decoration: none !important;
                font-weight: bold !important;
                background: transparent !important;
                -webkit-user-select: text !important;
                user-select: text !important;
                cursor: text !important;
                font-size: 12pt !important;
            }

            .print-header {
                display: block !important;
                background: #ffffff !important;
                color: #000000 !important;
                box-shadow: none !important;
                border: 2px solid #000000 !important;
                padding: 15px !important;
                margin-bottom: 15px !important;
                page-break-after: avoid;
            }
            
            .summary-grid {
                display: grid !important;
                background: white !important;
                margin-bottom: 15px !important;
                page-break-after: avoid;
            }
            
            .summary-card {
                background: #ffffff !important;
                border: 1px solid #000000 !important;
                box-shadow: none !important;
                color: #000000 !important;
            }
            
            .summary-card h3, .summary-card p {
                color: #000000 !important;
                font-weight: bold !important;
            }
            
            .orders-container {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 8px !important;
            }
            
            .order-card {
                border: 1px solid #000000 !important;
                box-shadow: none !important;
                background: #ffffff !important;
                padding: 8px !important;
                color: #000000 !important;
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            .product-section {
                width: 75px !important;
            }
            
            .product-image {
                display: block !important;
                width: 65px !important;
                height: 65px !important;
                border: 1px solid #000000 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                max-width: 100% !important;
            }

            .barcode-container {
                background: #ffffff !important;
                border: 1px solid #000000 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                min-height: 80px !important;
            }
            
            .barcode-image {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                
                background: #fff !important;
                image-rendering: -webkit-optimize-contrast !important;
                image-rendering: crisp-edges !important;
                max-height: 75px !important;
            }
            
            .order-quantity {
                background: #ffffff !important;
                color: #000000 !important;
                border: 1px solid #000000 !important;
                font-size: 11pt !important;
            }
            
            .options-section, .notes-section {
                background: #ffffff !important;
                border: 1px solid #000000 !important;
                color: #000000 !important;
            }
            
            .option-item {
                background: #ffffff !important;
                border: 1px solid #cccccc !important;
            }

            /* Ù…Ù†Ø¹ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± */
            h1, h2, h3, h4, h5, h6 {
                page-break-after: avoid;
            }
            
            table, figure, .order-card {
                page-break-inside: avoid;
            }
        }
        
        /* ØªØ­Ø³ÙŠÙ† Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙˆØ± Ø§Ù„ØªØ§Ù„ÙØ© */
        .product-image[style*="display: none"] {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="print-header">
        <h1>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</h1>
        <p>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${timestamp}</p>
    </div>

    <div class="summary-grid">
        <div class="summary-card">
            <h3>${printData.summary.totalProducts}</h3>
            <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</p>
        </div>
        <div class="summary-card">
            <h3>${printData.summary.totalOrders}</h3>
            <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
        </div>
        <div class="summary-card">
            <h3>${printData.summary.totalQuantity}</h3>
            <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ§Øª</p>
        </div>
        <div class="summary-card">
            <h3>${printData.summary.totalItems}</h3>
            <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ±</p>
        </div>
    </div>

    <div class="orders-container">
        ${generateOrdersHTML(printData.products)}
    </div>

    <script>
        // Ø·Ø¨Ø§Ø¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        window.addEventListener('load', function() {
            // ØªØ­Ø³ÙŠÙ† Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ± Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
            const images = document.querySelectorAll('img');
            images.forEach(img => {
                img.loading = 'eager';
                img.fetchPriority = 'high';
            });

            setTimeout(() => {
                window.print();
            }, 500);
        });
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„ØªØ§Ù„ÙØ© ÙˆØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†ØµÙˆØµ
        document.addEventListener('DOMContentLoaded', function() {
            const images = document.querySelectorAll('.product-image, .barcode-image');
            images.forEach(img => {
                img.addEventListener('error', function() {
                    this.style.display = 'none';
                    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØªØ§Ù„ÙØ©ØŒ Ù†Ø®ÙÙŠ Ø§Ù„Ø­Ø§ÙˆÙŠØ© ÙƒØ§Ù…Ù„Ø©
                    if (this.classList.contains('barcode-image')) {
                        this.closest('.barcode-container').style.display = 'none';
                    }
                });
                
                img.addEventListener('load', function() {
                    this.style.imageRendering = 'auto';
                });
            });

            // ØªØ­Ø³ÙŠÙ† Ù‚Ø§Ø¨Ù„ÙŠØ© Ù†Ø³Ø® Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
            const links = document.querySelectorAll('.order-ref-link');
            links.forEach(link => {
                // Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ© Ù†Ø³Ø® Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±
                link.addEventListener('click', function(e) {
                    if (!window.getSelection().toString()) {
                        e.preventDefault();
                        const orderNumber = this.getAttribute('href').replace('#', '');
                        navigator.clipboard.writeText(orderNumber).then(() => {
                            // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ø³Ø® (ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±)
                            console.log('ØªÙ… Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ' + orderNumber);
                        });
                    }
                });

                // Ø¬Ø¹Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ­Ø¯ÙŠØ¯ Ø¨Ø³Ù‡ÙˆÙ„Ø©
                link.style.webkitUserSelect = 'text';
                link.style.mozUserSelect = 'text';
                link.style.msUserSelect = 'text';
                link.style.userSelect = 'text';
            });

            // Ø¬Ø¹Ù„ ÙƒÙ„ Ø§Ù„Ù†ØµÙˆØµ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ¯
            const textElements = document.querySelectorAll('.options-title, .notes-title, .option-item, .notes-content');
            textElements.forEach(el => {
                el.style.webkitUserSelect = 'text';
                el.style.mozUserSelect = 'text';
                el.style.msUserSelect = 'text';
                el.style.userSelect = 'text';
            });
        });

        // Ù…Ù†Ø¹ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ§Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
        document.addEventListener('contextmenu', function(e) {
            if (e.target.classList.contains('order-ref-link')) {
                e.stopPropagation();
                return;
            }
            
            const selection = window.getSelection();
            if (selection.toString().length > 0) {
                e.stopPropagation();
            }
        });
    <\/script>
</body>
</html>`;
}

/**
 * Generates HTML for orders in the print view
 */
function generateOrdersHTML(products) {
    if (!products || products.length === 0) {
        return '<div class="no-data"><h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</h3><p>ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ¸Ù‡Ø± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.</p></div>';
    }

    let html = '';
    products.forEach(product => {
        product.orders.forEach(order => {
            html += `
                <div class="order-card">
                    <div class="order-header">
                        <div class="product-section">
                            <img src="${product.thumbnail}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬: ${product.name}" 
                                 class="product-image"
                                 onerror="this.style.display='none'">
                            <div class="order-details">
                                <a href="#${order.reference_id}" class="order-ref-link" title="Ø§Ù†Ù‚Ø± Ù„Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨">#${order.reference_id}</a>
                                <span class="order-quantity">${order.quantity} Ø§Ù„ÙƒÙ…ÙŠØ©</span>
                            </div>
                        </div>
                        ${order.barcode && order.barcode !== `Ø¨Ø§Ø±ÙƒÙˆØ¯_${order.reference_id}` ? `
                            <div class="barcode-container">
                                <img src="${order.barcode}" alt="Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ø·Ù„Ø¨ ${order.reference_id}" class="barcode-image"
                                     onerror="this.style.display='none'">
                            </div>
                        ` : '<div class="barcode-container" style="background: transparent; border: none;"></div>'}
                    </div>
      ${order.options && order.options.length > 0 ? `
    <div class="options-section">
        <div class="options-title">Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª:</div>
        ${order.options.map(opt => {
            if (opt.is_link && opt.href) {
                // Ø¹Ø±Ø¶ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù…Ø®ØªØµØ±Ø© (Ø£ÙˆÙ„ 6 Ø£Ø­Ø±Ù) Ù…Ø¹ "..." ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
                let displayValue = opt.value;
                if (displayValue.length > 6) {
                    displayValue = displayValue.substring(0, 6) + '...';
                }
                return `<span class="option-item link-option">
                    ${opt.name}: <a href="${opt.href}" target="_blank" class="option-link" title="${opt.value}">${displayValue}</a>
                </span>`;
            } else {
                return `<span class="option-item">${opt.name}: ${opt.value}</span>`;
            }
        }).join('')}
    </div>
` : ''}                   
                    ${order.notes ? `
                        <div class="notes-section">
                            <div class="notes-title">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</div>
                            <div class="notes-content">${order.notes}</div>
                        </div>
                    ` : ''}
                </div>
            `;
        });
    });
    
    return html;
}
    // â­ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ØµØ­Ø­Ø© Ù‡Ù†Ø§ â­
    function openQuickListPrint() {
        try {
            const printData = collectQuickListPrintData();
            
            console.log('ğŸ–¨ï¸ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©:', printData);
            
            if (printData.products.length === 0) {
                showSweetAlert('warning', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
                return false;
            }
            
            // Ø¥Ù†Ø´Ø§Ø¡ HTML ÙƒØ§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const htmlContent = generatePrintHTML(printData);
            
            // Ø¥Ù†Ø´Ø§Ø¡ Blob Ù…Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            const blob = new Blob([htmlContent], { type: 'text/html; charset=utf-8' });
            const blobUrl = URL.createObjectURL(blob);
            
            // ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…Ø¹ Blob URL
            const printWindow = window.open(blobUrl, '_blank', 
                'width=1200,height=800,scrollbars=yes,resizable=yes');
            
            if (!printWindow) {
                URL.revokeObjectURL(blobUrl);
                throw new Error('ØªÙ… Ù…Ù†Ø¹ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹.');
            }
            
            // ØªÙ†Ø¸ÙŠÙ Blob URL Ø¨Ø¹Ø¯ ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
            printWindow.addEventListener('load', function() {
                setTimeout(() => {
                    URL.revokeObjectURL(blobUrl);
                    console.log('ğŸ§¹ ØªÙ… ØªÙ†Ø¸ÙŠÙ Blob URL');
                }, 1000);
            });
            
            showSweetAlert('success', 'ØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©', 
                `ÙŠØªÙ… Ø§Ù„Ø¢Ù† ØªØ­Ù…ÙŠÙ„ ${printData.summary.totalOrders} Ø·Ù„Ø¨ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©`);
            
            return true;
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:', error);
            showSweetAlert('error', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©', 
                error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            return false;
        }
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
     */
    function validatePrintData() {
        const selectedCount = $('#quickListContent input.quick-list-order:checked').length;
        const productCount = $('.product-card').length;
        
        console.log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', {
            selectedOrders: selectedCount,
            products: productCount
        });
        
        if (selectedCount === 0) {
            showSweetAlert('warning', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø£ÙˆÙ„Ø§Ù‹');
            return false;
        }
        
        if (productCount === 0) {
            showSweetAlert('warning', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¹Ø±ÙˆØ¶Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©');
            return false;
        }
        
        return true;
    }

    // --- Ø¯ÙˆØ§Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø³Ù„Ø© ---

    function getSelectedOrdersForSalla() {
        return $('.order-checkbox:checked').map((_, el) => {
            return $(el).val();
        }).get();
    }

    function updateSallaOrdersStatus(orderIds, statusSlug, note = '') {
        const btn = $('#confirm-salla-status-update');
        const originalText = btn.html();
        
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø³Ù„Ø©');
        
        console.log('ğŸ”§ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©:', orderIds);
        
        $.ajax({
            url: "{{ url_for('orders.bulk_update_salla_status') }}",
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            data: JSON.stringify({
                order_ids: orderIds,
                status_slug: statusSlug,
                note: note
            }),
            timeout: 60000
        })
        .done(function(response) {
            console.log('ğŸ”§ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±:', response);
            
            if (response.success) {
                let successMessage = `ØªÙ… ØªØ­Ø¯ÙŠØ« ${response.updated_count} Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø³Ù„Ø©`;
                
                if (response.failed_orders && response.failed_orders.length > 0) {
                    successMessage += ` (ÙØ´Ù„ ${response.failed_count} Ø·Ù„Ø¨)`;
                    
                    setTimeout(() => {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Ø¨Ø¹Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙØ´Ù„ ØªØ­Ø¯ÙŠØ«Ù‡Ø§',
                            html: `
                                <div class="text-start" style="max-height: 300px; overflow-y: auto;">
                                    <p class="small text-muted mb-3">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:</p>
                                    <ul class="list-unstyled mb-0">
                                        ${response.failed_orders.map(order => 
                                            `<li class="small text-danger mb-2">âŒ ${order}</li>`
                                        ).join('')}
                                    </ul>
                                </div>
                            `,
                            confirmButtonText: 'Ù…ÙˆØ§ÙÙ‚',
                            width: '700px'
                        });
                    }, 1500);
                }
                
                showSweetAlert('success', 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', successMessage);
                
                setTimeout(() => {
                    $('#updateSallaStatusModal').modal('hide');
                    location.reload();
                }, 3000);
            } else {
                let errorMessage = response.error || 'ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«';
                
                if (response.failed_orders && response.failed_orders.length > 0) {
                    errorMessage += `<br><small class="text-muted">${response.failed_orders[0]}</small>`;
                }
                
                Swal.fire({
                    icon: 'error',
                    title: 'ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«',
                    html: errorMessage,
                    confirmButtonText: 'Ù…ÙˆØ§ÙÙ‚'
                });
            }
        })
        .fail(function(xhr, status, error) {
            console.error('ğŸ’¥ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
            
            let errorMsg = 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMsg = xhr.responseJSON.error;
            } else if (status === 'timeout') {
                errorMsg = 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
            }
            
            Swal.fire({
                icon: 'error',
                title: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„',
                text: errorMsg,
                confirmButtonText: 'Ù…ÙˆØ§ÙÙ‚'
            });
        })
        .always(function() {
            btn.prop('disabled', false).html(originalText);
        });
    }

    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© ---

    function updateProductSelectionCount(productSku) {
        const totalOrders = $(`.order-checkbox-${productSku}`).length;
        const selectedOrders = $(`.order-checkbox-${productSku}:checked`).length;
        
        $(`.selected-orders-count[data-sku="${productSku}"]`).text(`${selectedOrders}/${totalOrders} Ù…Ø­Ø¯Ø¯`);
    }


    function updateProductCheckboxState(productSku) {
        const totalOrders = $(`.order-checkbox-${productSku}`).length;
        const selectedOrders = $(`.order-checkbox-${productSku}:checked`).length;
        const productCheckbox = $(`#product-${productSku}`);
        
        if (selectedOrders === 0) {
            productCheckbox.prop('checked', false);
            productCheckbox.prop('indeterminate', false);
        } else if (selectedOrders === totalOrders) {
            productCheckbox.prop('checked', true);
            productCheckbox.prop('indeterminate', false);
        } else {
            productCheckbox.prop('checked', false);
            productCheckbox.prop('indeterminate', true);
        }
    }

    // --- Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---

    // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    $(document).on('change', '#select-all, #select-all-header', function() {
        const isChecked = this.checked;
        $('.order-checkbox').prop('checked', isChecked);
        
        if (isChecked) {
            $('.order-checkbox').closest('tr').addClass('selected-row');
        } else {
            $('.order-checkbox').closest('tr').removeClass('selected-row');
        }
        
        updateAssignButtonState();
    });

    $(document).on('change', '.order-checkbox', function() {
        const allChecked = $('.order-checkbox:checked').length === $('.order-checkbox').length;
        $('#select-all, #select-all-header').prop('checked', allChecked);
        
        if ($(this).is(':checked')) {
            $(this).closest('tr').addClass('selected-row');
        } else {
            $(this).closest('tr').removeClass('selected-row');
        }
        
        updateAssignButtonState();
        toggleQuickListButton();
    });

    // 2. Ø¥Ø³Ù†Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    $(document).on('click', '#assign-orders-btn', function() {
        const selectedOrders = getSelectedOrders();
        
        const employeeOptions = {
            '': 'Ø§Ø®ØªØ± Ù…ÙˆØ¸ÙÙ‹Ø§...'
            {% for employee in employees %}
                {% if employee.role == 'general' %}
                    ,"{{ employee.id }}": "{{ employee.email }}"
                {% endif %}
            {% endfor %}
        };
        
        Swal.fire({
            title: 'Ø¥Ø³Ù†Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©',
            html: `Ø³ÙŠØªÙ… Ø¥Ø³Ù†Ø§Ø¯ <span class="fw-bold text-primary">${selectedOrders.length}</span> Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø­Ø¯Ø¯.`,
            input: 'select',
            inputOptions: employeeOptions,
            inputPlaceholder: 'Ø§Ø®ØªØ± Ù…ÙˆØ¸ÙÙ‹Ø§...',
            showCancelButton: true,
            confirmButtonText: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯',
            cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
            showLoaderOnConfirm: true,
            customClass: {
                confirmButton: 'btn btn-primary',
                cancelButton: 'btn btn-outline-secondary ms-2'
            },
            buttonsStyling: false,
            inputValidator: (value) => {
                if (!value) return 'ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¸Ù Ù„Ù„Ø¥Ø³Ù†Ø§Ø¯';
            },
            preConfirm: (employeeId) => {
                return assignOrders(employeeId, selectedOrders)
                    .fail((xhr) => {
                        const errorMsg = xhr.responseJSON?.error || 'ÙØ´Ù„ Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯ Ù„Ø³Ø¨Ø¨ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ.';
                        Swal.showValidationMessage(`ÙØ´Ù„ Ø§Ù„Ø·Ù„Ø¨: ${errorMsg}`);
                    });
            },
            allowOutsideClick: () => !Swal.isLoading()
        }).then((result) => {
            if (result.isConfirmed && result.value.success) {
                showSweetAlert('success', 'ØªÙ… Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­!', result.value.message);
                setTimeout(() => location.reload(), 1500);
            }
        });
    });
    
    $(document).on('click', '.assign-single-btn', function(e) {
        e.stopPropagation();
        const orderId = $(this).data('order-id');
        const orderType = $(this).data('order-type');
        
        const employeeOptions = {
            '': 'Ø§Ø®ØªØ± Ù…ÙˆØ¸ÙÙ‹Ø§...'
            {% for employee in employees %}
                {% if employee.role == 'general' %}
                    ,"{{ employee.id }}": "{{ employee.email }}"
                {% endif %}
            {% endfor %}
        };
        
        Swal.fire({
            title: 'Ø¥Ø³Ù†Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨ #' + orderId,
            input: 'select',
            inputOptions: employeeOptions,
            inputPlaceholder: 'Ø§Ø®ØªØ± Ù…ÙˆØ¸ÙÙ‹Ø§...',
            showCancelButton: true,
            confirmButtonText: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯',
            cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
            showLoaderOnConfirm: true,
            customClass: {
                confirmButton: 'btn btn-primary',
                cancelButton: 'btn btn-outline-secondary ms-2'
            },
            buttonsStyling: false,
            inputValidator: (value) => {
                if (!value) return 'ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¸Ù Ù„Ù„Ø¥Ø³Ù†Ø§Ø¯';
            },
            preConfirm: (employeeId) => {
                return assignOrders(employeeId, [{ id: orderId, type: orderType }])
                    .fail((xhr) => {
                        const errorMsg = xhr.responseJSON?.error || 'ÙØ´Ù„ Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯ Ù„Ø³Ø¨Ø¨ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ.';
                        Swal.showValidationMessage(`ÙØ´Ù„ Ø§Ù„Ø·Ù„Ø¨: ${errorMsg}`);
                    });
            },
            allowOutsideClick: () => !Swal.isLoading()
        }).then((result) => {
            if (result.isConfirmed && result.value.success) {
                showSweetAlert('success', 'ØªÙ… Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­!', result.value.message);
                setTimeout(() => location.reload(), 1500);
            }
        });
    });
    
    // 3. ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    $(document).on('click', '#change-status-btn', function() {
        const orderIds = $('.order-checkbox:checked').map((_, el) => $(el).val()).get();
        $('#selected-count-modal').text(orderIds.length);
        $('#changeStatusModal').modal('show');
    });
    
    $(document).on('click', '#confirm-status-change', function() {
        const orderIds = $('.order-checkbox:checked').map((_, el) => $(el).val()).get();
        const statusId = $('#status-select').val();
        const note = $('#status-note').val();
        
        if (!statusId) {
            showSweetAlert('warning', 'ØªØ­Ø°ÙŠØ±', 'ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø§Ù„Ø©');
            return;
        }
        
        $('#changeStatusModal').modal('hide');
        
        $.ajax({
            url: "{{ url_for('orders.bulk_update_status') }}",
            type: "POST",
            contentType: "application/json",
            headers: { 'X-CSRFToken': csrfToken },
            data: JSON.stringify({
                order_ids: orderIds,
                status_id: statusId,
                note: note
            }),
        })
        .done(function(response) {
            if (response.success) {
                showSweetAlert('success', 'Ù†Ø¬Ø­ Ø§Ù„ØªØ­Ø¯ÙŠØ«!', response.message);
                setTimeout(() => location.reload(), 1500);
            } else {
                showSweetAlert('error', 'ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«', response.error);
            }
        })
        .fail(function(xhr) {
            const errorMsg = xhr.responseJSON?.error || 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…';
            showSweetAlert('error', 'Ø­Ø¯Ø« Ø®Ø·Ø£', errorMsg);
        });
    });
    
    // 4. Ø§Ù„ÙÙ„Ø§ØªØ± ÙˆØ§Ù„Ø¨Ø­Ø«
    $(document).on('submit', '#advanced-filters', function(e) {
        e.preventDefault();
        reloadOrders();
    });
    
    $(document).on('input', '#search-order-id', _.debounce(function() {
        reloadOrders();
    }, 500));
    
    $(document).on('change', '#filter-order-status, #filter-employee, #filter-custom-status, #filter-special-status, #per-page-select', _.debounce(function() {
        reloadOrders();
    }, 300));
    
    // 5. Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±
    $(document).on('click', '#reset-filters, #reset-filters-btn', function() {
        window.location.href = "{{ url_for('orders.index') }}";
    });

    // 6. Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ ØµÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    $(document).on('click', '.clickable-row', function(e) {
        if ($(e.target).is('input, button, a, i') || $(e.target).closest('button, a, .actions-cell').length) {
            return;
        }
        
        const orderId = $(this).data('order-id');
        const orderType = $(this).data('order-type');
        
        let url;
        if (orderType === 'custom') {
            url = "{{ url_for('orders.custom_order_details', order_id=0) }}".replace('0', orderId);
        } else {
            url = "{{ url_for('orders.order_details', order_id=0) }}".replace('0', orderId);
        }
        
        window.location.href = url;
    });
    
    // 7. Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
    $(document).on('click', '#quickListViewBtn', function() {
        const selectedOrders = $('.order-checkbox:checked').map((_, el) => $(el).val()).get();
        
        if (selectedOrders.length === 0) {
            showSweetAlert('warning', 'ØªØ­Ø°ÙŠØ±', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
            return;
        }

        currentSelectedOrders = selectedOrders;

        $('#quickListContent').html(`
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                </div>
                <p class="mt-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
            </div>
        `);

        $('#quickListModal').modal('show');

        $.ajax({
            url: "{{ url_for('orders.get_quick_list_data') }}",
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            data: JSON.stringify({ order_ids: selectedOrders })
        })
        .done(function(data) {
            if (data.success) {
                let html = '';
                
                if (data.products && data.products.length > 0) {
                    data.products.forEach(product => {
                        html += `
    <div class="card mb-4 product-card" data-product-sku="${product.sku}">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <div class="form-check me-3">
                    <input class="form-check-input product-checkbox" type="checkbox" 
                           id="product-${product.sku}" data-sku="${product.sku}" checked>
                    <label class="form-check-label" for="product-${product.sku}"></label>
                </div>
                <img src="${product.main_image || '/static/images/no-image.png'}" 
                     alt="${product.name}" 
                     class="img-thumbnail me-3" 
                     style="width: 60px; height: 60px; object-fit: cover;"
                     onerror="this.src='/static/images/no-image.png'">
                <div>
                    <h6 class="mb-1 fw-bold">${product.name}</h6>
                    <small class="text-muted">SKU: ${product.sku}</small>
                    <div class="mt-1">
                        <span class="badge bg-primary">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: ${product.total_quantity}</span>
                        <span class="badge bg-secondary ms-2">Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ ${product.appearances_count} Ø·Ù„Ø¨</span>
                        ${product.price ? `<span class="badge bg-warning ms-2">Ø§Ù„Ø³Ø¹Ø±: ${product.price} Ø±.Ø³</span>` : ''}
                    </div>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <div class="product-selection-info me-3">
                    <small class="text-muted selected-orders-count" data-sku="${product.sku}">
                        ${product.order_appearances.length}/${product.order_appearances.length} Ù…Ø­Ø¯Ø¯
                    </small>
                </div>
                <button class="btn btn-sm btn-outline-primary toggle-orders-btn" 
                        type="button" 
                        data-sku="${product.sku}"
                        title="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨Ø§Øª">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
        </div>
        <div class="card-body orders-container" id="orders-${product.sku}" style="display: none;">
            <h6 class="border-bottom pb-2 mb-3">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:</h6>
                        `;

                        product.order_appearances.forEach((appearance, index) => {
                            const barcodeData = appearance.barcode || '';
                            
                            html += `
            <div class="order-appearance mb-3 p-3 border rounded ${index > 0 ? 'mt-2' : ''}" 
                 data-barcode="${barcodeData}">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center">
                            <input class="form-check-input me-2 quick-list-order order-checkbox-${product.sku}" 
                                   type="checkbox" 
                                   value="${appearance.order_id}" 
                                   id="order-${appearance.order_id}-${product.sku}"
                                   data-order-id="${appearance.order_id}"
                                   data-product-sku="${product.sku}"
                                   checked>
                            <label class="form-check-label fw-bold" for="order-${appearance.order_id}-${product.sku}">
                                Ø§Ù„Ø·Ù„Ø¨ #${appearance.reference_id}
                            </label>
                        </div>
                        <div class="ms-4 mt-2">
                            <small class="text-muted d-block">
                                <i class="fas fa-user me-1"></i> Ø§Ù„Ø¹Ù…ÙŠÙ„: ${appearance.customer_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                            </small>
                            <small class="text-muted d-block">
                                <i class="fas fa-calendar me-1"></i> Ø§Ù„ØªØ§Ø±ÙŠØ®: ${appearance.created_at}
                            </small>
                            <small class="text-muted d-block">
                                <i class="fas fa-box me-1"></i> Ø§Ù„ÙƒÙ…ÙŠØ©: ${appearance.quantity}
                            </small>
                            ${appearance.customer_mobile ? `
                            <small class="text-muted d-block">
                                <i class="fas fa-phone me-1"></i> Ø§Ù„Ø¬ÙˆØ§Ù„: ${appearance.customer_mobile}
                            </small>
                            ` : ''}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="options-section mb-2">
                            <strong class="small d-block mb-1">Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª:</strong>
                            `;

                            if (appearance.options && appearance.options.length > 0) {
                                appearance.options.forEach(option => {
                                    html += `
                            <span class="badge bg-light text-dark me-1 mb-1 small">
                                ${option.name}: ${option.value}
                            </span>
                                    `;
                                });
                            } else {
                                html += `<span class="text-muted small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®ÙŠØ§Ø±Ø§Øª</span>`;
                            }

                            html += `
                        </div>
                        
                        ${appearance.notes ? `
                        <div class="notes-section mt-2 p-2 bg-info bg-opacity-10 border border-info rounded">
                            <strong class="small d-block mb-1 text-info">
                                <i class="fas fa-sticky-note me-1"></i>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:
                            </strong>
                            <span class="notes-text small">${appearance.notes}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
                            `;
                        });

                        html += `
        </div>
    </div>
                        `;
                    });
                } else {
                    html = `
                    <div class="alert alert-warning text-center py-4">
                        <i class="fas fa-box-open fa-2x mb-3 text-warning"></i>
                        <h5 class="alert-heading">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</h5>
                        <p class="mb-0">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>
                    </div>
                    `;
                }
                
                $('#quickListContent').html(html);
                updateQuickListSelectionCount();
                updateProductSelectionCounts();
                
                showSweetAlert('success', 'ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', 
                    `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${data.products?.length || 0} Ù…Ù†ØªØ¬ Ù…Ù† ${data.stats?.successful_orders || 0} Ø·Ù„Ø¨`);
                
            } else {
                $('#quickListContent').html(`
                    <div class="alert alert-danger text-center py-4">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3 text-danger"></i>
                        <h5 class="alert-heading">Ø­Ø¯Ø« Ø®Ø·Ø£</h5>
                        <p class="mb-0">${data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'}</p>
                    </div>
                `);
            }
        })
        .fail(function(error) {
            $('#quickListContent').html(`
                <div class="alert alert-danger">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.statusText}</div>
            `);
        });
    });

    // 8. ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø³Ù„Ø©
    $(document).on('click', '#update-salla-status-btn', function() {
        const selectedOrders = getSelectedOrdersForSalla();
        
        console.log('ğŸ” Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©:', selectedOrders);
        
        if (selectedOrders.length === 0) {
            showSweetAlert('warning', 'ØªØ­Ø°ÙŠØ±', 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª');
            return;
        }
        
        $('#selected-count-salla-modal').text(selectedOrders.length);
        $('#updateSallaStatusModal').modal('show');
    });

    $(document).on('click', '#confirm-salla-status-update', function() {
        const selectedOrders = getSelectedOrdersForSalla();
        const statusSlug = $('#salla-status-select').val();
        const note = $('#salla-status-note').val();
        
        if (!statusSlug) {
            showSweetAlert('warning', 'ØªØ­Ø°ÙŠØ±', 'ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø§Ù„Ø© Ø³Ù„Ø©');
            return;
        }
        
        updateSallaOrdersStatus(selectedOrders, statusSlug, note);
    });

    // 9. Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø³Ù„Ø©
    $('#updateSallaStatusModal').on('show.bs.modal', function () {
        $('#salla-status-select').val('');
        $('#salla-status-note').val('');
    });

    // 10. Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
    // 10. Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ØµØ­Ø­
$(document).on('change', '#selectAllQuickList', function() {
    const isChecked = this.checked;
    
    // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
    $('#quickListContent input.quick-list-order').prop('checked', isChecked);
    $('#quickListContent input.product-checkbox').prop('checked', isChecked);
    $('#quickListContent input.product-checkbox').prop('indeterminate', false);
    
    // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
    updateQuickListSelectionCount();
    updateProductSelectionCounts();
});
    $(document).on('change', '#quickListContent input.quick-list-order', function() {
        updateQuickListSelectionCount();
    });
    
    // 11. Ø¥Ø³Ù†Ø§Ø¯ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
    $(document).on('click', '#quickListAssignBtn', function() {
        const employeeId = $('#quickListAssignSelect').val();
        const selectedOrders = [];
        
        $('#quickListContent input.quick-list-order:checked').each(function() {
            const orderId = $(this).data('order-id');
            if (!selectedOrders.find(order => order.id === orderId)) {
                selectedOrders.push({
                    id: orderId,
                    type: 'salla'
                });
            }
        });

        if (!employeeId) {
            showSweetAlert('warning', 'ØªØ­Ø°ÙŠØ±', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¸Ù Ù„Ù„Ø¥Ø³Ù†Ø§Ø¯');
            return;
        }

        if (selectedOrders.length === 0) {
            showSweetAlert('warning', 'ØªØ­Ø°ÙŠØ±', 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ø¥Ø³Ù†Ø§Ø¯');
            return;
        }

        const assignBtn = $('#quickListAssignBtn');
        const originalText = assignBtn.html();
        assignBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯');

        assignOrders(employeeId, selectedOrders)
            .done(function(data) {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'ØªÙ… Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­',
                        text: data.message || `ØªÙ… Ø¥Ø³Ù†Ø§Ø¯ ${selectedOrders.length} Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø­Ø¯Ø¯`,
                        confirmButtonText: 'Ù…ÙˆØ§ÙÙ‚',
                        customClass: {
                            confirmButton: 'btn btn-success'
                        }
                    }).then(() => {
                        $('#quickListModal').modal('hide');
                        location.reload();
                    });
                } else {
                    throw new Error(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯');
                }
            })
            .fail(function(error) {
                assignBtn.prop('disabled', false).html(originalText);
                const errorMsg = error.responseJSON?.error || error.statusText || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯';
                
                Swal.fire({
                    icon: 'error',
                    title: 'ÙØ´Ù„ Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯',
                    text: errorMsg,
                    confirmButtonText: 'Ù…ÙˆØ§ÙÙ‚',
                    customClass: {
                        confirmButton: 'btn btn-danger'
                    }
                });
            });
    });
    
    // 12. ØªØ­Ù…ÙŠÙ„ HTML
    $(document).on('click', '#download-html-btn', function() {
        const selectedOrders = $('.order-checkbox:checked').map((_, el) => $(el).val()).get();
        
        if (selectedOrders.length === 0) {
            showSweetAlert('warning', 'ØªØ­Ø°ÙŠØ±', 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØªØ­Ù…ÙŠÙ„');
            return;
        }
        
        Swal.fire({
            title: 'ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª',
            html: `Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ <span class="fw-bold text-primary">${selectedOrders.length}</span> Ø·Ù„Ø¨ ÙƒÙ…Ù„Ù HTML ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„`,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'Ù…ÙˆØ§ÙÙ‚ØŒ ØªØ­Ù…ÙŠÙ„ HTML',
            cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
            customClass: {
                confirmButton: 'btn btn-primary',
                cancelButton: 'btn btn-outline-secondary ms-2'
            },
            buttonsStyling: false
        }).then((result) => {
            if (result.isConfirmed) {
                const downloadBtn = $('#download-html-btn');
                const originalText = downloadBtn.html();
                downloadBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²');
                
                const downloadLink = document.createElement('a');
                downloadLink.href = `{{ url_for('orders.download_orders_html') }}?order_ids=${selectedOrders.join(',')}`;
                downloadLink.style.display = 'none';
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                setTimeout(() => {
                    downloadBtn.prop('disabled', false).html(originalText);
                }, 2000);
            }
        });
    });
    
    // 13. ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
    $(document).on('click', '#quickListChangeStatusBtn', function() {
        const selectedOrders = [];
        $('#quickListContent input.quick-list-order:checked').each(function() {
            selectedOrders.push($(this).val());
        });

        if (selectedOrders.length === 0) {
            showSweetAlert('warning', 'ØªØ­Ø°ÙŠØ±', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©');
            return;
        }

        $('#quickListModal').modal('hide');
        
        setTimeout(() => {
            $('#selected-count-modal').text(selectedOrders.length);
            $('#changeStatusModal').data('selected-orders', selectedOrders);
            $('#changeStatusModal').modal('show');
        }, 300);
    });

    // 14. Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
    $(document).on('click', '#quickListPrintBtn', function() {
        if (!validatePrintData()) {
            return;
        }
        
        const $btn = $(this);
        const originalHtml = $btn.html();
        
        $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡');
        
        setTimeout(() => {
            const success = openQuickListPrint();
            
            setTimeout(() => {
                $btn.prop('disabled', false).html(originalHtml);
            }, success ? 1000 : 2000);
        }, 300);
    });

    // 15. ØªØ­Ù…ÙŠÙ„ PDF Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
    $(document).on('click', '#quickListDownloadBtn', function() {
        const selectedOrders = [];
        
        $('#quickListContent input.quick-list-order:checked').each(function() {
            const orderId = $(this).data('order-id');
            if (!selectedOrders.includes(orderId)) {
                selectedOrders.push(orderId);
            }
        });

        if (selectedOrders.length === 0) {
            showSweetAlert('warning', 'ØªØ­Ø°ÙŠØ±', 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØªØ­Ù…ÙŠÙ„');
            return;
        }

        const downloadBtn = $('#quickListDownloadBtn');
        const originalText = downloadBtn.html();
        downloadBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²');

        const downloadLink = document.createElement('a');
        downloadLink.href = `{{ url_for('orders.download_pdf') }}?order_ids=${selectedOrders.join(',')}`;
        downloadLink.style.display = 'none';
        downloadLink.target = '_blank';
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);

        setTimeout(() => {
            downloadBtn.prop('disabled', false).html(originalText);
            showSweetAlert('success', 'ØªÙ… Ø§Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„', 'Ø³ÙŠØ¨Ø¯Ø£ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù PDF Ù‚Ø±ÙŠØ¨Ø§Ù‹');
        }, 1000);
    });

    // 16. Ø£Ø­Ø¯Ø§Ø« Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    $(document).on('click', '.toggle-orders-btn', function() {
        const sku = $(this).data('sku');
        const ordersContainer = $(`#orders-${sku}`);
        const icon = $(this).find('i');
        
        if (ordersContainer.is(':visible')) {
            ordersContainer.slideUp(300);
            icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
            $(this).attr('title', 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª');
        } else {
            ordersContainer.slideDown(300);
            icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
            $(this).attr('title', 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨Ø§Øª');
        }
    });

    $(document).on('click', '#toggleAllOrdersBtn', function() {
        const allContainers = $('.orders-container');
        const allButtons = $('.toggle-orders-btn');
        const icon = $(this).find('i');
        
        if (allContainers.first().is(':visible')) {
            allContainers.slideUp(300);
            allButtons.find('i').removeClass('fa-chevron-up').addClass('fa-chevron-down');
            allButtons.attr('title', 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª');
            icon.removeClass('fa-eye-slash').addClass('fa-eye');
            $(this).attr('title', 'Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª');
        } else {
            allContainers.slideDown(300);
            allButtons.find('i').removeClass('fa-chevron-down').addClass('fa-chevron-up');
            allButtons.attr('title', 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨Ø§Øª');
            icon.removeClass('fa-eye').addClass('fa-eye-slash');
            $(this).attr('title', 'Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª');
        }
    });

    // 17. Ø£Ø­Ø¯Ø§Ø« ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª
    $(document).on('change', '.product-checkbox', function() {
        const productSku = $(this).data('sku');
        const isChecked = $(this).is(':checked');
        
        $(`.order-checkbox-${productSku}`).prop('checked', isChecked);
        
        updateProductSelectionCount(productSku);
        updateQuickListSelectionCount();
    });

    $(document).on('change', '.quick-list-order', function() {
        const productSku = $(this).data('product-sku');
        
        updateProductSelectionCount(productSku);
        updateProductCheckboxState(productSku);
        updateQuickListSelectionCount();
    });

    // --- Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ---
    updateTimestamps();
    updateAssignButtonState();
    
    setInterval(updateTimestamps, 60000);
    
    if (window.innerWidth < 768) {
        $('.sidebar').removeClass('show');
        $('.sidebar__backdrop').removeClass('show');
    }
});

</script>
{% endblock %}
{% endblock %}  