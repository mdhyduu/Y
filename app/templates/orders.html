{% extends 'base.html' %}
{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/orders.css') }}">

{% endblock %}

{% block content %} 

<div class="card shadow-lg mb-4 border-0">
    <div class="card-header py-3 bg-gradient-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold">
                <i class="fas fa-tasks me-2"></i>لوحة تحكم الطلبات
            </h6>
          <div class="d-flex align-items-center">
    <div id="sync-progress" class="me-3 d-none">
        <div class="progress" style="height: 6px; width: 150px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-white" 
                 role="progressbar" style="width: 0%"></div>
        </div>
        <small class="sync-details text-white-50 mt-1 d-block"></small>
    </div>
  <button class="btn btn-primary btn-sm rounded-pill me-2" id="sync-statuses-btn">
    <i class="fas fa-list-alt me-1"></i>

</button>
<button class="btn btn-primary btn-sm rounded-pill" id="sync-orders-btn">
    <i class="fas fa-sync-alt me-1"></i>
</button>
</div>
        </div>
    </div>
    
    <div class="card-body p-0">
        <div class="p-4 border-bottom">
            <form id="advanced-filters" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="search-order-id" class="form-label small text-muted mb-1">بحث سريع</label>
                    <div class="input-group">
                        <span class="input-group-text bg-transparent"><i class="fas fa-search"></i></span>
                        <input type="text" id="search-order-id" class="form-control border-start-0" 
                               placeholder="ابحث برقم الطلب..." value="{{ filters.search }}"
                               data-debounce="500">
                    </div>
                </div>
                {% if is_reviewer %}
                <div class="col-md-2">
                    <label for="filter-order-status" class="form-label small text-muted mb-1">حالة الطلب</label>
                    <select id="filter-order-status" class="form-select">
                        <option value="">الكل</option>
                        {% for status in order_statuses %}
                            <option value="{{ status.slug }}" {% if filters.status == status.slug %}selected{% endif %}>
                                {{ status.name }} ({{ status.type }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                {% if is_reviewer %}
                <div class="col-md-2">
                    <label for="filter-employee" class="form-label small text-muted mb-1">الموظف المسؤول</label>
                    <select id="filter-employee" class="form-select">
                        <option value="">الكل</option>
                        {% for emp in employees %}
                            <option value="{{ emp.id }}" {% if filters.employee == emp.id|string %}selected{% endif %}>{{ emp.email|truncate(15) }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                
                <div class="col-md-2">
                    <label for="filter-custom-status" class="form-label small text-muted mb-1">حالة مخصصة</label>
                    <select id="filter-custom-status" class="form-select">
                        <option value="">الكل</option>
                        {% for status in custom_statuses %}
                            <option value="{{ status.id }}" {% if filters.custom_status == status.id|string %}selected{% endif %}>{{ status.name|truncate(15) }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label for="filter-special-status" class="form-label small text-muted mb-1">حالات خاصة</label>
                    <select id="filter-special-status" class="form-select">
                        <option value="">الكل</option>
                        <option value="late" {% if filters.status == 'late' %}selected{% endif %}>متأخرة</option>
                        <option value="missing" {% if filters.status == 'missing' %}selected{% endif %}>واصل ناقص</option>
                        <option value="not_shipped" {% if filters.status == 'not_shipped' %}selected{% endif %}>لم يشحن</option>
                        <option value="refunded" {% if filters.status == 'refunded' %}selected{% endif %}>مرتجعات</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label class="form-label small text-muted mb-1">الفترة الزمنية</label>
                    <div class="input-daterange input-group">
                        <input type="date" class="form-control form-control-sm rounded-start" 
                               id="date-from" name="date_from" value="{{ filters.date_from }}">
                        <span class="input-group-text">إلى</span>
                        <input type="date" class="form-control form-control-sm rounded-end" 
                               id="date-to" name="date_to" value="{{ filters.date_to }}">
                    </div>
                </div>
                
                <div class="col-md-2 d-flex">
                    <button type="submit" class="btn btn-primary me-2 flex-grow-1">
                        <i class="fas fa-filter me-1"></i> تطبيق
                    </button>
                    <button type="button" id="reset-filters" class="btn btn-outline-secondary">
                        <i class="fas fa-undo"></i>
                    </button>
                </div>
            </form>
        </div>
        
        <!-- إضافة أزرار الإجراءات السريعة -->
    <!-- إضافة أزرار الإجراءات السريعة -->
<!-- في قسم أزرار الإجراءات السريعة - أضف هذا الزر -->
<!-- في قسم أزرار الإجراءات السريعة -->
<div class="d-flex p-3" class="card-body" id="quick-actions">
    {% if is_reviewer and employees %}
    <button type="button" class="btn btn-success rounded-pill px-3 me-2" id="assign-orders-btn" disabled>
        <i class="fas fa-user-check me-1"></i> 
        <span id="selected-orders-count">0</span> إسناد
    </button>
    {% endif %}
    
    <button type="button" class="btn btn-warning rounded-pill px-3 me-2" id="update-salla-status-btn" disabled>
        <i class="fas fa-sync-alt me-1"></i> 
        <span id="selected-orders-count-salla">0</span> تحديث في سلة
    </button>
    
    <!-- ⭐⭐ زر طباعة العناوين الجديد ⭐⭐ -->
    <button type="button" class="btn btn-dark rounded-pill px-3 me-2" id="print-addresses-btn" disabled>
        <i class="fas fa-map-marker-alt me-1"></i> 
        <span id="selected-orders-count-address">0</span> طباعة عناوين
    </button>
    
    <button type="button" class="btn btn-primary rounded-pill px-3 me-2" id="download-html-btn" disabled>
        <i class="fas fa-download me-1"></i> 
        <span id="selected-orders-count-html">0</span> تحميل 
    </button> 

    <button type="button" class="btn btn-info rounded-pill px-3 me-2" id="change-status-btn" disabled>
        <i class="fas fa-tag me-1"></i> 
        <span id="selected-orders-count-2">0</span> تغيير الحالة
    </button>

    <button type="button" class="btn btn-secondary mb-3" id="quickListViewBtn" disabled>
        <i class="fas fa-eye"></i> قائمة سريعة
    </button>
</div>
        {% if orders %}
        <div class="table-responsive position-relative">
            <div id="table-loading" class="position-absolute top-0 start-0 w-100 h-100 bg-white bg-opacity-75 d-flex justify-content-center align-items-center d-none" style="z-index: 10;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">جاري التحميل...</span>
                </div>
            </div>
            
            <table class="table table-hover mb-0" id="orders-table">
   <!-- في قسم thead -->
<thead class="table">
    <tr>
        <th width="5%" class="ps-4">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="select-all-header">
            </div>
        </th>
        <th>رقم الطلب</th>
        <th class="d-none d-md-table-cell">الحالة</th>
        <th>الحالة المخصصة</th>
        <!-- ⭐⭐ إضافة عمود طريقة الدفع هنا ⭐⭐ -->
        <th class="d-none d-lg-table-cell">طريقة الدفع</th>
        <th>العلامات</th>
        <th class="d-none d-md-table-cell">التاريخ</th>
        {% if is_reviewer %}
        <th class="d-none d-md-table-cell">المسند إليه</th>
        {% endif %}
        <th width="15%" class="text-end pe-4">الإجراءات</th>
    </tr>
</thead>
             <tbody>
    {% for order in orders %}
    <tr data-order-id="{{ order.id }}" data-order-type="{{ order.type }}" data-order-status="{{ order.status.slug if order.status else 'unknown' }}" class="align-middle clickable-row">
        <td class="ps-4">
            <div class="form-check">
                <input type="checkbox" class="form-check-input order-checkbox" value="{{ order.id }}" data-type="{{ order.type }}">
            </div>
        </td>
        <td>
            <span class="fw-bold">#{{ order.reference_id }}</span>
        </td>
        <td class="d-none d-md-table-cell">
            {% if order.status %}
                <span class="status-badge status-{{ order.status.slug }}" 
                      data-bs-toggle="tooltip" 
                      title="{{ order.status.name }} ({{ order.status.type }})">
                    <i class="fas fa-circle me-1 small"></i>
                    {{ order.status.name }}
                </span>
            {% else %}
                <span class="status-badge status-unknown" data-bs-toggle="tooltip" title="حالة غير معروفة">
                    <i class="fas fa-circle me-1 small"></i>
                    غير محدد
                </span>
            {% endif %}
        </td>
        <td>
            {% if order.employee_statuses %}
                {% set last_custom_status = order.employee_statuses | sort(attribute='created_at', reverse=true) | first %}
                <span class="badge rounded-pill" style="background-color: {{ last_custom_status.status.color }}; color: white">
                    {{ last_custom_status.status.name }}
                </span>
            {% else %}
                <span class="text-muted small">-</span>
            {% endif %}
        </td>
        <!-- ⭐⭐ إضافة خلية طريقة الدفع هنا ⭐⭐ -->
        <td class="d-none d-lg-table-cell">
            {% if order.payment_method %}
                {% set payment_class = "payment-" + (order.payment_method.replace('_', '-') if order.payment_method else 'unknown') %}
                <span class="payment-method-badge {{ payment_class }}" data-bs-toggle="tooltip" title="{{ order.payment_method_name }}">
                    {% if order.payment_method == 'tabby_installment' %}
                        <i class="fas fa-credit-card payment-icon"></i>تابي
                    {% elif order.payment_method == 'mada' %}
                        <i class="fas fa-credit-card payment-icon"></i>مدى
                    {% elif order.payment_method == 'visa' or order.payment_method == 'mastercard' %}
                        <i class="fab fa-cc-visa payment-icon"></i>بطاقة
                    {% elif order.payment_method == 'cash' %}
                        <i class="fas fa-money-bill-wave payment-icon"></i>نقدي
                    {% elif order.payment_method == 'bank' %}
                        <i class="fas fa-university payment-icon"></i>بنكي
                    {% else %}
                        <i class="fas fa-wallet payment-icon"></i>{{ order.payment_method_name|default('غير محدد', true)|truncate(10) }}
                    {% endif %}
                </span>
            {% else %}
                <span class="payment-method-badge payment-unknown" data-bs-toggle="tooltip" title="طريقة دفع غير محددة">
                    <i class="fas fa-wallet payment-icon"></i>غير محدد
                </span>
            {% endif %}
        </td>
        <td>
            {% set last_note = order.status_notes | sort(attribute='created_at', reverse=true) | first %}

    {% if last_note %}
        <div class="d-flex align-items-center">
            {% if last_note.custom_status %}
                <!-- حالة مخصصة مع لون مخصص -->
                <span class="badge rounded-pill me-1" 
                      style="background-color: {{ last_note.custom_status.color }}; color: white">
                    {{ last_note.custom_status.name }}
                </span>
            {% elif last_note.status_flag %}
                <!-- حالة خاصة (status_flag) -->
                {% set flag_class = "badge-" + last_note.status_flag %}
                {% set flag_text = {
                    'late': 'متأخر',
                    'missing': 'واصل ناقص',
                    'refunded': 'مرتجع',
                    'not_shipped': 'لم يشحن'
                }.get(last_note.status_flag, last_note.status_flag) %}
                <span class="badge {{ flag_class }} fw-normal me-1">{{ flag_text }}</span>
            {% endif %} 
        </div>
    {% else %}
        <span class="text-muted small">-</span>
    {% endif %}
</td>
                        <td class="d-none d-md-table-cell">
                            <span class="time-ago small" data-bs-toggle="tooltip" title="{{ order.raw_created_at|format_date }}">
                                {{ order.created_at }}
                            </span>
                        </td>
                        {% if is_reviewer %}
                        <td class="d-none d-md-table-cell">
                            {% if order.assignments %} 
                                <div class="avatar-group">
                                    {% for assignment in order.assignments[:3] %}
                                        {% if assignment.employee.role == 'delivery' %}
                                            <div class="avatar avatar-xs" data-bs-toggle="tooltip" 
                                                 title="{{ assignment.employee.email }} (مندوب توصيل)">
                                                <span class="avatar-text bg-success text-white">
                                                    {{ assignment.employee.email|first|upper }}
                                                </span>
                                            </div>
                                        {% else %}
                                            <div class="avatar avatar-xs" data-bs-toggle="tooltip" 
                                                 title="{{ assignment.employee.email }} (موظف عام)">
                                                <span class="avatar-text bg-primary text-white">
                                                    {{ assignment.employee.email|first|upper }}
                                                </span>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                    {% if order.assignments|length > 3 %}
                                        <div class="avatar avatar-xs" data-bs-toggle="tooltip" 
                                             title="و {{ order.assignments|length - 3 }} أكثر">
                                            <span class="avatar-text t text-dark">
                                                +{{ order.assignments|length - 3 }}
                                            </span>
                                        </div>
                                    {% endif %}
                                </div>
                            {% else %}
                                <span class="badge  text-muted">غير مسند</span>
                            {% endif %}
                        </td>
                        {% endif %}
                        <td class="text-end pe-4 actions-cell">
                            <div class="d-flex justify-content-end gap-2">
                                {% if order.type == 'custom' %}
                                    <a href="{{ url_for('orders.custom_order_details', order_id=order.id) }}"
                                       class="btn btn-sm btn-icon btn-outline-primary rounded-circle"
                                       title="عرض التفاصيل">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                {% else %}
                                    <a href="{{ url_for('orders.order_details', order_id=order.id) }}"
                                       class="btn btn-sm btn-icon btn-outline-primary rounded-circle"
                                       title="عرض التفاصيل">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                {% endif %}
                                
                                {% if is_reviewer %}
                                <button class="btn btn-sm btn-icon btn-outline-success rounded-circle assign-single-btn" 
                                        data-order-id="{{ order.id }}" 
                                        data-order-type="{{ order.type }}" 
                                        title="إسناد سريع">
                                    <i class="fas fa-user-plus"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-between align-items-center p-4 border-top">
            <div class="d-flex align-items-center">
                <span class="text-muted small me-3">العناصر لكل صفحة:</span>
   <select class="form-select form-select-sm w-auto" id="per-page-select">
                    <option value="10" {% if pagination.per_page == 10 %}selected{% endif %}>10</option>
                    <option value="25" {% if pagination.per_page == 25 %}selected{% endif %}>25</option>
                    <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100</option>
                                        <option value="125" {% if pagination.per_page == 125 %}selected{% endif %}>125</option>
                                                            <option value="150" {% if pagination.per_page == 150 %}selected{% endif %}>150</option>
                </select
            </div>
            
           <div class="d-flex flex-column align-items-end">
    <nav aria-label="Page navigation">
        <ul class="pagination pagination-sm justify-content-center mb-1">
            {% if pagination.has_prev %}
            <li class="page-item">
                <a class="page-link" href="?page={{ pagination.prev_page }}&per_page={{ pagination.per_page }}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.employee %}&employee={{ filters.employee }}{% endif %}{% if filters.custom_status %}&custom_status={{ filters.custom_status }}{% endif %}{% if filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_to %}&date_to={{ filters.date_to }}{% endif %}{% if filters.search %}&search={{ filters.search }}{% endif %}{% if filters.order_type %}&order_type={{ filters.order_type }}{% endif %}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled"><a class="page-link" href="#"><i class="fas fa-chevron-right"></i></a></li>
            {% endif %}
            
            {% set start_page = [1, pagination.page - 2]|max %}
            {% set end_page = [pagination.total_pages, pagination.page + 2]|min %}
            {% for p in range(start_page, end_page + 1) %}
                <li class="page-item {% if p == pagination.page %}active{% endif %}">
                    <a class="page-link" href="?page={{ p }}&per_page={{ pagination.per_page }}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.employee %}&employee={{ filters.employee }}{% endif %}{% if filters.custom_status %}&custom_status={{ filters.custom_status }}{% endif %}{% if filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_to %}&date_to={{ filters.date_to }}{% endif %}{% if filters.search %}&search={{ filters.search }}{% endif %}{% if filters.order_type %}&order_type={{ filters.order_type }}{% endif %}">
                        {{ p }}
                    </a>
                </li>
            {% endfor %}

            {% if pagination.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ pagination.next_page }}&per_page={{ pagination.per_page }}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.employee %}&employee={{ filters.employee }}{% endif %}{% if filters.custom_status %}&custom_status={{ filters.custom_status }}{% endif %}{% if filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_to %}&date_to={{ filters.date_to }}{% endif %}{% if filters.search %}&search={{ filters.search }}{% endif %}{% if filters.order_type %}&order_type={{ filters.order_type }}{% endif %}">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled"><a class="page-link" href="#"><i class="fas fa-chevron-left"></i></a></li>
            {% endif %}
        </ul>
    </nav>
    <div class="text-muted small">
        عرض {{ pagination.start_item }}-{{ pagination.end_item }} من {{ pagination.total_items }}
    </div>
</div>
            </div>
        </div>

        {% else %}
        <div class="text-center py-5">
            <div class="mb-4">
                <i class="fas fa-shopping-bag fa-4x text-gray-300"></i>
            </div>
            <h4 class="mb-3 text-gray-600">لا توجد طلبات لعرضها</h4>
            <p class="text-muted mb-4">
                لم يتم العثور على طلبات تطابق معايير البحث الخاصة بك.
            </p>
            <button type="button" class="btn btn-primary rounded-pill px-4" id="reset-filters-btn">
                <i class="fas fa-undo me-2"></i>إعادة تعيين الفلاتر
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- نافذة اختيار الحالة -->
<div class="modal fade" id="changeStatusModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">تغيير حالة الطلبات المحددة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>سيتم تطبيق الحالة المحددة على <span id="selected-count-modal" class="fw-bold">0</span> طلب.</p>
                
                <div class="mb-3">
                    <label for="status-select" class="form-label">اختر الحالة:</label>
                    <select class="form-select" id="status-select">
                        <option value="">اختر حالة...</option>
                        {% for status in custom_statuses %}
                        <option value="{{ status.id }}" style="color: {{ status.color }}">{{ status.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="status-note" class="form-label">ملاحظة (اختياري):</label>
                    <textarea class="form-control" id="status-note" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" id="confirm-status-change">تأكيد</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="quickListModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">القائمة السريعة للطلبات المحددة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="selectAllQuickList" checked>
                    <label class="form-check-label fw-bold" for="selectAllQuickList">
                        تحديد جميع الطلبات
                    </label>
                    <span class="text-muted ms-2" id="selectedOrdersCountQuick">0 طلب محدد</span>
                </div>
                
                <div id="quickListContent">
                    <!-- سيتم ملء المحتوى هنا عبر JavaScript -->
                </div>
                
                <!-- قسم الإجراءات السريعة - إضافة زر الطباعة هنا -->
                <div class="mt-4 pt-3 border-top">
                    <h6 class="mb-3"><i class="fas fa-cogs me-2"></i>الإجراءات السريعة</h6>
                    <div class="row">
                        {% if is_reviewer and employees %}
                        <div class="col-md-6 mb-2">
                            <label for="quickListAssignSelect" class="form-label small">اختر موظفًا للإسناد:</label>
                            <select class="form-select mb-2" id="quickListAssignSelect">
                                <option value="">اختر موظفًا...</option>
                                {% for employee in employees %}
                                    {% if employee.role == 'general' %}
                                    <option value="{{ employee.id }}">{{ employee.email }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-primary w-100" id="quickListAssignBtn">
                                <i class="fas fa-user-plus me-1"></i> إسناد الطلبات المحددة
                            </button>
                        </div>
                        {% endif %}
                        
                        <div class="col-md-6 mb-2">
                            <label class="form-label small">طباعة المنتجات المحددة:</label>
                            <button type="button" class="btn btn-warning w-100" id="quickListPrintBtn">
                                <i class="fas fa-print me-1"></i> طباعة القائمة السريعة
                            </button>
                        </div>
                        
                        <div class="col-md-6 mb-2">
                            <button type="button" class="btn btn-info w-100" id="quickListChangeStatusBtn">
                                <i class="fas fa-tag me-1"></i> تغيير حالة الطلبات
                            </button>
                        </div>
                        
                        <div class="col-md-6 mb-2">
                            <button type="button" class="btn btn-success w-100" id="quickListDownloadBtn">
                                <i class="fas fa-download me-1"></i> تحميل كـ PDF
                            </button>
                                <button type="button" class="btn btn-outline-secondary w-100" id="toggleAllOrdersBtn">
        <i class="fas fa-eye me-1"></i> إظهار/إخفاء جميع الطلبات
    </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
            </div>
        </div>
    </div>
</div>
    </div>
</div>
<!-- نافذة تحديث حالة سلة -->
<!-- نافذة تحديث حالة سلة -->
<div class="modal fade" id="updateSallaStatusModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">تحديث حالة الطلبات في سلة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>سيتم تحديث الحالة في منصة سلة لـ <span id="selected-count-salla-modal" class="fw-bold">0</span> طلب.</p>
                
   <div class="mb-3">
    <label for="salla-status-select" class="form-label">اختر حالة سلة:</label>
    <select class="form-select" id="salla-status-select">
        <option value="">اختر حالة...</option>
        
        <!-- الحالات الأصلية من سلة -->
        <optgroup label="🛒 الحالات الأصلية من سلة">
            {% for status in order_statuses %}
                {% if status.type == 'original' and status.is_active %}
                    <option value="{{ status.slug }}" 
                            data-bs-toggle="tooltip" 
                            title="{{ status.name }} - {{ status.type }}">
                        {{ status.name }}
                    </option>
                {% endif %}
            {% endfor %}
        </optgroup> 
        
        <!-- الحالات المخصصة (إذا أردت تضمينها) -->
        <optgroup label="⚙️ الحالات المخصصة">
            {% for status in order_statuses %}
                {% if status.type == 'custom' and status.is_active %}
                    <option value="{{ status.slug }}" 
                            data-bs-toggle="tooltip" 
                            title="{{ status.name }} - {{ status.type }}">
                        {{ status.name }} (مخصص)
                    </option>
                {% endif %}
            {% endfor %}
        </optgroup>
        
    </select>
    <div class="form-text">اختر الحالة المناسبة من قائمة حالات سلة</div>
</div>
                <div class="mb-3">
                    <label for="salla-status-note" class="form-label">ملاحظة (اختياري):</label>
                    <textarea class="form-control" id="salla-status-note" rows="2" placeholder="ملاحظة تظهر في سلة..."></textarea>
                </div>
                
                <div class="alert alert-info">
                    <small>
                        <i class="fas fa-info-circle me-1"></i>
                        سيتم تحديث الحالة مباشرة في منصة سلة وقد تستغرق بضع ثوانٍ.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-warning" id="confirm-salla-status-update">
                    <i class="fas fa-sync-alt me-1"></i> تأكيد التحديث
                </button>
            </div>
        </div>
    </div>
</div>
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js" integrity="sha384-DpVxUeeBWjUvUV1czyIHJAjh+jYUZFu2lLakbdua5vbwOrBGi1UgaKCHjTC+x3Ky" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js" integrity="sha384-ssUzPQXjLHLO39a9AiuwxnnyDxIvOMUxEQpqfreUaW7jLEdDAXiF6UooZRO53F6Z" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/ar.js" integrity="sha384-WOFOhfe03USRUKDbteptsFbkQE1Sisvl6Amq1jey7Pwrbr//TWZ676qtUweo1usp" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" integrity="sha384-ms4yaO2qHEUIRbq8CXAqtz3qhnO7nYo/xAWv23Zx/iX9tT+nvVZP66kSXwT/7a0J" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js" integrity="sha384-H6KKS1H1WwuERMSm+54dYLzjg0fKqRK5ZRyASdbrI/lwrCc6bXEmtGYr5SwvP1pZ" crossorigin="anonymous"></script>

<script>
$(document).ready(function () {
    // --- المتغيرات العامة ---
    const csrfToken = "{{ csrf_token() }}";
    let currentSelectedOrders = [];
    
    // --- تهيئة المكتبات ---
    dayjs.extend(dayjs_plugin_relativeTime);
    dayjs.locale('ar');
    
    // --- تهيئة الأدوات ---
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // --- الوظائف المساعدة ---
    function updateTimestamps() {
        document.querySelectorAll('.time-ago').forEach(el => {
            const dateStr = el.getAttribute('title');
            if (dateStr) {
                el.textContent = dayjs(dateStr).fromNow();
            }
        });
    }

    function showSweetAlert(icon, title, text = '', timer = 3000) {
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: timer,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });
        
        Toast.fire({
            icon: icon,
            title: title,
            text: text
        });
    }
    
    function showConfirmDialog(title, text, confirmText, cancelText) {
        return Swal.fire({
            title: title,
            text: text,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: confirmText,
            cancelButtonText: cancelText,
            customClass: {
                confirmButton: 'btn btn-primary',
                cancelButton: 'btn btn-outline-secondary ms-2'
            },
            buttonsStyling: false
        });
    }
    
    // تحديث دالة updateAssignButtonState
function updateAssignButtonState() {
    const checkedCount = $('.order-checkbox:checked').length;
    $('#selected-orders-count').text(checkedCount);
    $('#selected-orders-count-2').text(checkedCount);
    $('#selected-orders-count-html').text(checkedCount);
    $('#selected-orders-count-salla').text(checkedCount);
    $('#selected-orders-count-address').text(checkedCount); // ⭐ إضافة العداد الجديد
    
    const buttons = $('#assign-orders-btn, #change-status-btn, #download-html-btn, #quickListViewBtn, #update-salla-status-btn, #print-addresses-btn');
    buttons.prop('disabled', checkedCount === 0);
    
    if (checkedCount > 0) {
        buttons.addClass('pulse-effect');
        setTimeout(() => buttons.removeClass('pulse-effect'), 1000);
    }
}

// إضافة حدث الزر الجديد
$(document).on('click', '#print-addresses-btn', function() {
    const selectedOrders = $('.order-checkbox:checked').map((_, el) => $(el).val()).get();
    
    if (selectedOrders.length === 0) {
        showSweetAlert('warning', 'تحذير', 'لم يتم تحديد أي طلبات لطباعة العناوين');
        return;
    }
    
    Swal.fire({
        title: 'طباعة عناوين الطلبات',
        html: `سيتم طباعة عناوين <span class="fw-bold text-primary">${selectedOrders.length}</span> طلب مع الباركود`,
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'موافق، طباعة العناوين',
        cancelButtonText: 'إلغاء',
        customClass: {
            confirmButton: 'btn btn-dark',
            cancelButton: 'btn btn-outline-secondary ms-2'
        },
        buttonsStyling: false
    }).then((result) => {
        if (result.isConfirmed) {
            const printBtn = $('#print-addresses-btn');
            const originalText = printBtn.html();
            printBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> جاري التجهيز');
            
            // فتح نافذة جديدة لمعاينة العناوين
            const previewUrl = `{{ url_for('orders.preview_addresses_html') }}?order_ids=${selectedOrders.join(',')}`;
            const previewWindow = window.open(previewUrl, '_blank');
            
            setTimeout(() => {
                printBtn.prop('disabled', false).html(originalText);
            }, 2000);
        }
    });
});

// إضافة خيار تحميل PDF للعناوين في القائمة السريعة
$(document).on('click', '#quickListDownloadAddressesBtn', function() {
    const selectedOrders = [];
    
    $('#quickListContent input.quick-list-order:checked').each(function() {
        const orderId = $(this).data('order-id');
        if (!selectedOrders.includes(orderId)) {
            selectedOrders.push(orderId);
        }
    });

    if (selectedOrders.length === 0) {
        showSweetAlert('warning', 'تحذير', 'لم يتم تحديد أي طلبات لتحميل العناوين');
        return;
    }

    const downloadBtn = $('#quickListDownloadAddressesBtn');
    const originalText = downloadBtn.html();
    downloadBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> جاري التجهيز');

    const downloadLink = document.createElement('a');
    downloadLink.href = `{{ url_for('orders.download_addresses_pdf') }}?order_ids=${selectedOrders.join(',')}`;
    downloadLink.style.display = 'none';
    downloadLink.target = '_blank';
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);

    setTimeout(() => {
        downloadBtn.prop('disabled', false).html(originalText);
        showSweetAlert('success', 'تم البدء في التحميل', 'سيبدأ تحميل ملف عناوين PDF قريباً');
    }, 1000);
});

    function buildQueryParams() {
        const params = new URLSearchParams();
        
        const status = $('#filter-order-status').val();
        const search = $('#search-order-id').val();
        const dateFrom = $('#date-from').val();
        const dateTo = $('#date-to').val();
        const perPage = $('#per-page-select').val();
        
        if (status) params.set('status', status);
        if (search) params.set('search', search);
        if (dateFrom) params.set('date_from', dateFrom);
        if (dateTo) params.set('date_to', dateTo);
        if (perPage) params.set('per_page', perPage);
        
        {% if is_reviewer %}
        const employee = $('#filter-employee').val();
        if (employee) params.set('employee', employee);
        {% endif %}
        
        const customStatus = $('#filter-custom-status').val();
        if (customStatus) params.set('custom_status', customStatus);
        
        {% if not is_reviewer %}
        const specialStatus = $('#filter-special-status').val();
        if (specialStatus) params.set('status', specialStatus);
        {% endif %}
        
        return params.toString();
    }
    
    function reloadOrders(showLoading = true) {
        if (showLoading) {
            $('#table-loading').removeClass('d-none');
        }
        
        const queryParams = buildQueryParams();
        window.location.href = `?${queryParams}`;
    }
    
    function toggleQuickListButton() {
        const selectedOrders = document.querySelectorAll('input.order-checkbox:checked');
        document.getElementById('quickListViewBtn').disabled = selectedOrders.length === 0;
    }
    
    function updateQuickListSelectionCount() {
        const selectedCount = document.querySelectorAll('#quickListContent input.quick-list-order:checked').length;
        const totalOrders = document.querySelectorAll('#quickListContent input.quick-list-order').length;
        
        document.getElementById('selectedOrdersCountQuick').textContent = `${selectedCount} طلب محدد من ${totalOrders}`;

        const buttons = ['quickListAssignBtn', 'quickListPrintBtn', 'quickListChangeStatusBtn', 'quickListDownloadBtn'];
        
        buttons.forEach(btnId => {
            const button = document.getElementById(btnId);
            if (button) {
                button.disabled = selectedCount === 0;
            }
        });

        const selectAll = document.getElementById('selectAllQuickList');
        if (selectAll && totalOrders > 0) {
            selectAll.checked = selectedCount === totalOrders;
            selectAll.indeterminate = selectedCount > 0 && selectedCount < totalOrders;
        }
    }
    
    function syncData(url, successMessage, errorMessage) {
        const btn = $(this);
        const icon = btn.find('i');
        const progressContainer = $('#sync-progress');
        const progressBar = progressContainer.find('.progress-bar');
        const detailsText = progressContainer.find('.sync-details');

        btn.prop('disabled', true);
        icon.addClass('fa-spin');
        progressContainer.removeClass('d-none');
        progressBar.css('width', '10%');
        detailsText.text('جاري الاتصال بالخادم...');

        progressBar.animate({ width: "70%" }, 1500);

        $.ajax({
            url: url,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({}),
            headers: { 'X-CSRFToken': csrfToken }
        })
        .done(function(response) {
            progressBar.css('width', '100%');
            if (response.success) {
                detailsText.text(response.message);
                showSweetAlert('success', successMessage, response.message);
                setTimeout(() => location.reload(), 2000);
            } else {
                showSweetAlert('error', errorMessage, response.error, 5000);
                btn.prop('disabled', false);
                icon.removeClass('fa-spin');
                progressContainer.addClass('d-none');
            }
        })
        .fail(function(xhr) {
            progressBar.css('width', '100%');
            const errorMsg = xhr.responseJSON?.error || 'فشل الاتصال بالخادم. تحقق من الشبكة.';
            showSweetAlert('error', 'حدث خطأ فادح', errorMsg, 5000);
            btn.prop('disabled', false);
            icon.removeClass('fa-spin');
            progressContainer.addClass('d-none');
        });
    }
    
    function assignOrders(employeeId, orders) {
        return $.ajax({
            url: "{{ url_for('orders.assign_orders') }}",
            type: "POST",
            contentType: "application/json",
            headers: { 'X-CSRFToken': csrfToken },
            data: JSON.stringify({
                employee_id: employeeId,
                orders: orders,
                current_user_id: "{{ session.get('user_id') }}"
            })
        });
    } 
    
    function getSelectedOrders() {
        return $('.order-checkbox:checked').map((_, el) => {
            const checkbox = $(el);
            const orderId = checkbox.val();
            const row = checkbox.closest('tr');
            const orderType = row.data('order-type') || 'salla';
            
            if (!orderId || orderId === 'None') {
                console.error('❌ قيمة الـ checkbox غير صالحة:', orderId);
                return null;
            }
            
            return {
                id: orderId,
                type: orderType
            };
        }).get().filter(order => order !== null);
    }
    
    function collectQuickListPrintData() {
        const productsMap = new Map();
        let totalOrders = 0;
        let totalQuantity = 0;
        let totalItems = 0;

        console.log('🔄 تجميع بيانات الطباعة المحسنة...');

        $('.product-card').each(function() {
            const $card = $(this);
            const sku = $card.data('product-sku');
            
            if (!sku) {
                console.warn('⚠️ منتج بدون SKU:', $card);
                return;
            }

            // بيانات المنتج الأساسية
            if (!productsMap.has(sku)) {
                const productName = $card.find('h6').text().trim();
                const mainImage = $card.find('img').attr('src') || '/static/images/no-image.png';
                
                // استخراج السعر
                let price = 0;
                const priceText = $card.find('.badge.bg-warning').text();
                if (priceText && priceText.includes('السعر:')) {
                    const priceMatch = priceText.match(/السعر:\s*([\d.,]+)/);
                    if (priceMatch) {
                        price = parseFloat(priceMatch[1].replace(',', '')) || 0;
                    }
                }
                
                productsMap.set(sku, {
                    sku: sku,
                    name: productName,
                    thumbnail: mainImage,
                    price: price,
                    total_quantity: 0,
                    orders: []
                });
            }

            const product = productsMap.get(sku);

            // تجميع الطلبات المحددة
            $card.find('.order-appearance').each(function() {
                const $appearance = $(this);
                const $checkbox = $appearance.find('input.quick-list-order');
                
                if (!$checkbox.is(':checked')) {
                    console.log('⏭️ تخطي طلب غير محدد:', $appearance.find('.form-check-label').text());
                    return;
                }

                const orderId = $checkbox.data('order-id');
                const referenceId = $appearance.find('.form-check-label').text()
                    .replace('الطلب #', '').trim();

                if (!orderId || !referenceId) {
                    console.warn('⚠️ طلب بدون معرف:', $appearance);
                    return;
                }

                // جمع البيانات الأساسية
                const orderData = {
                    id: orderId,
                    reference_id: referenceId,
                    customer_name: 'غير محدد',
                    customer_mobile: '',
                    created_at: '',
                    quantity: 1,
                    options: [],
                    barcode: `باركود_${referenceId}`,
                    notes: ''
                };

                // استخراج البيانات من النص
                $appearance.find('small').each(function() {
                    const text = $(this).text().trim();
                    if (text.includes('العميل:')) {
                        orderData.customer_name = text.replace('العميل:', '').trim() || 'غير محدد';
                    }
                    if (text.includes('الجوال:')) {
                        orderData.customer_mobile = text.replace('الجوال:', '').trim();
                    }
                    if (text.includes('التاريخ:')) {
                        orderData.created_at = text.replace('التاريخ:', '').trim();
                    }
                    if (text.includes('الكمية:')) {
                        const qtyText = text.replace('الكمية:', '').trim();
                        orderData.quantity = parseInt(qtyText) || 1;
                    }
                });

                // الخيارات
                // الخيارات - الكود المصحح
$appearance.find('.options-section .badge').each(function() {
    const $badge = $(this);
    
    // استخدام html() بدلاً من text() للحفاظ على التنسيق والروابط
    const optionHtml = $badge.html().trim();
    
    // إذا كان الخيار يحتوي على رابط، نتعامل معه بشكل مختلف
    if ($badge.find('a').length > 0) {
        // استخراج النص من الرابط إذا وجد
        const linkText = $badge.find('a').text().trim();
        const linkHref = $badge.find('a').attr('href') || '';
        
        orderData.options.push({
            name: 'رابط',
            value: linkText,
            href: linkHref,
            is_link: true
        });
    } else if (optionHtml.includes(':')) {
        // معالجة الخيارات العادية
        const parts = optionHtml.split(':');
        if (parts.length >= 2) {
            const name = parts[0].trim();
            const value = parts.slice(1).join(':').trim();
            orderData.options.push({
                name: name,
                value: value,
                is_link: false
            });
        }
    } else {
        // إذا لم يكن هناك نقطتين، نعتبره قيمة واحدة
        orderData.options.push({
            name: 'خيار',
            value: optionHtml,
            is_link: false
        });
    }
});
                // الملاحظات
                const $notes = $appearance.find('.notes-section .notes-text');
                if ($notes.length) {
                    orderData.notes = $notes.text().trim();
                }

                // الباركود
                const barcodeData = $appearance.data('barcode');
                if (barcodeData) {
                    orderData.barcode = barcodeData;
                }

                product.orders.push(orderData);
                product.total_quantity += orderData.quantity;
                totalQuantity += orderData.quantity;
                totalOrders++;
                totalItems++;
                
                console.log(`✅ تمت إضافة طلب #${referenceId} للمنتج ${sku}`);
            });
        });

        const products = Array.from(productsMap.values()).filter(product => product.orders.length > 0);

        console.log('📊 نتائج التجميع النهائية:', {
            products: products.length,
            orders: totalOrders,
            quantity: totalQuantity,
            items: totalItems
        });

        return {
            products: products,
            summary: {
                totalProducts: products.length,
                totalOrders: totalOrders,
                totalQuantity: totalQuantity,
                totalItems: totalItems
            }
        };
    }

    /**
     * إنشاء HTML ديناميكي للطباعة
     */
function generatePrintHTML(printData) {
    const timestamp = new Date().toLocaleDateString('ar-SA', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
    });
    
    return `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تقرير القائمة السريعة - ${timestamp}</title>
    <style>
        @page {
            size: A4;
            margin: 0.8cm;
            marks: crop cross;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        body {
            font-family: "Segoe UI", "DejaVu Sans", Arial, sans-serif;
            line-height: 1.4;
            margin: 0;
            padding: 15px;
            color: #2c3e50;
            background: #f4f7f9;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }

        .print-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .print-header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .summary-card h3 {
            margin: 0;
            font-size: 24px;
            color: #667eea;
            font-weight: 700;
        }

        .summary-card p {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .orders-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .order-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            page-break-inside: avoid;
            break-inside: avoid;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            position: relative;
        }

        .order-header {
            display: flex;
            align-items: stretch;
            gap: 12px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            margin-bottom: 8px;
            min-height: 85px;
        }

        .product-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            width: 80px;
        }

        .product-image {
            width: 70px;
            height: 70px;
            border-radius: 6px;
            object-fit: cover;
            border: 1px solid #ddd;
            -webkit-user-select: none;
            user-select: none;
        }

        .order-details {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            width: 100%;
        }

        .barcode-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            padding: 5px;
            min-height: 85px;
        }

        .barcode-image {
            width: 100%;
            height: 100%;
            max-height: 80px;
            object-fit: contain;
            -webkit-user-select: none;
            user-select: none;
        }

        /* رابط رقم الطلب - محسن للنسخ */
        .order-ref-link {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            display: block;
            letter-spacing: 0.5px;
            text-decoration: none;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s ease;
            -webkit-user-select: text;
            user-select: text;
            text-align: center;
            width: 100%;
        }

        /* تحسين التحديد للرابط */
        .order-ref-link::selection {
            background: #b3d7ff;
            color: #000;
        }

        .order-ref-link::-moz-selection {
            background: #b3d7ff;
            color: #000;
        }

        .order-quantity {
            background: #2c3e50;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 13px;
            display: inline-block;
            font-weight: 600;
            text-align: center;
            width: fit-content;
        }

        .options-section, .notes-section {
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 13px;
        }

        .options-section {
            background: #e9f5ff;
            border: 1px solid #b3d7ff;
        }

        .notes-section {
            background: #fffbe6;
            border: 1px solid #ffeccd;
        }

        .options-title, .notes-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .option-item {
            display: block;
            background: white;
            padding: 3px 8px;
            margin-bottom: 3px;
            border-radius: 4px;
            font-size: 13px;
            border: 1px solid #e0e0e0;
        }

        .no-data {
            text-align: center;
            padding: 50px;
            color: #6c757d;
            background: #fff;
            border-radius: 8px;
            grid-column: 1 / -1;
        }

        /* تأثيرات تفاعلية للرابط */
        @media (hover: hover) {
            .order-ref-link:hover {
                background: #f0f8ff;
                color: #0066cc;
                text-decoration: underline;
            }
        }

        /* نسخة الطباعة المحسنة */
        @media print {
            body {
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                color: #000000 !important;
                font-family: "Arial", "Helvetica", sans-serif !important;
                font-size: 12pt !important;
                line-height: 1.3 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }



    .link-option .option-link {
        color: #000000 !important;
        text-decoration: underline !important;
        pointer-events: none !important; /* تعطيل النقر في الطباعة */
    }
    
    /* إظهار الرابط الكامل كنص صغير عند الطباعة إذا أردت */
    .link-option .option-link:after {
        content: " (" attr(href) ")";
        font-size: 8pt !important;
        color: #666 !important;
        text-decoration: none !important;
        word-break: break-all !important;
    }
    
    /* إذا أردت إخفاء الرابط الكامل في الطباعة واحتفاظ فقط بالمختصر، احذف الكود أعلاه */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                text-rendering: optimizeLegibility !important;
                color-adjust: exact !important;
            }

            /* تحسين الروابط في الطباعة */
            .order-ref-link {
                color: #000000 !important;
                text-decoration: none !important;
                font-weight: bold !important;
                background: transparent !important;
                -webkit-user-select: text !important;
                user-select: text !important;
                cursor: text !important;
                font-size: 12pt !important;
            }

            .print-header {
                display: block !important;
                background: #ffffff !important;
                color: #000000 !important;
                box-shadow: none !important;
                border: 2px solid #000000 !important;
                padding: 15px !important;
                margin-bottom: 15px !important;
                page-break-after: avoid;
            }
            
            .summary-grid {
                display: grid !important;
                background: white !important;
                margin-bottom: 15px !important;
                page-break-after: avoid;
            }
            
            .summary-card {
                background: #ffffff !important;
                border: 1px solid #000000 !important;
                box-shadow: none !important;
                color: #000000 !important;
            }
            
            .summary-card h3, .summary-card p {
                color: #000000 !important;
                font-weight: bold !important;
            }
            
            .orders-container {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 8px !important;
            }
            
            .order-card {
                border: 1px solid #000000 !important;
                box-shadow: none !important;
                background: #ffffff !important;
                padding: 8px !important;
                color: #000000 !important;
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            .product-section {
                width: 75px !important;
            }
            
            .product-image {
                display: block !important;
                width: 65px !important;
                height: 65px !important;
                border: 1px solid #000000 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                max-width: 100% !important;
            }

            .barcode-container {
                background: #ffffff !important;
                border: 1px solid #000000 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                min-height: 80px !important;
            }
            
            .barcode-image {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                
                background: #fff !important;
                image-rendering: -webkit-optimize-contrast !important;
                image-rendering: crisp-edges !important;
                max-height: 75px !important;
            }
            
            .order-quantity {
                background: #ffffff !important;
                color: #000000 !important;
                border: 1px solid #000000 !important;
                font-size: 11pt !important;
            }
            
            .options-section, .notes-section {
                background: #ffffff !important;
                border: 1px solid #000000 !important;
                color: #000000 !important;
            }
            
            .option-item {
                background: #ffffff !important;
                border: 1px solid #cccccc !important;
            }

            /* منع انقطاع العناصر */
            h1, h2, h3, h4, h5, h6 {
                page-break-after: avoid;
            }
            
            table, figure, .order-card {
                page-break-inside: avoid;
            }
        }
        
        /* تحسين إخفاء الصور التالفة */
        .product-image[style*="display: none"] {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="print-header">
        <h1>تقرير القائمة السريعة</h1>
        <p>تاريخ التقرير: ${timestamp}</p>
    </div>

    <div class="summary-grid">
        <div class="summary-card">
            <h3>${printData.summary.totalProducts}</h3>
            <p>عدد المنتجات</p>
        </div>
        <div class="summary-card">
            <h3>${printData.summary.totalOrders}</h3>
            <p>عدد الطلبات</p>
        </div>
        <div class="summary-card">
            <h3>${printData.summary.totalQuantity}</h3>
            <p>إجمالي الكميات</p>
        </div>
        <div class="summary-card">
            <h3>${printData.summary.totalItems}</h3>
            <p>إجمالي العناصر</p>
        </div>
    </div>

    <div class="orders-container">
        ${generateOrdersHTML(printData.products)}
    </div>

    <script>
        // طباعة تلقائية عند التحميل
        window.addEventListener('load', function() {
            // تحسين جودة الصور قبل الطباعة
            const images = document.querySelectorAll('img');
            images.forEach(img => {
                img.loading = 'eager';
                img.fetchPriority = 'high';
            });

            setTimeout(() => {
                window.print();
            }, 500);
        });
        
        // معالجة الصور التالفة وتحسين النصوص
        document.addEventListener('DOMContentLoaded', function() {
            const images = document.querySelectorAll('.product-image, .barcode-image');
            images.forEach(img => {
                img.addEventListener('error', function() {
                    this.style.display = 'none';
                    // إذا كانت صورة الباركود تالفة، نخفي الحاوية كاملة
                    if (this.classList.contains('barcode-image')) {
                        this.closest('.barcode-container').style.display = 'none';
                    }
                });
                
                img.addEventListener('load', function() {
                    this.style.imageRendering = 'auto';
                });
            });

            // تحسين قابلية نسخ الروابط
            const links = document.querySelectorAll('.order-ref-link');
            links.forEach(link => {
                // إضافة وظيفة نسخ عند النقر
                link.addEventListener('click', function(e) {
                    if (!window.getSelection().toString()) {
                        e.preventDefault();
                        const orderNumber = this.getAttribute('href').replace('#', '');
                        navigator.clipboard.writeText(orderNumber).then(() => {
                            // تأكيد النسخ (يمكن إضافته إذا لزم الأمر)
                            console.log('تم نسخ رقم الطلب: ' + orderNumber);
                        });
                    }
                });

                // جعل الرابط قابل للتحديد بسهولة
                link.style.webkitUserSelect = 'text';
                link.style.mozUserSelect = 'text';
                link.style.msUserSelect = 'text';
                link.style.userSelect = 'text';
            });

            // جعل كل النصوص قابلة للتحديد
            const textElements = document.querySelectorAll('.options-title, .notes-title, .option-item, .notes-content');
            textElements.forEach(el => {
                el.style.webkitUserSelect = 'text';
                el.style.mozUserSelect = 'text';
                el.style.msUserSelect = 'text';
                el.style.userSelect = 'text';
            });
        });

        // منع السلوك الافتراضي لقائمة السياق على الروابط
        document.addEventListener('contextmenu', function(e) {
            if (e.target.classList.contains('order-ref-link')) {
                e.stopPropagation();
                return;
            }
            
            const selection = window.getSelection();
            if (selection.toString().length > 0) {
                e.stopPropagation();
            }
        });
    <\/script>
</body>
</html>`;
}

/**
 * Generates HTML for orders in the print view
 */
function generateOrdersHTML(products) {
    if (!products || products.length === 0) {
        return '<div class="no-data"><h3>لا توجد بيانات للعرض</h3><p>يمكنك إضافة طلبات جديدة لتظهر في هذا التقرير.</p></div>';
    }

    let html = '';
    products.forEach(product => {
        product.orders.forEach(order => {
            html += `
                <div class="order-card">
                    <div class="order-header">
                        <div class="product-section">
                            <img src="${product.thumbnail}" alt="صورة المنتج: ${product.name}" 
                                 class="product-image"
                                 onerror="this.style.display='none'">
                            <div class="order-details">
                                <a href="#${order.reference_id}" class="order-ref-link" title="انقر لنسخ رقم الطلب">#${order.reference_id}</a>
                                <span class="order-quantity">${order.quantity} الكمية</span>
                            </div>
                        </div>
                        ${order.barcode && order.barcode !== `باركود_${order.reference_id}` ? `
                            <div class="barcode-container">
                                <img src="${order.barcode}" alt="باركود الطلب ${order.reference_id}" class="barcode-image"
                                     onerror="this.style.display='none'">
                            </div>
                        ` : '<div class="barcode-container" style="background: transparent; border: none;"></div>'}
                    </div>
      ${order.options && order.options.length > 0 ? `
    <div class="options-section">
        <div class="options-title">الخيارات:</div>
        ${order.options.map(opt => {
            if (opt.is_link && opt.href) {
                // عرض الروابط مختصرة (أول 6 أحرف) مع "..." في الطباعة
                let displayValue = opt.value;
                if (displayValue.length > 6) {
                    displayValue = displayValue.substring(0, 6) + '...';
                }
                return `<span class="option-item link-option">
                    ${opt.name}: <a href="${opt.href}" target="_blank" class="option-link" title="${opt.value}">${displayValue}</a>
                </span>`;
            } else {
                return `<span class="option-item">${opt.name}: ${opt.value}</span>`;
            }
        }).join('')}
    </div>
` : ''}                   
                    ${order.notes ? `
                        <div class="notes-section">
                            <div class="notes-title">ملاحظات:</div>
                            <div class="notes-content">${order.notes}</div>
                        </div>
                    ` : ''}
                </div>
            `;
        });
    });
    
    return html;
}
    // ⭐ الدالة المصححة هنا ⭐
    function openQuickListPrint() {
        try {
            const printData = collectQuickListPrintData();
            
            console.log('🖨️ تحضير الطباعة الفورية:', printData);
            
            if (printData.products.length === 0) {
                showSweetAlert('warning', 'لا توجد بيانات', 'لم يتم تحديد أي طلبات للطباعة');
                return false;
            }
            
            // إنشاء HTML كامل مع البيانات
            const htmlContent = generatePrintHTML(printData);
            
            // إنشاء Blob من المحتوى
            const blob = new Blob([htmlContent], { type: 'text/html; charset=utf-8' });
            const blobUrl = URL.createObjectURL(blob);
            
            // فتح النافذة مع Blob URL
            const printWindow = window.open(blobUrl, '_blank', 
                'width=1200,height=800,scrollbars=yes,resizable=yes');
            
            if (!printWindow) {
                URL.revokeObjectURL(blobUrl);
                throw new Error('تم منع النافذة المنبثقة. يرجى السماح بالنوافذ المنبثقة لهذا الموقع.');
            }
            
            // تنظيف Blob URL بعد فتح النافذة
            printWindow.addEventListener('load', function() {
                setTimeout(() => {
                    URL.revokeObjectURL(blobUrl);
                    console.log('🧹 تم تنظيف Blob URL');
                }, 1000);
            });
            
            showSweetAlert('success', 'تم فتح نافذة الطباعة', 
                `يتم الآن تحميل ${printData.summary.totalOrders} طلب للطباعة الفورية`);
            
            return true;
            
        } catch (error) {
            console.error('❌ خطأ في الطباعة:', error);
            showSweetAlert('error', 'خطأ في الطباعة', 
                error.message || 'حدث خطأ أثناء فتح نافذة الطباعة. يرجى المحاولة مرة أخرى.');
            return false;
        }
    }

    /**
     * التحقق من البيانات قبل الطباعة
     */
    function validatePrintData() {
        const selectedCount = $('#quickListContent input.quick-list-order:checked').length;
        const productCount = $('.product-card').length;
        
        console.log('🔍 التحقق من البيانات:', {
            selectedOrders: selectedCount,
            products: productCount
        });
        
        if (selectedCount === 0) {
            showSweetAlert('warning', 'لم يتم التحديد', 'يرجى تحديد طلبات للطباعة أولاً');
            return false;
        }
        
        if (productCount === 0) {
            showSweetAlert('warning', 'لا توجد منتجات', 'لا توجد منتجات معروضة في القائمة السريعة');
            return false;
        }
        
        return true;
    }

    // --- دوال تحديث حالة سلة ---

    function getSelectedOrdersForSalla() {
        return $('.order-checkbox:checked').map((_, el) => {
            return $(el).val();
        }).get();
    }

    function updateSallaOrdersStatus(orderIds, statusSlug, note = '') {
        const btn = $('#confirm-salla-status-update');
        const originalText = btn.html();
        
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> جاري التحديث في سلة');
        
        console.log('🔧 الطلبات المحددة:', orderIds);
        
        $.ajax({
            url: "{{ url_for('orders.bulk_update_salla_status') }}",
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            data: JSON.stringify({
                order_ids: orderIds,
                status_slug: statusSlug,
                note: note
            }),
            timeout: 60000
        })
        .done(function(response) {
            console.log('🔧 استجابة السيرفر:', response);
            
            if (response.success) {
                let successMessage = `تم تحديث ${response.updated_count} طلب بنجاح في سلة`;
                
                if (response.failed_orders && response.failed_orders.length > 0) {
                    successMessage += ` (فشل ${response.failed_count} طلب)`;
                    
                    setTimeout(() => {
                        Swal.fire({
                            icon: 'warning',
                            title: 'بعض الطلبات فشل تحديثها',
                            html: `
                                <div class="text-start" style="max-height: 300px; overflow-y: auto;">
                                    <p class="small text-muted mb-3">تفاصيل الأخطاء:</p>
                                    <ul class="list-unstyled mb-0">
                                        ${response.failed_orders.map(order => 
                                            `<li class="small text-danger mb-2">❌ ${order}</li>`
                                        ).join('')}
                                    </ul>
                                </div>
                            `,
                            confirmButtonText: 'موافق',
                            width: '700px'
                        });
                    }, 1500);
                }
                
                showSweetAlert('success', 'تم التحديث', successMessage);
                
                setTimeout(() => {
                    $('#updateSallaStatusModal').modal('hide');
                    location.reload();
                }, 3000);
            } else {
                let errorMessage = response.error || 'فشل التحديث';
                
                if (response.failed_orders && response.failed_orders.length > 0) {
                    errorMessage += `<br><small class="text-muted">${response.failed_orders[0]}</small>`;
                }
                
                Swal.fire({
                    icon: 'error',
                    title: 'فشل التحديث',
                    html: errorMessage,
                    confirmButtonText: 'موافق'
                });
            }
        })
        .fail(function(xhr, status, error) {
            console.error('💥 خطأ في الاتصال:', error);
            
            let errorMsg = 'فشل الاتصال بالخادم';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMsg = xhr.responseJSON.error;
            } else if (status === 'timeout') {
                errorMsg = 'انتهت مهلة الاتصال. حاول مرة أخرى.';
            }
            
            Swal.fire({
                icon: 'error',
                title: 'خطأ في الاتصال',
                text: errorMsg,
                confirmButtonText: 'موافق'
            });
        })
        .always(function() {
            btn.prop('disabled', false).html(originalText);
        });
    }

    // --- دوال القائمة السريعة ---

    function updateProductSelectionCount(productSku) {
        const totalOrders = $(`.order-checkbox-${productSku}`).length;
        const selectedOrders = $(`.order-checkbox-${productSku}:checked`).length;
        
        $(`.selected-orders-count[data-sku="${productSku}"]`).text(`${selectedOrders}/${totalOrders} محدد`);
    }


    function updateProductCheckboxState(productSku) {
        const totalOrders = $(`.order-checkbox-${productSku}`).length;
        const selectedOrders = $(`.order-checkbox-${productSku}:checked`).length;
        const productCheckbox = $(`#product-${productSku}`);
        
        if (selectedOrders === 0) {
            productCheckbox.prop('checked', false);
            productCheckbox.prop('indeterminate', false);
        } else if (selectedOrders === totalOrders) {
            productCheckbox.prop('checked', true);
            productCheckbox.prop('indeterminate', false);
        } else {
            productCheckbox.prop('checked', false);
            productCheckbox.prop('indeterminate', true);
        }
    }

    // --- الأحداث الرئيسية ---

    // 1. تحديد الطلبات
    $(document).on('change', '#select-all, #select-all-header', function() {
        const isChecked = this.checked;
        $('.order-checkbox').prop('checked', isChecked);
        
        if (isChecked) {
            $('.order-checkbox').closest('tr').addClass('selected-row');
        } else {
            $('.order-checkbox').closest('tr').removeClass('selected-row');
        }
        
        updateAssignButtonState();
    });

    $(document).on('change', '.order-checkbox', function() {
        const allChecked = $('.order-checkbox:checked').length === $('.order-checkbox').length;
        $('#select-all, #select-all-header').prop('checked', allChecked);
        
        if ($(this).is(':checked')) {
            $(this).closest('tr').addClass('selected-row');
        } else {
            $(this).closest('tr').removeClass('selected-row');
        }
        
        updateAssignButtonState();
        toggleQuickListButton();
    });

    // 2. إسناد الطلبات
    $(document).on('click', '#assign-orders-btn', function() {
        const selectedOrders = getSelectedOrders();
        
        const employeeOptions = {
            '': 'اختر موظفًا...'
            {% for employee in employees %}
                {% if employee.role == 'general' %}
                    ,"{{ employee.id }}": "{{ employee.email }}"
                {% endif %}
            {% endfor %}
        };
        
        Swal.fire({
            title: 'إسناد الطلبات المحددة',
            html: `سيتم إسناد <span class="fw-bold text-primary">${selectedOrders.length}</span> طلب إلى الموظف المحدد.`,
            input: 'select',
            inputOptions: employeeOptions,
            inputPlaceholder: 'اختر موظفًا...',
            showCancelButton: true,
            confirmButtonText: 'تأكيد الإسناد',
            cancelButtonText: 'إلغاء',
            showLoaderOnConfirm: true,
            customClass: {
                confirmButton: 'btn btn-primary',
                cancelButton: 'btn btn-outline-secondary ms-2'
            },
            buttonsStyling: false,
            inputValidator: (value) => {
                if (!value) return 'يجب اختيار موظف للإسناد';
            },
            preConfirm: (employeeId) => {
                return assignOrders(employeeId, selectedOrders)
                    .fail((xhr) => {
                        const errorMsg = xhr.responseJSON?.error || 'فشل الإسناد لسبب غير معروف.';
                        Swal.showValidationMessage(`فشل الطلب: ${errorMsg}`);
                    });
            },
            allowOutsideClick: () => !Swal.isLoading()
        }).then((result) => {
            if (result.isConfirmed && result.value.success) {
                showSweetAlert('success', 'تم الإسناد بنجاح!', result.value.message);
                setTimeout(() => location.reload(), 1500);
            }
        });
    });
    
    $(document).on('click', '.assign-single-btn', function(e) {
        e.stopPropagation();
        const orderId = $(this).data('order-id');
        const orderType = $(this).data('order-type');
        
        const employeeOptions = {
            '': 'اختر موظفًا...'
            {% for employee in employees %}
                {% if employee.role == 'general' %}
                    ,"{{ employee.id }}": "{{ employee.email }}"
                {% endif %}
            {% endfor %}
        };
        
        Swal.fire({
            title: 'إسناد الطلب #' + orderId,
            input: 'select',
            inputOptions: employeeOptions,
            inputPlaceholder: 'اختر موظفًا...',
            showCancelButton: true,
            confirmButtonText: 'تأكيد الإسناد',
            cancelButtonText: 'إلغاء',
            showLoaderOnConfirm: true,
            customClass: {
                confirmButton: 'btn btn-primary',
                cancelButton: 'btn btn-outline-secondary ms-2'
            },
            buttonsStyling: false,
            inputValidator: (value) => {
                if (!value) return 'يجب اختيار موظف للإسناد';
            },
            preConfirm: (employeeId) => {
                return assignOrders(employeeId, [{ id: orderId, type: orderType }])
                    .fail((xhr) => {
                        const errorMsg = xhr.responseJSON?.error || 'فشل الإسناد لسبب غير معروف.';
                        Swal.showValidationMessage(`فشل الطلب: ${errorMsg}`);
                    });
            },
            allowOutsideClick: () => !Swal.isLoading()
        }).then((result) => {
            if (result.isConfirmed && result.value.success) {
                showSweetAlert('success', 'تم الإسناد بنجاح!', result.value.message);
                setTimeout(() => location.reload(), 1500);
            }
        });
    });
    
    // 3. تغيير حالة الطلبات
    $(document).on('click', '#change-status-btn', function() {
        const orderIds = $('.order-checkbox:checked').map((_, el) => $(el).val()).get();
        $('#selected-count-modal').text(orderIds.length);
        $('#changeStatusModal').modal('show');
    });
    
    $(document).on('click', '#confirm-status-change', function() {
        const orderIds = $('.order-checkbox:checked').map((_, el) => $(el).val()).get();
        const statusId = $('#status-select').val();
        const note = $('#status-note').val();
        
        if (!statusId) {
            showSweetAlert('warning', 'تحذير', 'يجب اختيار حالة');
            return;
        }
        
        $('#changeStatusModal').modal('hide');
        
        $.ajax({
            url: "{{ url_for('orders.bulk_update_status') }}",
            type: "POST",
            contentType: "application/json",
            headers: { 'X-CSRFToken': csrfToken },
            data: JSON.stringify({
                order_ids: orderIds,
                status_id: statusId,
                note: note
            }),
        })
        .done(function(response) {
            if (response.success) {
                showSweetAlert('success', 'نجح التحديث!', response.message);
                setTimeout(() => location.reload(), 1500);
            } else {
                showSweetAlert('error', 'فشل التحديث', response.error);
            }
        })
        .fail(function(xhr) {
            const errorMsg = xhr.responseJSON?.error || 'فشل الاتصال بالخادم';
            showSweetAlert('error', 'حدث خطأ', errorMsg);
        });
    });
    
    // 4. الفلاتر والبحث
    $(document).on('submit', '#advanced-filters', function(e) {
        e.preventDefault();
        reloadOrders();
    });
    
    $(document).on('input', '#search-order-id', _.debounce(function() {
        reloadOrders();
    }, 500));
    
    $(document).on('change', '#filter-order-status, #filter-employee, #filter-custom-status, #filter-special-status, #per-page-select', _.debounce(function() {
        reloadOrders();
    }, 300));
    
    // 5. إعادة تعيين الفلاتر
    $(document).on('click', '#reset-filters, #reset-filters-btn', function() {
        window.location.href = "{{ url_for('orders.index') }}";
    });

    // 6. النقر على صف الجدول
    $(document).on('click', '.clickable-row', function(e) {
        if ($(e.target).is('input, button, a, i') || $(e.target).closest('button, a, .actions-cell').length) {
            return;
        }
        
        const orderId = $(this).data('order-id');
        const orderType = $(this).data('order-type');
        
        let url;
        if (orderType === 'custom') {
            url = "{{ url_for('orders.custom_order_details', order_id=0) }}".replace('0', orderId);
        } else {
            url = "{{ url_for('orders.order_details', order_id=0) }}".replace('0', orderId);
        }
        
        window.location.href = url;
    });
    
    // 7. القائمة السريعة
    $(document).on('click', '#quickListViewBtn', function() {
        const selectedOrders = $('.order-checkbox:checked').map((_, el) => $(el).val()).get();
        
        if (selectedOrders.length === 0) {
            showSweetAlert('warning', 'تحذير', 'يرجى تحديد طلب واحد على الأقل');
            return;
        }

        currentSelectedOrders = selectedOrders;

        $('#quickListContent').html(`
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">جاري التحميل...</span>
                </div>
                <p class="mt-2">جاري تحميل بيانات الطلبات...</p>
            </div>
        `);

        $('#quickListModal').modal('show');

        $.ajax({
            url: "{{ url_for('orders.get_quick_list_data') }}",
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            data: JSON.stringify({ order_ids: selectedOrders })
        })
        .done(function(data) {
            if (data.success) {
                let html = '';
                
                if (data.products && data.products.length > 0) {
                    data.products.forEach(product => {
                        html += `
    <div class="card mb-4 product-card" data-product-sku="${product.sku}">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <div class="form-check me-3">
                    <input class="form-check-input product-checkbox" type="checkbox" 
                           id="product-${product.sku}" data-sku="${product.sku}" checked>
                    <label class="form-check-label" for="product-${product.sku}"></label>
                </div>
                <img src="${product.main_image || '/static/images/no-image.png'}" 
                     alt="${product.name}" 
                     class="img-thumbnail me-3" 
                     style="width: 60px; height: 60px; object-fit: cover;"
                     onerror="this.src='/static/images/no-image.png'">
                <div>
                    <h6 class="mb-1 fw-bold">${product.name}</h6>
                    <small class="text-muted">SKU: ${product.sku}</small>
                    <div class="mt-1">
                        <span class="badge bg-primary">الكمية الإجمالية: ${product.total_quantity}</span>
                        <span class="badge bg-secondary ms-2">موجود في ${product.appearances_count} طلب</span>
                        ${product.price ? `<span class="badge bg-warning ms-2">السعر: ${product.price} ر.س</span>` : ''}
                    </div>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <div class="product-selection-info me-3">
                    <small class="text-muted selected-orders-count" data-sku="${product.sku}">
                        ${product.order_appearances.length}/${product.order_appearances.length} محدد
                    </small>
                </div>
                <button class="btn btn-sm btn-outline-primary toggle-orders-btn" 
                        type="button" 
                        data-sku="${product.sku}"
                        title="إظهار/إخفاء الطلبات">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
        </div>
        <div class="card-body orders-container" id="orders-${product.sku}" style="display: none;">
            <h6 class="border-bottom pb-2 mb-3">تفاصيل الطلبات:</h6>
                        `;

                        product.order_appearances.forEach((appearance, index) => {
                            const barcodeData = appearance.barcode || '';
                            
                            html += `
            <div class="order-appearance mb-3 p-3 border rounded ${index > 0 ? 'mt-2' : ''}" 
                 data-barcode="${barcodeData}">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center">
                            <input class="form-check-input me-2 quick-list-order order-checkbox-${product.sku}" 
                                   type="checkbox" 
                                   value="${appearance.order_id}" 
                                   id="order-${appearance.order_id}-${product.sku}"
                                   data-order-id="${appearance.order_id}"
                                   data-product-sku="${product.sku}"
                                   checked>
                            <label class="form-check-label fw-bold" for="order-${appearance.order_id}-${product.sku}">
                                الطلب #${appearance.reference_id}
                            </label>
                        </div>
                        <div class="ms-4 mt-2">
                            <small class="text-muted d-block">
                                <i class="fas fa-user me-1"></i> العميل: ${appearance.customer_name || 'غير محدد'}
                            </small>
                            <small class="text-muted d-block">
                                <i class="fas fa-calendar me-1"></i> التاريخ: ${appearance.created_at}
                            </small>
                            <small class="text-muted d-block">
                                <i class="fas fa-box me-1"></i> الكمية: ${appearance.quantity}
                            </small>
                            ${appearance.customer_mobile ? `
                            <small class="text-muted d-block">
                                <i class="fas fa-phone me-1"></i> الجوال: ${appearance.customer_mobile}
                            </small>
                            ` : ''}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="options-section mb-2">
                            <strong class="small d-block mb-1">الخيارات:</strong>
                            `;

                            if (appearance.options && appearance.options.length > 0) {
                                appearance.options.forEach(option => {
                                    html += `
                            <span class="badge bg-light text-dark me-1 mb-1 small">
                                ${option.name}: ${option.value}
                            </span>
                                    `;
                                });
                            } else {
                                html += `<span class="text-muted small">لا توجد خيارات</span>`;
                            }

                            html += `
                        </div>
                        
                        ${appearance.notes ? `
                        <div class="notes-section mt-2 p-2 bg-info bg-opacity-10 border border-info rounded">
                            <strong class="small d-block mb-1 text-info">
                                <i class="fas fa-sticky-note me-1"></i>ملاحظات:
                            </strong>
                            <span class="notes-text small">${appearance.notes}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
                            `;
                        });

                        html += `
        </div>
    </div>
                        `;
                    });
                } else {
                    html = `
                    <div class="alert alert-warning text-center py-4">
                        <i class="fas fa-box-open fa-2x mb-3 text-warning"></i>
                        <h5 class="alert-heading">لا توجد منتجات</h5>
                        <p class="mb-0">لم يتم العثور على أي منتجات في الطلبات المحددة</p>
                    </div>
                    `;
                }
                
                $('#quickListContent').html(html);
                updateQuickListSelectionCount();
                updateProductSelectionCounts();
                
                showSweetAlert('success', 'تم التحميل بنجاح', 
                    `تم تحميل ${data.products?.length || 0} منتج من ${data.stats?.successful_orders || 0} طلب`);
                
            } else {
                $('#quickListContent').html(`
                    <div class="alert alert-danger text-center py-4">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3 text-danger"></i>
                        <h5 class="alert-heading">حدث خطأ</h5>
                        <p class="mb-0">${data.error || 'حدث خطأ أثناء جلب البيانات'}</p>
                    </div>
                `);
            }
        })
        .fail(function(error) {
            $('#quickListContent').html(`
                <div class="alert alert-danger">حدث خطأ في الاتصال: ${error.statusText}</div>
            `);
        });
    });

    // 8. تحديث حالة سلة
    $(document).on('click', '#update-salla-status-btn', function() {
        const selectedOrders = getSelectedOrdersForSalla();
        
        console.log('🔍 الطلبات المحددة:', selectedOrders);
        
        if (selectedOrders.length === 0) {
            showSweetAlert('warning', 'تحذير', 'لم يتم تحديد أي طلبات');
            return;
        }
        
        $('#selected-count-salla-modal').text(selectedOrders.length);
        $('#updateSallaStatusModal').modal('show');
    });

    $(document).on('click', '#confirm-salla-status-update', function() {
        const selectedOrders = getSelectedOrdersForSalla();
        const statusSlug = $('#salla-status-select').val();
        const note = $('#salla-status-note').val();
        
        if (!statusSlug) {
            showSweetAlert('warning', 'تحذير', 'يجب اختيار حالة سلة');
            return;
        }
        
        updateSallaOrdersStatus(selectedOrders, statusSlug, note);
    });

    // 9. إعادة تعيين حقول تحديث سلة
    $('#updateSallaStatusModal').on('show.bs.modal', function () {
        $('#salla-status-select').val('');
        $('#salla-status-note').val('');
    });

    // 10. أحداث القائمة السريعة
    // 10. أحداث القائمة السريعة - الإصدار المصحح
$(document).on('change', '#selectAllQuickList', function() {
    const isChecked = this.checked;
    
    // تحديث جميع صناديق الاختيار
    $('#quickListContent input.quick-list-order').prop('checked', isChecked);
    $('#quickListContent input.product-checkbox').prop('checked', isChecked);
    $('#quickListContent input.product-checkbox').prop('indeterminate', false);
    
    // تحديث جميع العدادات
    updateQuickListSelectionCount();
    updateProductSelectionCounts();
});
    $(document).on('change', '#quickListContent input.quick-list-order', function() {
        updateQuickListSelectionCount();
    });
    
    // 11. إسناد من القائمة السريعة
    $(document).on('click', '#quickListAssignBtn', function() {
        const employeeId = $('#quickListAssignSelect').val();
        const selectedOrders = [];
        
        $('#quickListContent input.quick-list-order:checked').each(function() {
            const orderId = $(this).data('order-id');
            if (!selectedOrders.find(order => order.id === orderId)) {
                selectedOrders.push({
                    id: orderId,
                    type: 'salla'
                });
            }
        });

        if (!employeeId) {
            showSweetAlert('warning', 'تحذير', 'يرجى اختيار موظف للإسناد');
            return;
        }

        if (selectedOrders.length === 0) {
            showSweetAlert('warning', 'تحذير', 'لم يتم تحديد أي طلبات للإسناد');
            return;
        }

        const assignBtn = $('#quickListAssignBtn');
        const originalText = assignBtn.html();
        assignBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> جاري الإسناد');

        assignOrders(employeeId, selectedOrders)
            .done(function(data) {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'تم الإسناد بنجاح',
                        text: data.message || `تم إسناد ${selectedOrders.length} طلب إلى الموظف المحدد`,
                        confirmButtonText: 'موافق',
                        customClass: {
                            confirmButton: 'btn btn-success'
                        }
                    }).then(() => {
                        $('#quickListModal').modal('hide');
                        location.reload();
                    });
                } else {
                    throw new Error(data.error || 'حدث خطأ غير متوقع أثناء الإسناد');
                }
            })
            .fail(function(error) {
                assignBtn.prop('disabled', false).html(originalText);
                const errorMsg = error.responseJSON?.error || error.statusText || 'حدث خطأ أثناء محاولة الإسناد';
                
                Swal.fire({
                    icon: 'error',
                    title: 'فشل الإسناد',
                    text: errorMsg,
                    confirmButtonText: 'موافق',
                    customClass: {
                        confirmButton: 'btn btn-danger'
                    }
                });
            });
    });
    
    // 12. تحميل HTML
    $(document).on('click', '#download-html-btn', function() {
        const selectedOrders = $('.order-checkbox:checked').map((_, el) => $(el).val()).get();
        
        if (selectedOrders.length === 0) {
            showSweetAlert('warning', 'تحذير', 'لم يتم تحديد أي طلبات للتحميل');
            return;
        }
        
        Swal.fire({
            title: 'تحميل الطلبات',
            html: `سيتم تحميل <span class="fw-bold text-primary">${selectedOrders.length}</span> طلب كملف HTML يعمل بدون اتصال`,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'موافق، تحميل HTML',
            cancelButtonText: 'إلغاء',
            customClass: {
                confirmButton: 'btn btn-primary',
                cancelButton: 'btn btn-outline-secondary ms-2'
            },
            buttonsStyling: false
        }).then((result) => {
            if (result.isConfirmed) {
                const downloadBtn = $('#download-html-btn');
                const originalText = downloadBtn.html();
                downloadBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> جاري التجهيز');
                
                const downloadLink = document.createElement('a');
                downloadLink.href = `{{ url_for('orders.download_orders_html') }}?order_ids=${selectedOrders.join(',')}`;
                downloadLink.style.display = 'none';
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                setTimeout(() => {
                    downloadBtn.prop('disabled', false).html(originalText);
                }, 2000);
            }
        });
    });
    
    // 13. تغيير الحالة من القائمة السريعة
    $(document).on('click', '#quickListChangeStatusBtn', function() {
        const selectedOrders = [];
        $('#quickListContent input.quick-list-order:checked').each(function() {
            selectedOrders.push($(this).val());
        });

        if (selectedOrders.length === 0) {
            showSweetAlert('warning', 'تحذير', 'يرجى تحديد طلب واحد على الأقل لتغيير الحالة');
            return;
        }

        $('#quickListModal').modal('hide');
        
        setTimeout(() => {
            $('#selected-count-modal').text(selectedOrders.length);
            $('#changeStatusModal').data('selected-orders', selectedOrders);
            $('#changeStatusModal').modal('show');
        }, 300);
    });

    // 14. طباعة القائمة السريعة
    $(document).on('click', '#quickListPrintBtn', function() {
        if (!validatePrintData()) {
            return;
        }
        
        const $btn = $(this);
        const originalHtml = $btn.html();
        
        $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> جاري الإنشاء');
        
        setTimeout(() => {
            const success = openQuickListPrint();
            
            setTimeout(() => {
                $btn.prop('disabled', false).html(originalHtml);
            }, success ? 1000 : 2000);
        }, 300);
    });

    // 15. تحميل PDF من القائمة السريعة
    $(document).on('click', '#quickListDownloadBtn', function() {
        const selectedOrders = [];
        
        $('#quickListContent input.quick-list-order:checked').each(function() {
            const orderId = $(this).data('order-id');
            if (!selectedOrders.includes(orderId)) {
                selectedOrders.push(orderId);
            }
        });

        if (selectedOrders.length === 0) {
            showSweetAlert('warning', 'تحذير', 'لم يتم تحديد أي طلبات للتحميل');
            return;
        }

        const downloadBtn = $('#quickListDownloadBtn');
        const originalText = downloadBtn.html();
        downloadBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> جاري التجهيز');

        const downloadLink = document.createElement('a');
        downloadLink.href = `{{ url_for('orders.download_pdf') }}?order_ids=${selectedOrders.join(',')}`;
        downloadLink.style.display = 'none';
        downloadLink.target = '_blank';
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);

        setTimeout(() => {
            downloadBtn.prop('disabled', false).html(originalText);
            showSweetAlert('success', 'تم البدء في التحميل', 'سيبدأ تحميل ملف PDF قريباً');
        }, 1000);
    });

    // 16. أحداث إظهار/إخفاء الطلبات
    $(document).on('click', '.toggle-orders-btn', function() {
        const sku = $(this).data('sku');
        const ordersContainer = $(`#orders-${sku}`);
        const icon = $(this).find('i');
        
        if (ordersContainer.is(':visible')) {
            ordersContainer.slideUp(300);
            icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
            $(this).attr('title', 'إظهار الطلبات');
        } else {
            ordersContainer.slideDown(300);
            icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
            $(this).attr('title', 'إخفاء الطلبات');
        }
    });

    $(document).on('click', '#toggleAllOrdersBtn', function() {
        const allContainers = $('.orders-container');
        const allButtons = $('.toggle-orders-btn');
        const icon = $(this).find('i');
        
        if (allContainers.first().is(':visible')) {
            allContainers.slideUp(300);
            allButtons.find('i').removeClass('fa-chevron-up').addClass('fa-chevron-down');
            allButtons.attr('title', 'إظهار الطلبات');
            icon.removeClass('fa-eye-slash').addClass('fa-eye');
            $(this).attr('title', 'إظهار جميع الطلبات');
        } else {
            allContainers.slideDown(300);
            allButtons.find('i').removeClass('fa-chevron-down').addClass('fa-chevron-up');
            allButtons.attr('title', 'إخفاء الطلبات');
            icon.removeClass('fa-eye').addClass('fa-eye-slash');
            $(this).attr('title', 'إخفاء جميع الطلبات');
        }
    });

    // 17. أحداث تحديد المنتج والطلبات
    $(document).on('change', '.product-checkbox', function() {
        const productSku = $(this).data('sku');
        const isChecked = $(this).is(':checked');
        
        $(`.order-checkbox-${productSku}`).prop('checked', isChecked);
        
        updateProductSelectionCount(productSku);
        updateQuickListSelectionCount();
    });

    $(document).on('change', '.quick-list-order', function() {
        const productSku = $(this).data('product-sku');
        
        updateProductSelectionCount(productSku);
        updateProductCheckboxState(productSku);
        updateQuickListSelectionCount();
    });

    // --- التشغيل عند تحميل الصفحة ---
    updateTimestamps();
    updateAssignButtonState();
    
    setInterval(updateTimestamps, 60000);
    
    if (window.innerWidth < 768) {
        $('.sidebar').removeClass('show');
        $('.sidebar__backdrop').removeClass('show');
    }
});

</script>
{% endblock %}
{% endblock %}  