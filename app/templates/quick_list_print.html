<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <title>طباعة القائمة السريعة</title>
    <style>
@page {
    size: A4;
    margin: 0.5cm;
}

body {
    font-family: 'Segoe UI', 'Arial', sans-serif;
    line-height: 1.4;
    margin: 0;
    padding: 15px;
    color: #2c3e50;
    background: #fff;
    font-size: 12px;
}

.report-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.report-header h1 {
    margin: 0;
    font-size: 24px;
    font-weight: 600;
}

.report-summary {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    text-align: center;
}

.summary-item {
    background: white;
    padding: 10px;
    border-radius: 6px;
    border-left: 4px solid #667eea;
}

.summary-item h3 {
    margin: 0;
    font-size: 18px;
    color: #2c3e50;
}

.summary-item p {
    margin: 5px 0 0 0;
    color: #6c757d;
}

.product-section {
    border: 2px solid #e9ecef;
    border-radius: 10px;
    margin-bottom: 25px;
    padding: 0;
    background: #fff;
    break-inside: avoid;
    page-break-inside: avoid;
}

.product-header {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    padding: 15px;
    border-radius: 10px 10px 0 0;
    display: flex;
    align-items: center;
    gap: 15px;
}

.product-image {
    width: 150px;
    height: 150px;
    border-radius: 8px;
    border: 2px solid rgba(255,255,255,0.3);
    object-fit: cover;
}

.product-info {
    flex: 1;
}

.product-info h2 {
    margin: 0;
    font-size: 20px;
}

.product-stats {
    display: flex;
    gap: 10px;
    margin-top: 8px;
    flex-wrap: wrap;
}

.product-badge {
    background: rgba(255,255,255,0.2);
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}

.orders-container {
    padding: 15px;
}

.orders-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 12px;
}

.order-card {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 12px;
    background: #fff;
    transition: all 0.3s ease;
}

.order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid #f0f0f0;
}

.order-number {
    font-size: 18px;
    font-weight:bold ;
    color: #2c3e50;
}

.order-date {
    color: #6c757d;
    font-size: 16px
    font-weight: bold;
}

.customer-info {
    background: #f8f9fa;
    padding: 6px;
    border-radius: 4px;
    margin-bottom: 8px;
    font-size: 11px;
}

.order-details {
    display: grid;
    grid-template-columns: 80px 1fr;
    gap: 10px;
    margin-bottom: 8px;
}

.detail-image {
    width: 100px;
    height: 100px;
    border-radius: 5px;
    border: 1px solid #dee2e6;
    object-fit: cover;
}

.quantity-badge {
    background: #28a745;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    width: fit-content;
}

.options-section {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 5px;
    padding: 8px;
    margin-top: 8px;
}

.options-title {
    font-weight: 600;
    margin-bottom: 5px;
    color: #856404;
    font-size: 11px;
}

.option-item {
    display: inline-block;
    background: white;
    padding: 2px 6px;
    margin: 2px;
    border-radius: 3px;
    font-size: 10px;
    border: 1px solid #ffeaa7;
}

.barcode-section {
    text-align: center;
    margin-top: 8px;
    padding: 10px; /* زيادة الحشوة */
    background: #f8f9fa;
    border-radius: 4px;
}

.barcode-image {
    max-width: 500px; /* زيادة كبيرة من 150px */
    height: 120px; /* زيادة كبيرة من 100px */
    object-fit: contain; /* تغيير من cover إلى contain لضمان ظهور الباركود كاملاً */
    border: 1px solid #ddd; /* إضافة حد للتوضيح */
    background: white; /* خلفية بيضاء للباركود */

}

.no-orders {
    text-align: center;
    padding: 20px;
    color: #6c757d;
    font-style: italic;
    grid-column: 1 / -1;
}

.page-break {
    page-break-after: always;
}

.print-controls {
    text-align: center;
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

@media print {
    body {
        margin: 0;
        padding: 5px;
        font-size: 18px;
    }
    
    .report-header {
        background: #667eea !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .product-header {
        background: #f5576c !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .quantity-badge {
        background: #28a745 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .options-section {
        background: #fff3cd !important;
        border-color: #ffeaa7 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .print-controls {
        display: none;
    }
    
    .product-section {
        break-inside: avoid;
        page-break-inside: avoid;
        margin-bottom: 20px;
    }
    
    .orders-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    /* تكبير الصور للطباعة */
    .product-image {
        width: 100px;
        height: 100px;
    }
    
    .detail-image {
        width: 70px;
        height: 70px;
    }
    
    .order-details {
        grid-template-columns: 70px 1fr;
    }
    
    /* تكبير الباركود بشكل ملحوظ للطباعة */
            .barcode-image {
                width: 170px !important;
                 height: 55px !important;
                image-rendering: crisp-edges;
            
        object-fit: contain !important;
        border: 1px solid #000 !important;
        background: white !important;
        padding: 5px !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    
    .barcode-section {
        padding: 2px !important; /* زيادة حشوة القسم للطباعة */
        background: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
}

.text-primary { color: #667eea; }
.text-success { color: #28a745; }
.text-warning { color: #ffc107; }
.text-danger { color: #dc3545; }
.text-muted { color: #6c757d; }
    </style>
</head>
<body>
    <!-- رأس التقرير -->
    <div class="report-header">
        <h1>تقرير القائمة السريعة</h1>
        <p>تفاصيل المنتجات والطلبات المحددة</p>
        <p>تاريخ التقرير: <span id="report-date"></span></p>
    </div>

    <!-- ملخص التقرير -->
    <div class="report-summary">
        <div class="summary-item">
            <h3 id="total-products">0</h3>
            <p>عدد المنتجات</p>
        </div>
        <div class="summary-item">
            <h3 id="total-orders">0</h3>
            <p>عدد الطلبات</p>
        </div>
        <div class="summary-item">
            <h3 id="total-quantity">0</h3>
            <p>إجمالي الكميات</p>
        </div>
        <div class="summary-item">
            <h3 id="total-items">0</h3>
            <p>إجمالي العناصر</p>
        </div>
    </div>

    <!-- قسم المنتجات -->
    <div id="products-container">
        <!-- سيتم ملء المحتوى عبر JavaScript -->
    </div>

    <!-- تذييل التقرير -->
    <div style="text-align: center; margin-top: 30px; padding-top: 15px; border-top: 2px solid #e9ecef; color: #6c757d; font-size: 11px;">
        <p>تم إنشاء هذا التقرير تلقائياً من نظام إدارة الطلبات</p>
        <p>الصفحة 1 من 1</p>
    </div>

    <!-- أزرار التحكم -->
    <div class="print-controls">
        <button onclick="window.print()" class="btn btn-primary" style="padding: 10px 20px; font-size: 16px;">
            <i class="fas fa-print"></i> طباعة التقرير
        </button>
        <button onclick="window.close()" class="btn btn-secondary" style="padding: 10px 20px; font-size: 16px; margin-right: 10px;">
            <i class="fas fa-times"></i> إغلاق النافذة
        </button>
    </div>

    <script>
        // بيانات التقرير (سيتم تعبئتها من الصفحة الرئيسية)
        let reportData = {
            products: [],
            summary: {
                totalProducts: 0,
                totalOrders: 0,
                totalQuantity: 0,
                totalItems: 0
            }
        };

        // تهيئة التقرير
        function initReport(data) {
            reportData = data;
            updateReportDate();
            updateSummary();
            renderProducts();
        }

        // تحديث تاريخ التقرير
        function updateReportDate() {
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            document.getElementById('report-date').textContent = now.toLocaleDateString('ar-SA', options);
        }

        // تحديث الملخص
        function updateSummary() {
            document.getElementById('total-products').textContent = reportData.summary.totalProducts;
            document.getElementById('total-orders').textContent = reportData.summary.totalOrders;
            document.getElementById('total-quantity').textContent = reportData.summary.totalQuantity;
            document.getElementById('total-items').textContent = reportData.summary.totalItems;
        }

        // عرض المنتجات
        function renderProducts() {
            const container = document.getElementById('products-container');
            
            if (reportData.products.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <i class="fas fa-box-open fa-3x" style="margin-bottom: 15px;"></i>
                        <h3>لا توجد بيانات للعرض</h3>
                        <p>لم يتم العثور على أي منتجات في القائمة السريعة</p>
                    </div>
                `;
                return;
            }

            let html = '';
            reportData.products.forEach((product, index) => {
                html += `
                    <div class="product-section">
                        <div class="product-header">
                            ${product.thumbnail ? `
                                <img src="${product.thumbnail}" alt="${product.name}" class="product-image"
                                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzAiIGhlaWdodD0iNzAiIHZpZXdCb3g9IjAgMCA3MCA3MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjcwIiBoZWlnaHQ9IjcwIiBmaWxsPSIjZGRkIi8+Cjx0ZXh0IHg9IjM1IiB5PSIzNSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgZmlsbD0iIzk5OSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEwIj5ObyBJbWFnZTwvdGV4dD4KPC9zdmc+'">
                            ` : `
                                <div class="product-image" style="background: rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-image" style="font-size: 24px;"></i>
                                </div>
                            `}
                            <div class="product-info">
                                <h2>${product.name}</h2>
                                <div class="product-stats">
                                    <span class="product-badge">SKU: ${product.sku}</span>
                                    <span class="product-badge">الكمية: ${product.total_quantity}</span>
                                    <span class="product-badge">الطلبات: ${product.orders.length}</span>
                                    ${product.price ? `<span class="product-badge">السعر: ${product.price} ر.س</span>` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div class="orders-container">
                `;

                if (product.orders.length > 0) {
                    html += `<div class="orders-grid">`;
                    
                    product.orders.forEach(order => {
                        html += `
                            <div class="order-card">
                                <div class="order-header">
                                    <span class="order-number">الطلب #${order.reference_id}</span>
                                    <span class="order-date">${order.created_at}</span>
                                </div>
                                
                                ${order.customer_name ? `
                                    <div class="customer-info">
                                        <i class="fas fa-user"></i> ${order.customer_name}
                                        ${order.customer_mobile ? ` | <i class="fas fa-phone"></i> ${order.customer_mobile}` : ''}
                                    </div>
                                ` : ''}
                                
                                <div class="order-details">
                                    <div>
                                        ${product.thumbnail ? `
                                            <img src="${product.thumbnail}" alt="${product.name}" class="detail-image"
                                                 onerror="this.style.display='none'">
                                        ` : `
                                            <div class="detail-image" style="background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #6c757d; font-size: 10px;">
                                                لا صورة
                                            </div>
                                        `}
                                    </div>
                                    <div class="detail-content">
                                        <div class="">الكمية: ${order.quantity}</div>
                                        
                                        ${order.options && order.options.length > 0 ? `
                                            <div class="options-section">
                                                <div class="options-title">الخيارات:</div>
                                                ${order.options.map(opt => `
                                                    <span class="option-item">${opt.name}: ${opt.value}</span>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                                
                                <div class="barcode-section">
                                    ${order.barcode ? `
                                        <img src="${order.barcode}" alt="باركود" class="barcode-image"
                                             onerror="this.style.display='none'">
                                    ` : `
                                        <span class="text-muted" style="font-size: 10px;">
                                            <i class="fas fa-barcode"></i> لا يوجد باركود
                                        </span>
                                    `}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                } else {
                    html += `
                        <div class="no-orders">
                            <i class="fas fa-box-open fa-2x"></i>
                            <p>لا توجد طلبات لهذا المنتج</p>
                        </div>
                    `;
                }
                
                html += `</div></div>`;
                
                // إضافة فاصل صفحات بعد كل 3 منتجات
                if ((index + 1) % 3 === 0 && index !== reportData.products.length - 1) {
                    html += `<div class="page-break"></div>`;
                }
            });
            
            container.innerHTML = html;
        }

        // طباعة تلقائية عند التحميل (اختياري)
        window.addEventListener('load', function() {
            // محاولة الحصول على البيانات من localStorage أو parent window
            try {
                const savedData = localStorage.getItem('quickListPrintData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    initReport(data);
                    localStorage.removeItem('quickListPrintData');
                    
                    // طباعة تلقائية بعد ثانيتين
                    setTimeout(() => {
                        window.print();
                    }, 2000);
                }
            } catch (error) {
                console.error('Error loading print data:', error);
            }
        });

        // دالة مساعدة لتحميل البيانات من النافذة الأم
        function loadDataFromParent() {
            if (window.opener && window.opener.quickListPrintData) {
                initReport(window.opener.quickListPrintData);
            }
        }

        // محاولة تحميل البيانات من النافذة الأم
        setTimeout(loadDataFromParent, 100);
    </script>
</body>
</html>