{% extends 'base.html' %}

{% block content_class %}p-0{% endblock %}

{% block content %}

<div class="container-fluid g-0 m-0 w-100 full-width-container">
  <!-- رأس الصفحة -->
<div class="bg-light p-3 d-flex justify-content-between align-items-center flex-wrap gap-2"> <h2 class="mb-0 fs-4"> <i class="fas fa-file-invoice ms-2"></i> تفاصيل الطلب #{{  order.reference_id | safe }}
   </h2> 
    <div>
      <a href="{{ url_for('orders.index') }}" class="btn btn-outline-secondary btn-sm">
        <i class="fas fa-arrow-left ms-1"></i> العودة للطلبات
      </a>
    </div>
  </div> 

  <div class="row g-0 mx-0">
    <!-- القسم الرئيسي - تفاصيل الطلب -->
    <div class="col-12 p-3">
      <div class="card shadow-sm mb-3 border-0">
        <div class="card-header bg-white d-flex justify-content-between align-items-center flex-wrap py-2">
          <h5 class="mb-0 fs-5">معلومات الطلب</h5>
          <span class="badge rounded-pill bg-{{ order.status.slug | replace('under_review', 'warning') | replace('in_progress', 'info') | replace('completed', 'success') | replace('payment_pending', 'warning') | replace('shipped', 'primary') | replace('delivered', 'success') | replace('canceled', 'danger') | replace('restored', 'secondary') }}">
            {{ order.status.name | safe }}
          </span>
        </div>
        <div class="card-body p-2">
          <h5 class="border-bottom pb-2 mb-2 fs-5">
            <i class="fas fa-boxes ms-2"></i>المنتجات ({{ order.order_items | length }})
          </h5>

          <!-- تعديل هنا لعرض المنتجات في صفوف مع تمرير أفقي -->
          <div class="table-responsive">
            <table class="table table-borderless">
              <tbody>
                {% for item in order.order_items %}
     <tr class="border-bottom">
  <!-- صورة المنتج -->
  <td style="width: 120px; min-width: 120px;">
    <div class="d-flex justify-content-center">
      {% if item.main_image %}
      <img src="{{ item.main_image | safe }}" alt="{{ item.name | safe }}"
           class="img-fluid rounded product-image"
           style="width: 160px; height: 160px; object-fit: cover;"
           loading="lazy">
      {% else %}
      <div class="bg-light d-flex align-items-center justify-content-center rounded product-image-placeholder" 
           style="width: 80px; height: 80px;">
        <i class="fas fa-image fa-lg text-muted"></i>
      </div>
      {% endif %}
    </div>
    <div class="text-center mt-1 small text-muted">
      الكمية: {{ item.quantity }}
    </div>
  </td>
  
  <!-- خيارات المنتج -->
  <td style="min-width: 150px;">
{% if item.options %}
<div class="text-start product-options">
  <h6 class="mb-1 small text-muted">
    <i class="fas fa-cogs me-1"></i>خيارات
  </h6>
  <ul class="list-group list-group-flush small">
    {% for option in item.options %}
    <li class="list-group-item d-flex justify-content-between py-1 px-0 option-item">
      <span class="fw-bold">{{ option.name | safe }}</span>
      <span class="text-wrap text-end" style="max-width: 60%;">
        {{ option.value | safe }}
      </span>
    </li>
    {% endfor %}
  </ul> 
</div>
{% else %}
<div class="alert alert-info p-1 mt-2 small">
  <i class="fas fa-info-circle me-1"></i>
  لا توجد خيارات لهذا المنتج
</div>
{% endif %}
  </td>
<!-- في قسم المنتجات، تأكد من تمرير product_id بشكل صحيح -->

  <!-- ... الأكواد الأخرى ... -->
  <td class="text-center align-middle">
    <!-- تأكد من أن order.id يتم تمريره كنص -->
    <form class="update-product-status-form d-inline"
          data-order-id="{{ order.id | string }}"
          data-product-id="{{ item.id | string }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      
      <button type="submit"
              class="btn btn-sm btn-success"
              {% if product_statuses.get(item.id|string) and product_statuses[item.id|string].status == 'تم التنفيذ' %}disabled{% endif %}>
        <i class="fas fa-check"></i> تم التنفيذ
      </button>
    </form>

    <!-- عنصر لعرض حالة المنتج -->
    <div class="product-status text-muted small mt-1">
      {% if product_statuses.get(item.id|string) %}
        {{ product_statuses[item.id|string].status }}
      {% else %}
        قيد التنفيذ
      {% endif %}
    </div>
  </td>

</tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- العمود الجانبي -->
    <div class="col-lg-4 bg-light p-3">
      <!-- قسم الحالات المخصصة للموظف -->
      <div class="card shadow-sm mb-3 border-0">
        <div class="card-header bg-white py-2">
          <h5 class="mb-0 fs-5"><i class="fas fa-tags ms-2"></i>حالة الطلب </h5>
        </div>
        <div class="card-body p-2">
          {% if current_employee %}
          <form action="{{ url_for('orders.add_employee_status', order_id=order.id) }}" method="POST" id="employee-status-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="mb-2">
              <label class="form-label small">اختر حالة</label>
              <select class="form-select form-select-sm" name="status_id" required>
                <option value="">اختر حالة</option>
                {% for status in current_employee.custom_statuses if status.is_active %}
                <option value="{{ status.id }}">{{ status.name | safe }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-2">
              <label for="custom-note" class="form-label small">ملاحظة (اختياري)</label>
              <textarea class="form-control form-control-sm" id="custom-note" 
                        name="note" rows="2" placeholder="أدخل ملاحظاتك هنا..." maxlength="500"></textarea>
            </div>
            <button type="submit" class="btn btn-primary btn-sm w-100">
              <i class="fas fa-plus me-1"></i> إضافة حالة
            </button>
          </form>
          {% endif %}
          
          <div class="mt-3">
            <h6 class="border-bottom pb-1 small">الحالات المسجلة</h6>
            <ul class="list-group list-group-flush small">
              {% if employee_statuses %}
                {% for emp_status, custom_status, employee in employee_statuses %}
                <li class="list-group-item d-flex justify-content-between py-1 px-0">
                  <div>
                    <span class="badge" style="background-color: {{ custom_status.color | safe }}; color: white;">
                      {{ custom_status.name | safe }}
                    </span>
                    {% if emp_status.note %}
                      <span class="ms-2">{{ emp_status.note | safe }}</span>
                    {% endif %}
                    <div class="text-muted small mt-1">
                      <i class="fas fa-user me-1"></i>{{ employee.email | safe }}
                    </div>
                  </div>
                  <div class="text-muted">{{ emp_status.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
                </li>
                {% endfor %}
              {% else %}
                <li class="list-group-item py-2 text-center text-muted">لا توجد حالات مسجلة</li>
              {% endif %}
            </ul>
          </div> 
        </div>
      </div>

      <!-- قسم الحالات الخاصة (للمراجعين فقط) -->
<!-- قسم الحالات الخاصة -->
<!-- بداية التعديل - قسم الحالات الخاصة -->
<!-- بداية التعديل - قسم الحالات الخاصة -->
<!-- بداية التعديل - قسم الحالات الخاصة -->
{% if is_reviewer %}
<div class="card shadow-sm mb-3 border-0">
    <div class="card-header bg-white py-2">
        <h5 class="mb-0 fs-5"><i class="fas fa-flag ms-2"></i>حالات خاصة</h5>
    </div>
    <div class="card-body p-2">
        <form action="{{ url_for('orders.add_status_note', order_id=order.id) }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <div class="mb-3">
                <label class="form-label small fw-bold">اختر حالة</label>
                <select class="form-select form-select-sm" name="status_type" required>
                    <option value="">-- اختر حالة --</option>
                    
                    <!-- الحالات التلقائية -->
                    <optgroup label="الحالات التلقائية">
                        <option value="late">متأخر</option>
                        <option value="missing">واصل ناقص</option>
                        <option value="refunded">مرتجع</option>
                        <option value="not_shipped">لم يتم الشحن</option>
                    </optgroup>
                    
                    <!-- الحالات المخصصة -->
                    {% if custom_note_statuses %}
                    <optgroup label="الحالات المخصصة">
                        {% for status in custom_note_statuses %}
                        <option value="custom_{{ status.id }}">
                            {{ status.name }}
                        </option>
                        {% endfor %}
                    </optgroup>
                    {% endif %}
                </select>
            </div>
            
            <div class="mb-3">
                <label class="form-label small fw-bold">ملاحظات إضافية</label>
                <textarea class="form-control form-control-sm" name="note" rows="3" 
                          placeholder="أدخل ملاحظاتك هنا..."></textarea>
            </div>
            
            <button type="submit" class="btn btn-primary btn-sm w-100">
                <i class="fas fa-save me-1"></i> حفظ الحالة
            </button>
        </form>
{% endif %}
        <!-- عرض الحالات المسجلة في قائمة واحدة -->
        <div class="mt-4">
            <h6 class="border-bottom pb-2 mb-3 small fw-bold">تنبيهات  </h6>
            {% if status_notes %}
                <div class="list-group list-group-flush">
                    {% for note in status_notes %}
                    <div class="list-group-item py-2 px-0">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <!-- عرض الحالة مع لونها -->
                                <span class="badge" style="
                                    {% if note.custom_status %} 
                                        background-color: {{ note.custom_status.color }};
                                    {% else %}
                                        background-color: 
                                            {% if note.status_flag == 'late' %}#ffc107
                                            {% elif note.status_flag == 'missing' %}#dc3545
                                            {% elif note.status_flag == 'not_shipped' %}#0dcaf0
                                            {% elif note.status_flag == 'refunded' %}#6c757d
                                            {% else %}#6c757d
                                            {% endif %};
                                    {% endif %} 
                                    color: white;">
                                    
                                    {% if note.custom_status %}
                                        <i class="fas fa-tag me-1"></i>{{ note.custom_status.name }}
                                    {% else %}
                                        <i class="fas fa-flag me-1"></i>
                                        {{ 
                                            'متأخر' if note.status_flag == 'late'
                                            else 'واصل ناقص' if note.status_flag == 'missing'
                                            else 'لم يتم الشحن' if note.status_flag == 'not_shipped'
                                            else 'مرتجع' if note.status_flag == 'refunded'
                                            else note.status_flag
                                        }}
                                    {% endif %}
                                </span>
                                
                                {% if note.note %}
                                    <p class="mb-0 mt-1 small">{{ note.note }}</p>
                                {% endif %}
                            </div>
                            <div class="text-muted small text-end">
                                <div>{{ note.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
                               
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted text-center py-3 small">لا توجد حالات مسجلة</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- نهاية التعديل -->
<!-- نهاية التعديل -->
<!-- نهاية التعديل -->
      <!-- قسم تحديث حالة الطلب -->
      {% if is_reviewer  %}
      <div class="card shadow-sm mb-3 border-0">
        <div class="card-header bg-white py-2">
          <h5 class="mb-0 fs-5"><i class="fas fa-sync-alt ms-2"></i>تحديث حالة الطلب</h5>
        </div>
        
        <div class="card-body p-2">
          <form id="status-form" action="{{ url_for('orders.update_order_status', order_id=order.id) }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="mb-2">
              <label for="status" class="form-label small">الحالة الجديدة</label>
              <select class="form-select form-select-sm" id="status" name="status_slug" required>
                {% for slug, label in [
                  ('under_review', 'بإنتظار المراجعة'),
                  ('in_progress', 'قيد التنفيذ'),
                  ('completed', 'تم التنفيذ'),
                  ('payment_pending', 'بإنتظار الدفع'),
                  ('shipped', 'تم الشحن'),
                  ('delivered', 'تم التوصيل'),
                  ('canceled', 'ملغي'),
                  ('restored', 'مسترجع')
                ] %}
                <option value="{{ slug }}" {% if order.status.slug == slug %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-2">
              <label for="note" class="form-label small">ملاحظات</label>
              <textarea class="form-control form-control-sm" id="note" name="note" rows="2" 
                        placeholder="أدخل ملاحظاتك هنا..." maxlength="500"></textarea>
            </div>
            <button type="submit" class="btn btn-primary btn-sm w-100">
              <i class="fas fa-save me-1"></i> حفظ التغييرات
            </button>
          </form>
        </div>
      </div>
{% endif %}
      <!-- قسم المعلومات الإضافية -->
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-2">
          <h5 class="mb-0 fs-5"><i class="fas fa-info-circle ms-2"></i>معلومات إضافية</h5>
        </div>
        
        <!-- باركود الطلب -->
        <div class="text-center mb-3 pt-3">
          <h5 class="mb-2 fs-5"><i class="fas fa-barcode ms-2"></i>باركود الطلب</h5>
          {% if order.barcode %}
            <div class="barcode-container p-2 bg-white border rounded d-inline-block">
              <img src="{{ url_for('orders.serve_barcode', filename=order.barcode) | safe }}"
                   alt="باركود الطلب {{ order.id | safe }}"
                   class="img-fluid"
                   style="max-height: 50px;">
              <div class="mt-1 fw-bold fs-6">#{{ order.id | safe }}</div>
            </div>
          {% else %}
            <div class="alert alert-warning d-inline-block p-2">
              <i class="fas fa-exclamation-triangle ms-2"></i>
              لم يتم إنشاء باركود لهذا الطلب.
            </div>
          {% endif %}
        </div>
        
        <div class="card-body p-2">
          <ul class="list-group list-group-flush small">
            <li class="list-group-item d-flex justify-content-between py-1 px-0">
              <span class="fw-bold">تاريخ الطلب:</span>
              <span>
                {% if order.created_at is string %}
                  {{ order.created_at | safe }}
                {% elif order.created_at %}
                  {{ order.created_at.strftime('%Y-%m-%d %H:%M') }}
                {% else %}
                  غير متوفر
                {% endif %}
              </span>
            </li>

            <!-- معلومات المستلم -->

            
<!-- في القسم الخاص بعرض العنوان، استبدل هذا الكود: -->
 

<li class="list-group-item py-2 px-0">
    <div class="fw-bold mb-1">عنوان الشحن الكامل:</div>
    <div class="text-muted small">
        {# إذا عندنا العنوان الكامل نعرضه #}
        {% if order.shipping.address and order.shipping.address != 'لم يتم تحديد العنوان' %}
            {{ order.shipping.address }}
        {% else %}
            {# نعرض المكونات بشكل منفصل #}
            {% if order.shipping.country %}
                <span class="d-block">الدولة: {{ order.shipping.country }}</span>
            {% endif %}
            {% if order.shipping.city %}
                <span class="d-block">المدينة: {{ order.shipping.city }}</span>
            {% endif %}
            {% if order.shipping.district %}
                <span class="d-block">الحي: {{ order.shipping.district }}</span>
            {% endif %}
            {% if order.shipping.street %}
                <span class="d-block">الشارع: {{ order.shipping.street }}</span>
            {% endif %}
            {% if order.shipping.description %}
                <span class="d-block">الوصف: {{ order.shipping.description }}</span>
            {% endif %}
            {% if order.shipping.postal_code %}
                <span class="d-block">الرمز البريدي: {{ order.shipping.postal_code }}</span>
            {% endif %}
        {% endif %}

        {# إذا ما فيه أي بيانات #}
        {% if not order.shipping.address and not order.shipping.country 
              and not order.shipping.city and not order.shipping.district
              and not order.shipping.street and not order.shipping.description 
              and not order.shipping.postal_code %}
            <span class="text-danger">لم يتم تحديد العنوان</span>
        {% endif %}

        {# عرض إحداثيات الموقع لو موجودة #}
        {% if order.shipping.raw_data and order.shipping.raw_data.latitude and order.shipping.raw_data.longitude %}
            <span class="d-block mt-1">
                <small>الإحداثيات: {{ order.shipping.raw_data.latitude }}, {{ order.shipping.raw_data.longitude }}</small>
            </span>
        {% endif %}
    </div>
</li>
<li class="list-group-item d-flex justify-content-between py-2 px-0">
    <span class="fw-bold">اسم المستلم:</span>
    <span>
        {# البحث عن اسم المستلم في عدة أماكن محتملة #}
        {% if order.receiver.name %}
            {{ order.receiver.name | safe }}
        {% elif order.shipping.customer_name %}
            {{ order.shipping.customer_name | safe }}
        {% else %}
            {{ order.customer.first_name | safe }} {{ order.customer.last_name | safe }}
        {% endif %}
    </span>
</li>

<li class="list-group-item d-flex justify-content-between py-2 px-0">
    <span class="fw-bold">هاتف المستلم:</span>
    <span>
        {# البحث عن هاتف المستلم في عدة أماكن محتملة #}
        {% if order.receiver.phone %}
            {{ order.receiver.phone | safe }}
        {% elif order.shipping.phone %}
            {{ order.shipping.phone | safe }}
        {% else %}
            {{ order.customer.phone | safe }}
        {% endif %}
    </span>
</li>

<li class="list-group-item d-flex justify-content-between py-2 px-0">
    <span class="fw-bold">البريد الإلكتروني:</span>
    <span>
        {# البحث عن البريد الإلكتروني في عدة أماكن محتملة #}
        {% if order.receiver.email %}
            {{ order.receiver.email | safe }}
        {% else %}
            {{ order.customer.email | safe }}
        {% endif %}
    </span>
</li>

{# معلومات الشحن الإضافية إذا كانت متوفرة #}
{% if order.shipping.tracking_number %}
<li class="list-group-item d-flex justify-content-between py-2 px-0">
    <span class="fw-bold">رقم التتبع:</span>
    <span>
        {% if order.shipping.tracking_link %}
            <a href="{{ order.shipping.tracking_link }}" target="_blank" class="text-decoration-none">
                {{ order.shipping.tracking_number }}
                <i class="fas fa-external-link-alt ms-1 small"></i>
            </a>
        {% else %}
            {{ order.shipping.tracking_number }}
        {% endif %}
    </span>
</li>
{% endif %}

{% if order.shipping.method and order.shipping.method != 'غير محدد' %}
<li class="list-group-item d-flex justify-content-between py-2 px-0">
    <span class="fw-bold">شركة الشحن:</span>
    <span>{{ order.shipping.method }}</span>
</li>
{% endif %}
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* أنماط عامة للجدول */
  .table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 10px;
  }
  
  .table tbody tr {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
  }
  
  /* أنماط الوضع الليلي للجدول */
  body.dark-mode .table tbody tr {
    background-color: #2c2f42;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  
  body.dark-mode .table {
    color: #f8f9fa;
  }
  
  body.dark-mode .table .text-muted {
    color: #adb5bd !important;
  }
  
  body.dark-mode .table .text-secondary {
    color: #a0aec0 !important;
  }
  
  body.dark-mode .table .text-dark {
    color: #f8f9fa !important;
  }
  
  body.dark-mode .table .border-bottom {
    border-bottom-color: #3a3f58 !important;
  }
  
  /* تحسينات للصور في الوضع الليلي */
  body.dark-mode .img-fluid {
    border-color: #3a3f58;
  }
  
  body.dark-mode .bg-light {
    background-color: #3a3f58 !important;
    border-color: #444;
  }
  
  /* تحسينات للقوائم في الوضع الليلي */
  body.dark-mode .list-group-flush {
    background-color: #2c2f42;
    border-color: #3a3f58;
  }
  
  body.dark-mode .list-group-item {
    background-color: #2c2f42 !important;
    border-color: #3a3f58 !important;
    color: #f8f9fa !important;
  }
  
  /* تحسينات للفورمات في الوضع الليلي */
  body.dark-mode .form-control,
  body.dark-mode .form-select {
    background-color: #3a3f58;
    border-color: #444;
    color: #f8f9fa;
  }
  
  body.dark-mode .form-control:focus,
  body.dark-mode .form-select:focus {
    background-color: #3a3f58;
    border-color: #4a4f66;
    color: #f8f9fa;
  }
  
  /* تحسينات للأزرار في الوضع الليلي */
  body.dark-mode .btn-outline-secondary {
    color: #f8f9fa;
    border-color: #4a4f66;
  }
  
  body.dark-mode .btn-outline-secondary:hover {
    background-color: #4a4f66;
    color: #f8f9fa;
  }
  
  /* تحسينات للبطاقات (Cards) في الوضع الليلي */
  body.dark-mode .card {
    background-color: #2c2f42;
    border-color: #3a3f58;
  }
  
  body.dark-mode .card-header {
    background-color: #3a3f58 !important;
    border-bottom-color: #444 !important;
    color: #f8f9fa;
  }
  
  /* تحسينات للخريطة في الوضع الليلي */
  body.dark-mode iframe {
    filter: invert(90%) hue-rotate(180deg) brightness(85%) contrast(110%);
  }
  
  /* تحسينات للنصوص في الوضع الليلي */
  body.dark-mode .text-dark {
    color: #f8f9fa !important;
  }
  
  body.dark-mode .text-muted {
    color: #adb5bd !important;
  }
  
  /* تحسينات للتنبيهات (Alerts) في الوضع الليلي */
  body.dark-mode .alert-warning {
    background-color: #664d03;
    border-color: #846404;
    color: #ffecb5;
  }
  
  /* تحسينات للشريط الجانبي الأيمن */
  body.dark-mode .col-lg-4.bg-light {
    background-color: #252836 !important;
  }
</style>
<style>
  /* أنماط المنتجات في الوضع الليلي */
  body.dark-mode .table tbody tr {
    background-color: #2c2f42 !important;
    border-color: #3a3f58 !important;
  }

  body.dark-mode .table tbody td {
    background-color: #2c2f42 !important;
    border-color: #3a3f58 !important;
  }

  body.dark-mode .list-group-item {
    background-color: #2c2f42 !important;
    border-color: #3a3f58 !important;
    color: #f8f9fa !important;
  }

  body.dark-mode .text-muted {
    color: #adb5bd !important;
  }

  /* تحسين صورة المنتج في الوضع الليلي */
  body.dark-mode .img-fluid {
    border: 1px solid #3a3f58;
  }

  body.dark-mode .bg-light {
    background-color: #3a3f58 !important;
  }

  /* تحسين خيارات المنتج */
  body.dark-mode .product-options {
    background-color: #3a3f58;
    border-color: #444;
  }

  body.dark-mode .product-options li {
    background-color: #2c2f42 !important;
    border-color: #3a3f58 !important;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>

document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.update-product-status-form').forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const orderId = this.dataset.orderId;
      const productId = this.dataset.productId;
      const button = this.querySelector('button');
      const csrfToken = this.querySelector('input[name="csrf_token"]').value;

      // إظهار تحميل
      const originalText = button.innerHTML;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
      button.disabled = true;

      // إرسال AJAX
      fetch(`/${encodeURIComponent(orderId)}/product/${encodeURIComponent(productId)}/update_status`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ 
          status: 'تم التنفيذ', 
          notes: '' 
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`خطأ في الخادم: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          button.innerHTML = '<i class="fas fa-check"></i> تم التنفيذ';
          button.disabled = true;

          // تحديث حالة المنتج المعروضة
          const statusElement = form.closest('tr').querySelector('.product-status');
          if (statusElement) {
            statusElement.textContent = 'تم التنفيذ';
            statusElement.classList.add('text-success');
          }

          Swal.fire({
            title: 'تم!',
            text: 'تم تحديث حالة المنتج بنجاح',
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
          });
        } else {
          throw new Error(data.error || 'حدث خطأ غير متوقع');
        }
      })
      .catch(error => {
        button.innerHTML = originalText;
        button.disabled = false;
        Swal.fire({
          title: 'خطأ!',
          text: error.message,
          icon: 'error',
          confirmButtonText: 'حسناً'
        });
        console.error('Error:', error);
      });
    });
  });
});


  // إضافة تحميل متأخر للصور
  document.addEventListener('DOMContentLoaded', function() {
    const lazyImages = document.querySelectorAll('img[loading="lazy"]');
    
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          img.src = img.dataset.src || img.src;
          observer.unobserve(img);
        }
      });
    });

    lazyImages.forEach(img => {
      observer.observe(img);
    });
  });

  // عرض رسائل التأكيد عند تغيير الحالة بنجاح
  {% if request.args.get('status_updated') %}
  Swal.fire({
    title: 'تم التحديث!',
    text: 'تم تحديث حالة الطلب بنجاح',
    icon: 'success',
    confirmButtonText: 'حسناً',
    timer: 3000
  });
  {% endif %}
  
  {% if request.args.get('employee_status_added') %}
  Swal.fire({
    title: 'تمت الإضافة!',
    text: 'تمت إضافة الحالة المخصصة بنجاح',
    icon: 'success',
    confirmButtonText: 'حسناً',
    timer: 3000
  });
  {% endif %}
  
  {% if request.args.get('special_status_added') %}
  Swal.fire({
    title: 'تم الحفظ!',
    text: 'تم حفظ الحالة الخاصة بنجاح',
    icon: 'success',
    confirmButtonText: 'حسناً',
    timer: 3000
  });
  {% endif %}


</script>
{% endblock %}