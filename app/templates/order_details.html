{% extends 'base.html' %}

{% block content_class %}p-0{% endblock %}

{% block content %}

<div class="container-fluid g-0 m-0 w-100 full-width-container">
  <!-- رأس الصفحة -->
<!-- رأس الصفحة -->
<div class="bg-light p-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
  <h2 class="mb-0 fs-4">
    <i class="fas fa-file-invoice ms-2"></i> تفاصيل الطلب #{{ order.reference_id | safe }}
  </h2>
  <div>
    <!-- زر طباعة HTML -->
    <a href="{{ url_for('orders.download_orders_html', order_ids=order.id) }}" 
       class="btn btn-primary btn-sm" target="_blank">
      <i class="fas fa-print ms-1"></i> طباعة الطلب
    </a>
    

    

<!-- زر تحميل العناوين -->
<a href="{{ url_for('orders.download_addresses_pdf', order_ids=order.id) }}" 
   class="btn btn-info btn-sm">
  <i class="fas fa-download ms-1"></i> تحميل العنوان
</a>


    <!-- زر العودة الأصلي -->
    <a href="{{ url_for('orders.index') }}" class="btn btn-outline-secondary btn-sm">
      <i class="fas fa-arrow-left ms-1"></i> العودة للطلبات
    </a>
  </div>
</div>
  <div class="row g-0 mx-0">
    <!-- القسم الرئيسي - تفاصيل الطلب -->
    <div class="col-12 p-3">
      <div class="card shadow-sm mb-3 border-0">
        <div class="card-header bg-white d-flex justify-content-between align-items-center flex-wrap py-2">
          <h5 class="mb-0 fs-5">معلومات الطلب</h5>
          <span class="badge rounded-pill bg-{{ order.status.slug | replace('under_review', 'warning') | replace('in_progress', 'info') | replace('completed', 'success') | replace('payment_pending', 'warning') | replace('shipped', 'primary') | replace('delivered', 'success') | replace('canceled', 'danger') | replace('restored', 'secondary') }}">
            {{ order.status.name | safe }}
          </span>
        </div>
        <div class="card-body p-2">
          <h5 class="border-bottom pb-2 mb-2 fs-5">
            <i class="fas fa-boxes ms-2"></i>المنتجات ({{ order.order_items | length }})
          </h5>
<!-- في ملف order_details.html -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">معلومات الدفع والملاحظات</h5>
    </div>
    <div class="card-body">
        <!-- طريقة الدفع -->
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>طريقة الدفع:</strong>
                <span class="badge bg-primary">{{ order.payment_method }}</span>
            </div>
        </div>
        
        <!-- ملاحظات الطلب -->

    </div>
</div>
          <!-- جدول المنتجات -->
          <div class="table-responsive">
            <table class="table table-borderless">
              <tbody>
                {% for item in order.order_items %}
                <tr class="border-bottom">
                  <!-- صورة المنتج -->
       <td style="width: 120px; min-width: 120px;">
  <div class="d-flex justify-content-center flex-column align-items-center">
    {% if item.main_image %}
      <img src="{{ item.main_image | safe }}" alt="{{ item.name | safe }}"
           class="img-fluid rounded product-image mb-2"
           style="width: 160px; height: 160px; object-fit: cover;"
           loading="lazy">
    {% else %}
      <div class="bg-light d-flex align-items-center justify-content-center rounded product-image-placeholder mb-2" 
           style="width: 80px; height: 80px;">
        <i class="fas fa-image fa-lg text-muted"></i>
      </div>
    {% endif %}

<!-- بـهذا الكود المعدل -->
{% if item.uploaded_images %}
  <div class="uploaded-images text-center mt-2">
    <h6 class="small text-muted mb-1">صور العميل:</h6>
    <div class="d-flex flex-wrap justify-content-center gap-1">
      {% for img in item.uploaded_images %}
        {% if img.url %}
          <img src="{{ img.url }}" alt="{{ img.name | default('صورة العميل') }}" 
               class="img-thumbnail rounded" 
               style="width: 60px; height: 60px; object-fit: cover;"
               onerror="this.style.display='none'">
        {% endif %}
      {% endfor %}
    </div>
  </div>
{% endif %}
    <div class="text-center mt-1 small text-muted">
      الكمية: {{ item.quantity }}
    </div>
  </div>
</td>
                  <!-- خيارات المنتج -->
                  <td style="min-width: 150px;">
                    {% if item.options %}
                    <div class="text-start product-options">
                      <h6 class="mb-1 small text-muted">
                        <i class="fas fa-cogs me-1"></i>خيارات
                      </h6>
                      <ul class="list-group list-group-flush small">
                        {% for option in item.options %}
                        <li class="list-group-item d-flex justify-content-between py-1 px-0 option-item">
                          <span class="fw-bold">{{ option.name | safe }}</span>
                          <span class="text-wrap text-end" style="max-width: 60%;">
                            {{ option.value | safe }}
                          </span>
                        </li>
                        {% endfor %}
                      </ul> 
                    </div>
                    {% else %}
                    <div class="alert alert-info p-1 mt-2 small">
                      <i class="fas fa-info-circle me-1"></i>
                      لا توجد خيارات لهذا المنتج
                    </div>
                    {% endif %}
                  </td>
                  
                  <!-- حالة المنتج -->
                 </tr>
                <tr > <td>  {% if item.notes and item.notes.strip() %}
                            <div class="product-notes bg-light p-2 rounded">
                                <small class="text-primary">
                                    <i class="fas fa-sticky-note me-1"></i>
                                    {{ item.notes }}
                                </small>
                            </div>
                            {% else %}
                            <span class="text-muted">لا توجد ملاحظات</span>
                            {% endif %}</td>            <td class="text-center align-middle">
                    <div class="product-status-container" data-order-id="{{ order.id | string }}" data-product-id="{{ item.id | string }}">
                      <!-- زر تم التنفيذ -->
                      <form class="update-product-status-form d-inline mb-1">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit"
                                class="btn btn-sm btn-success"
                                {% if product_statuses[item.id|string] and product_statuses[item.id|string].status == 'تم التنفيذ' %}disabled{% endif %}>
                          <i class="fas fa-check"></i> تم التنفيذ
                        </button>
                      </form>

                      <!-- زر إلغاء الحالة -->
                      {% if product_statuses[item.id|string] and product_statuses[item.id|string].status == 'تم التنفيذ' %}
                      <form class="cancel-product-status-form d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                          <i class="fas fa-undo"></i>
                        </button>
                      </form>
                      {% endif %}
                    </div>
                  </td>
     </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- العمود الجانبي -->
    <div class="col-lg-4 bg-light p-3">
      <!-- قسم الحالات المخصصة للموظف -->
   

      <!-- قسم الحالات الخاصة -->
      {% if is_reviewer %}
      <div class="card shadow-sm mb-3 border-0">
        <div class="card-header bg-white py-2">
          <h5 class="mb-0 fs-5"><i class="fas fa-flag ms-2"></i> تنبية</h5>
        </div>
        <div class="card-body p-2">
          <form action="{{ url_for('orders.add_status_note', order_id=order.id) }}" method="POST" id="special-status-form" class="ajax-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <div class="mb-3">
              <label class="form-label small fw-bold">اختر حالة</label>
              <select class="form-select form-select-sm" name="status_type" required>
                <option value="">-- اختر حالة --</option>
                
                <!-- الحالات التلقائية -->
                <optgroup label="الحالات التلقائية">
                  <option value="late">متأخر</option>
                  <option value="missing">واصل ناقص</option>
                  <option value="refunded">مرتجع</option>
                  <option value="not_shipped">لم يتم الشحن</option>
                </optgroup>
                
                <!-- الحالات المخصصة -->
                {% if custom_note_statuses %}
                <optgroup label="الحالات المخصصة">
                  {% for status in custom_note_statuses %}
                  <option value="custom_{{ status.id }}">
                    {{ status.name }}
                  </option>
                  {% endfor %}
                </optgroup>
                {% endif %}
              </select>
            </div>
            
            <div class="mb-3">
              <label class="form-label small fw-bold">ملاحظات إضافية</label>
              <textarea class="form-control form-control-sm" name="note" rows="3" 
                        placeholder="أدخل ملاحظاتك هنا..."></textarea>
            </div>
            
            <button type="submit" class="btn btn-primary btn-sm w-100">
              <i class="fas fa-save me-1"></i> حفظ الحالة
            </button>
          </form>

          <!-- عرض الحالات المسجلة في قائمة واحدة -->
          <div class="mt-4">
            <h6 class="border-bottom pb-2 mb-3 small fw-bold">تنبيهات</h6>
            <div class="list-group list-group-flush special-status-list">
              {% if status_notes %}
                {% for note in status_notes %}
                <div class="list-group-item py-2 px-0">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <!-- عرض الحالة مع لونها -->
                      <span class="badge" style="
                        {% if note.custom_status %} 
                          background-color: {{ note.custom_status.color }};
                        {% else %}
                          background-color: 
                            {% if note.status_flag == 'late' %}#ffc107
                            {% elif note.status_flag == 'missing' %}#dc3545
                            {% elif note.status_flag == 'not_shipped' %}#0dcaf0
                            {% elif note.status_flag == 'refunded' %}#6c757d
                            {% else %}#6c757d
                            {% endif %};
                        {% endif %} 
                        color: white;">
                        
                        {% if note.custom_status %}
                          <i class="fas fa-tag me-1"></i>{{ note.custom_status.name }}
                        {% else %}
                          <i class="fas fa-flag me-1"></i>
                          {{ 
                            'متأخر' if note.status_flag == 'late'
                            else 'واصل ناقص' if note.status_flag == 'missing'
                            else 'لم يتم الشحن' if note.status_flag == 'not_shipped'
                            else 'مرتجع' if note.status_flag == 'refunded'
                            else note.status_flag
                          }}
                        {% endif %}
                      </span>
                      
                      {% if note.note %}
                        <p class="mb-0 mt-1 small">{{ note.note }}</p>
                      {% endif %}
                    </div>
                    <div class="text-muted small text-end">
                      <div>{{ note.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
                    </div>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <p class="text-muted text-center py-3 small">لا توجد حالات مسجلة</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- قسم تحديث حالة الطلب -->

<!-- قسم تحديث حالة الطلب -->
<div class="card shadow-sm mb-3 border-0">
    <div class="card-header bg-white py-2">
        <h5 class="mb-0 fs-5"><i class="fas fa-sync-alt ms-2"></i>تحديث حالة الطلب</h5>
    </div>
    
    <div class="card-body p-2">
        <form id="status-form" action="{{ url_for('orders.update_order_status', order_id=order.id) }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <div class="mb-2">
                <label for="status" class="form-label small">الحالة الجديدة</label>
                <select class="form-select form-select-sm" id="status" name="status_slug" required>
                    <option value="">اختر حالة...</option>
                    {% for status in order_statuses %}
                        <option value="{{ status.slug }}" 
                                {% if order.status.slug == status.slug %}selected{% endif %}
                                data-status-type="{{ status.type }}"
                                style="color: {{ status.color or '#000' }}; {% if status.color %}font-weight: bold;{% endif %}">
                            {{ status.name }} 
                            {% if status.type %}{% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-2">
                <label for="note" class="form-label small">ملاحظات</label>
                <textarea class="form-control form-control-sm" id="note" name="note" rows="2" 
                          placeholder="أدخل ملاحظاتك هنا..." maxlength="500"></textarea>
            </div>
            
            <button type="submit" class="btn btn-primary btn-sm w-100">
                <i class="fas fa-save me-1"></i> حفظ التغييرات
            </button>
        </form>
    </div>
</div>
        <!-- سجل تغييرات الحالة في سلة -->
{% if status_changes %}
<div class="card mt-3">
    <div class="card-header">
        <h6 class="mb-0">
            <i class="fas fa-sync-alt me-2"></i>
            سجل تغييرات الحالة في سلة
        </h6>
    </div>
    <div class="card-body p-2">
        <div class="list-group list-group-flush">
            {% for change in status_changes %}
            <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                <div>
                    <small class="text-muted">{{ change.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                    <span class="badge bg-primary ms-2">{{ change.status_slug }}</span>
                </div>
                <div>
                    <small class="text-muted">
                        {{ change.changed_by }}
                        <span class="badge bg-secondary ms-1">
                            {{ 'مدير' if change.user_type == 'admin' else 'موظف' }}
                        </span>
                    </small>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}
      </div>
     

      <!-- قسم المعلومات الإضافية -->

{% if order_address %}
    <div class="card-body">
        <h4> عنوان المستلم:</h4>
        <p><strong>الاسم:</strong> {{ order_address.name }}</p>
        <p><strong>الهاتف:</strong> {{ order_address.phone }}</p>
        <p> {{ order_address.city }}</p>
        <p><strong>العنوان:</strong> {{ order_address.full_address }}</p>

        
    </div>
{% else %}
    <div class="address-info">
        <p>لم يتم حفظ عنوان لهذا الطلب بعد</p>
    </div>

{% endif %}
    </div>
  </div>
</div>
<!-- قسم معلومات الشحن -->

<!-- في قسم معلومات الشحن -->
<div class="shipping-section">
    <h4>معلومات الشحن</h4>
    
    {% if order.shipping.has_shipping %}
        <div class="shipping-actions">
            <!-- زر بوليصة الشحن -->
            {% if order.shipping.has_shipping_policy %}
            <a href="{{ order.shipping.shipping_policy_url }}" 
               target="_blank" 
               class="btn btn-primary btn-sm">
                <i class="fas fa-file-pdf"></i> عرض بوليصة الشحن
            </a>
            {% endif %}
            
            <!-- زر تتبع الشحن -->
            {% if order.shipping.has_tracking %}
            <a href="{{ order.shipping.tracking_link }}" 
               target="_blank" 
               class="btn btn-info btn-sm">
                <i class="fas fa-truck"></i> تتبع الشحنة
            </a>
            {% endif %}
        </div>
        
        <!-- عرض تفاصيل الشحنات -->
        {% for shipment in order.shipping.shipment_details %}
        <div class="shipment-detail">
            <h5>الشحنة {{ loop.index }}</h5>
            <p><strong>شركة الشحن:</strong> {{ shipment.courier_name }}</p>
            <p><strong>حالة الشحنة:</strong> {{ shipment.status }}</p>
            
            {% if shipment.tracking_number %}
            <p><strong>رقم التتبع:</strong> {{ shipment.tracking_number }}</p>
            {% endif %}
            
            <!-- زر بوليصة الشحن للشحنة المحددة -->
            
    {% if shipment.has_shipping_policy %}
        <a href="{{ url_for('orders.download_shipping_policy', order_id=order.id, shipment_index=loop.index0) }}" 
           class="btn btn-primary btn-sm" 
           target="_blank">
            📄 تحميل البوليصة
        </a>
    {% endif %}
    
        </div>
        
        {% endfor %}
    {% else %}
        <p class="text-muted">لا توجد معلومات شحن متاحة</p>
    {% endif %}
</div>
<style>
  /* أنماط عامة للجدول */
  .table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 10px;
  }
  
  .table tbody tr {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
  }
  
  /* أنماط الوضع الليلي للجدول */
  body.dark-mode .table tbody tr {
    background-color: #2c2f42;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  
  body.dark-mode .table {
    color: #f8f9fa;
  }
  
  body.dark-mode .table .text-muted {
    color: #adb5bd !important;
  }
  
  body.dark-mode .table .text-secondary {
    color: #a0aec0 !important;
  }
  
  body.dark-mode .table .text-dark {
    color: #f8f9fa !important;
  }
  
  body.dark-mode .table .border-bottom {
    border-bottom-color: #3a3f58 !important;
  }
  
  /* تحسينات للصور في الوضع الليلي */
  body.dark-mode .img-fluid {
    border-color: #3a3f58;
  }
  
  body.dark-mode .bg-light {
    background-color: #3a3f58 !important;
    border-color: #444;
  }
  
  /* تحسينات للقوائم في الوضع الليلي */
  body.dark-mode .list-group-flush {
    background-color: #2c2f42;
    border-color: #3a3f58;
  }
  
  body.dark-mode .list-group-item {
    background-color: #2c2f42 !important;
    border-color: #3a3f58 !important;
    color: #f8f9fa !important;
  }
  
  /* تحسينات للفورمات في الوضع الليلي */
  body.dark-mode .form-control,
  body.dark-mode .form-select {
    background-color: #3a3f58;
    border-color: #444;
    color: #f8f9fa;
  }
  
  body.dark-mode .form-control:focus,
  body.dark-mode .form-select:focus {
    background-color: #3a3f58;
    border-color: #4a4f66;
    color: #f8f9fa;
  }
  
  /* تحسينات للأزرار في الوضع الليلي */
  body.dark-mode .btn {
    transition: all 0.3s ease;
  }
  
  body.dark-mode .btn-primary {
    background-color: #3a86ff;
    border-color: #3a86ff;
    color: white;
  }
  
  body.dark-mode .btn-primary:hover {
    background-color: #2667cc;
    border-color: #2667cc;
  }
  
  body.dark-mode .btn-info {
    background-color: #00b4d8;
    border-color: #00b4d8;
    color: white;
  }
  
  body.dark-mode .btn-info:hover {
    background-color: #0096c7;
    border-color: #0096c7;
  }
  
  body.dark-mode .btn-success {
    background-color: #38b000;
    border-color: #38b000;
    color: white;
  }
  
  body.dark-mode .btn-success:hover {
    background-color: #2d8c00;
    border-color: #2d8c00;
  }
  
  body.dark-mode .btn-warning {
    background-color: #ff9e00;
    border-color: #ff9e00;
    color: #212529;
  }
  
  body.dark-mode .btn-warning:hover {
    background-color: #cc7e00;
    border-color: #cc7e00;
  }
  
  body.dark-mode .btn-danger {
    background-color: #e63946;
    border-color: #e63946;
    color: white;
  }
  
  body.dark-mode .btn-danger:hover {
    background-color: #c1121f;
    border-color: #c1121f;
  }
  
  body.dark-mode .btn-outline-secondary {
    color: #adb5bd;
    border-color: #4a4f66;
    background-color: transparent;
  }
  
  body.dark-mode .btn-outline-secondary:hover {
    background-color: #4a4f66;
    border-color: #5a5f76;
    color: #f8f9fa;
  }
  
  body.dark-mode .btn-outline-danger {
    color: #e63946;
    border-color: #e63946;
    background-color: transparent;
  }
  
  body.dark-mode .btn-outline-danger:hover {
    background-color: #e63946;
    border-color: #e63946;
    color: white;
  }
  
  body.dark-mode .btn-sm {
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
  }
  
  /* تحسينات للبطاقات (Cards) في الوضع الليلي */
  body.dark-mode .card {
    background-color: #2c2f42;
    border-color: #3a3f58;
  }
  
  body.dark-mode .card-header {
    background-color: #3a3f58 !important;
    border-bottom-color: #444 !important;
    color: #f8f9fa;
  }
  
  /* تحسينات للخريطة في الوضع الليلي */
  body.dark-mode iframe {
    filter: invert(90%) hue-rotate(180deg) brightness(85%) contrast(110%);
  }
  
  /* تحسينات للنصوص في الوضع الليلي */
  body.dark-mode .text-dark {
    color: #f8f9fa !important;
  }
  
  body.dark-mode .text-muted {
    color: #adb5bd !important;
  }
  
  /* تحسينات للتنبيهات (Alerts) في الوضع الليلي */
  body.dark-mode .alert-warning {
    background-color: #664d03;
    border-color: #846404;
    color: #ffecb5;
  }
  
  body.dark-mode .alert-info {
    background-color: #055160;
    border-color: #087990;
    color: #cff4fc;
  }
  
  /* تحسينات للشريط الجانبي الأيمن */
  body.dark-mode .col-lg-4.bg-light {
    background-color: #252836 !important;
  }
  
  /* أنماط المنتجات في الوضع الليلي */
  body.dark-mode .table tbody tr {
    background-color: #2c2f42 !important;
    border-color: #3a3f58 !important;
  }

  body.dark-mode .table tbody td {
    background-color: #2c2f42 !important;
    border-color: #3a3f58 !important;
  }

  body.dark-mode .list-group-item {
    background-color: #2c2f42 !important;
    border-color: #3a3f58 !important;
    color: #f8f9fa !important;
  }

  body.dark-mode .text-muted {
    color: #adb5bd !important;
  }

  /* تحسين صورة المنتج في الوضع الليلي */
  body.dark-mode .img-fluid {
    border: 1px solid #3a3f58;
  }

  body.dark-mode .bg-light {
    background-color: #3a3f58 !important;
  }

  /* تحسين خيارات المنتج */
  body.dark-mode .product-options {
    background-color: #3a3f58;
    border-color: #444;
  }

  body.dark-mode .product-options li {
    background-color: #2c2f42 !important;
    border-color: #3a3f58 !important;
  }

  /* تحسين الـ badges في الوضع الليلي */
  body.dark-mode .badge.bg-primary {
    background-color: #3a86ff !important;
  }
  
  body.dark-mode .badge.bg-success {
    background-color: #38b000 !important;
  }
  
  body.dark-mode .badge.bg-warning {
    background-color: #ff9e00 !important;
    color: #212529 !important;
  }
  
  body.dark-mode .badge.bg-info {
    background-color: #00b4d8 !important;
  }
  
  body.dark-mode .badge.bg-danger {
    background-color: #e63946 !important;
  }
  
  body.dark-mode .badge.bg-secondary {
    background-color: #6c757d !important;
  }

  /* تحسينات إضافية للأزرار المعطلة */
  body.dark-mode .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  /* تحسينات للزر الرئيسي في الرأس */
  body.dark-mode .bg-light .btn-primary {
    box-shadow: 0 2px 4px rgba(58, 134, 255, 0.3);
  }

  body.dark-mode .bg-light .btn-info {
    box-shadow: 0 2px 4px rgba(0, 180, 216, 0.3);
  }

  body.dark-mode .bg-light .btn-outline-secondary {
    box-shadow: 0 2px 4px rgba(74, 79, 102, 0.3);
  }
</style>
<script>
// استخدام event delegation للتعامل مع الأحداث الديناميكية
document.addEventListener('click', function(e) {
  // التعامل مع نقر زر "تم التنفيذ"
  if (e.target.closest('.update-product-status-form')) {
    e.preventDefault();
    const form = e.target.closest('.update-product-status-form');
    handleProductStatusUpdate(form);
  }
  
  // التعامل مع نقر زر "إلغاء الحالة"
  if (e.target.closest('.cancel-product-status-form')) {
    e.preventDefault();
    const form = e.target.closest('.cancel-product-status-form');
    handleProductStatusCancel(form);
  }
});



// دالة معالجة تحديث حالة المنتج
function handleProductStatusUpdate(form) {
  const container = form.closest('.product-status-container');
  const orderId = container.dataset.orderId;
  const productId = container.dataset.productId;
  const button = form.querySelector('button');
  const csrfToken = form.querySelector('input[name="csrf_token"]').value;

  if (!productId || productId === 'undefined') {
    Swal.fire({
      title: 'خطأ!',
      text: 'معرف المنتج غير صالح',
      icon: 'error',
      confirmButtonText: 'حسناً'
    });
    return;
  }

  // إظهار تحميل
  const originalText = button.innerHTML;
  button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
  button.disabled = true;

  // إرسال AJAX إلى المسار الصحيح
  fetch(`/${encodeURIComponent(orderId)}/product/${encodeURIComponent(productId)}/update_status`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken
    },
    body: JSON.stringify({ 
      status: 'تم التنفيذ', 
      notes: '' 
    })
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`خطأ في الخادم: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      // تحديث واجهة المستخدم
      button.innerHTML = '<i class="fas fa-check"></i> تم التنفيذ';
      button.disabled = true;

      // تحديث نص الحالة
      const statusElement = container.querySelector('.product-status');
      if (statusElement) {
        statusElement.textContent = 'تم التنفيذ';
        statusElement.classList.add('text-success', 'fw-bold');
      }

      // إنشاء وإضافة زر الإلغاء إذا لم يكن موجودًا
      let cancelForm = container.querySelector('.cancel-product-status-form');
      if (!cancelForm) {
        cancelForm = document.createElement('form');
        cancelForm.className = 'cancel-product-status-form d-inline';
        cancelForm.innerHTML = `
          <input type="hidden" name="csrf_token" value="${csrfToken}">
          <button type="submit" class="btn btn-sm btn-outline-danger">
            <i class="fas fa-undo"></i> إلغاء الحالة
          </button>
        `;
        // إدراج زر الإلغاء بعد زر التم التنفيذ
        form.parentNode.insertBefore(cancelForm, form.nextSibling);
      }

      Swal.fire({
        title: 'تم!',
        text: 'تم تحديث حالة المنتج بنجاح',
        icon: 'success',
        timer: 2000,
        showConfirmButton: false
      });
    } else {
      throw new Error(data.error || 'حدث خطأ غير متوقع');
    }
  })
  .catch(error => {
    button.innerHTML = originalText;
    button.disabled = false;
    Swal.fire({
      title: 'خطأ!',
      text: error.message,
      icon: 'error',
      confirmButtonText: 'حسناً'
    });
    console.error('Error:', error);
  });
}

// دالة معالجة إلغاء حالة المنتج
function handleProductStatusCancel(form) {
  const container = form.closest('.product-status-container');
  const orderId = container.dataset.orderId;
  const productId = container.dataset.productId;
  const button = form.querySelector('button');
  const csrfToken = form.querySelector('input[name="csrf_token"]').value;

  if (!productId || productId === 'undefined') {
    Swal.fire({
      title: 'خطأ!',
      text: 'معرف المنتج غير صالح',
      icon: 'error',
      confirmButtonText: 'حسناً'
    });
    return;
  }

  // إظهار تحميل
  const originalText = button.innerHTML;
  button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإلغاء...';
  button.disabled = true;

  // إرسال AJAX لإلغاء الحالة
  fetch(`/${encodeURIComponent(orderId)}/product/${encodeURIComponent(productId)}/cancel_status`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken
    }
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`خطأ في الخادم: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      // إزالة زر الإلغاء
      form.remove();

      // تمكين زر "تم التنفيذ" مرة أخرى
      const mainForm = container.querySelector('.update-product-status-form');
      const mainButton = mainForm.querySelector('button');
      mainButton.disabled = false;

      // تحديث حالة المنتج المعروضة
      const statusElement = container.querySelector('.product-status');
      if (statusElement) {
        statusElement.textContent = 'قيد التنفيذ';
        statusElement.classList.remove('text-success', 'fw-bold');
      }

      Swal.fire({
        title: 'تم!',
        text: 'تم إلغاء حالة المنتج بنجاح',
        icon: 'success',
        timer: 2000,
        showConfirmButton: false
      });
    } else {
      throw new Error(data.error || 'حدث خطأ غير متوقع');
    }
  })
  .catch(error => {
    button.innerHTML = originalText;
    button.disabled = false;
    Swal.fire({
      title: 'خطأ!',
      text: error.message,
      icon: 'error',
      confirmButtonText: 'حسناً'
    });
    console.error('Error:', error);
  });
}

// تحويل نماذج الحالات المخصصة إلى AJAX
document.addEventListener('DOMContentLoaded', function() {
  // إضافة معالج للنماذج التي تستخدم AJAX
  const ajaxForms = document.querySelectorAll('.ajax-form');
  
  ajaxForms.forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const submitButton = this.querySelector('button[type="submit"]');
      const originalText = submitButton.innerHTML;
      
      // إظهار تحميل
      submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
      submitButton.disabled = true;
      
      // إرسال البيانات عبر AJAX
      fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // إعادة تعيين النموذج
          this.reset();
          
          // تحديث القائمة المناسبة حسب نوع النموذج
          if (this.id === 'employee-status-form') {
            updateEmployeeStatusList(data.new_status);
          } else if (this.id === 'special-status-form') {
            updateSpecialStatusList(data.new_status);
          }
          
          Swal.fire({
            title: 'تم!',
            text: data.message,
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
          });
        } else {
          throw new Error(data.error || 'حدث خطأ غير متوقع');
        }
      })
      .catch(error => {
        Swal.fire({
          title: 'خطأ!',
          text: error.message,
          icon: 'error',
          confirmButtonText: 'حسناً'
        });
      })
      .finally(() => {
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
      });
    });
  });
  
  // دالة لتحديث قائمة حالات الموظف
// ... (الكود السابق يبقى كما هو)

// دالة لتحديث قائمة حالات الموظف
function updateEmployeeStatusList(newStatus) {
    const statusList = document.querySelector('.employee-status-list');
    
    if (newStatus && statusList) {
        // إنشاء عنصر جديد
        const newItem = document.createElement('li');
        newItem.className = 'list-group-item d-flex justify-content-between py-1 px-0';
        newItem.innerHTML = `
        <div>
            <span class="badge" style="background-color: ${newStatus.color}; color: white;">
                ${newStatus.name}
            </span>
            ${newStatus.note ? `<span class="ms-2">${newStatus.note}</span>` : ''}
            <div class="text-muted small mt-1">
                <i class="fas fa-user me-1"></i>${newStatus.employee_email}
            </div>
        </div>
        <div class="text-muted">${newStatus.created_at}</div>
        `;
        
        // التحقق من وجود عناصر وإزالة الرسالة إذا كانت موجودة
        if (statusList.children.length > 0) {
            const firstChild = statusList.children[0];
            // التحقق إذا كان العنصر الأول هو رسالة "لا توجد حالات مسجلة"
            if (firstChild.classList && 
                (firstChild.classList.contains('text-center') || 
                 firstChild.textContent.includes('لا توجد حالات مسجلة'))) {
                statusList.removeChild(firstChild);
            }
        }
        
        // إضافة العنصر الجديد في بداية القائمة
        statusList.insertBefore(newItem, statusList.firstChild);
    }
}

// دالة لتحديث قائمة الحالات الخاصة
function updateSpecialStatusList(newStatus) {
    const statusList = document.querySelector('.special-status-list');
    
    if (newStatus && statusList) {
        // إنشاء عنصر جديد
        const newItem = document.createElement('div');
        newItem.className = 'list-group-item py-2 px-0';
        newItem.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <span class="badge" style="background-color: ${newStatus.color}; color: white;">
                    ${newStatus.name}
                </span>
                ${newStatus.note ? `<p class="mb-0 mt-1 small">${newStatus.note}</p>` : ''}
            </div>
            <div class="text-muted small text-end">
                <div>${newStatus.created_at}</div>
            </div>
        </div>
        `;
        
        // التحقق من وجود عناصر وإزالة الرسالة إذا كانت موجودة
        if (statusList.children.length > 0) {
            const firstChild = statusList.children[0];
            // التحقق إذا كان العنصر الأول هو رسالة "لا توجد حالات مسجلة"
            if (firstChild.classList && 
                (firstChild.classList.contains('text-center') || 
                 firstChild.textContent.includes('لا توجد حالات مسجلة'))) {
                statusList.removeChild(firstChild);
            }
        }
        
        // إضافة العنصر الجديد في بداية القائمة
        statusList.insertBefore(newItem, statusList.firstChild);
    }
}


  // إضافة تحميل متأخر للصور
  const lazyImages = document.querySelectorAll('img[loading="lazy"]');
  
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        img.src = img.dataset.src || img.src;
        observer.unobserve(img);
      }
    });
  });

  lazyImages.forEach(img => {
    observer.observe(img);
  });
});

// عرض رسائل التأكيد عند تغيير الحالة بنجاح
{% if request.args.get('status_updated') %}
Swal.fire({
  title: 'تم التحديث!',
  text: 'تم تحديث حالة الطلب بنجاح',
  icon: 'success',
  confirmButtonText: 'حسناً',
  timer: 3000
});
{% endif %}

{% if request.args.get('employee_status_added') %}
Swal.fire({
  title: 'تمت الإضافة!',
  text: 'تمت إضافة الحالة المخصصة بنجاح',
  icon: 'success',
  confirmButtonText: 'حسناً',
  timer: 3000
});
{% endif %}

{% if request.args.get('special_status_added') %}
Swal.fire({
  title: 'تم الحفظ!',
  text: 'تم حفظ الحالة الخاصة بنجاح',
  icon: 'success',
  confirmButtonText: 'حسناً',
  timer: 3000
});
{% endif %}
// معالجة أخطاء تحميل الصور
document.addEventListener('DOMContentLoaded', function() {
  const images = document.querySelectorAll('.uploaded-images img');
  images.forEach(img => {
    img.addEventListener('error', function() {
      this.style.display = 'none';
      // إنشاء عنصر بديل عند فشل تحميل الصورة
      const placeholder = document.createElement('div');
      placeholder.className = 'bg-light d-flex align-items-center justify-content-center rounded';
      placeholder.style.width = '60px';
      placeholder.style.height = '60px';
      placeholder.innerHTML = '<i class="fas fa-image text-muted"></i>';
      this.parentNode.insertBefore(placeholder, this);
    });
  });
});
</script>
{% endblock %}